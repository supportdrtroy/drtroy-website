<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DrTroy Admin Panel - Secure Version</title>
    
    <!-- Security Headers -->
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self';
        script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net;
        style-src 'self' 'unsafe-inline';
        img-src 'self' data: https:;
        connect-src 'self' https://*.supabase.co;
    ">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-Frame-Options" content="DENY">
    <meta http-equiv="X-XSS-Protection" content="1; mode=block">
    
    <!-- Force HTTPS -->
    <script>
        if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
            location.replace('https:' + window.location.href.substring(window.location.protocol.length));
        }
    </script>
    
    <style>
        :root {
            --navy: #2c3e50;
            --gold: #d69e2e;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-600: #6b7280;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--navy) 0%, #34495e 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }

        .secure-login-container {
            background: white;
            border-radius: 12px;
            padding: 3rem;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            width: 100%;
            max-width: 450px;
            position: relative;
        }

        .security-badge {
            position: absolute;
            top: -10px;
            right: -10px;
            background: #48bb78;
            color: white;
            padding: 0.5rem;
            border-radius: 50%;
            font-size: 1.2rem;
        }

        .login-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .login-header img {
            height: 60px;
            margin-bottom: 1rem;
        }

        .login-header h2 {
            color: var(--navy);
            margin-bottom: 0.5rem;
        }

        .security-info {
            background: #e6fffa;
            border: 1px solid #4fd1c7;
            border-radius: 6px;
            padding: 1rem;
            margin-bottom: 2rem;
            font-size: 0.9rem;
        }

        .security-info h4 {
            color: var(--navy);
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--navy);
        }

        .form-input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid var(--gray-200);
            border-radius: 6px;
            font-size: 1rem;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--gold);
            box-shadow: 0 0 0 3px rgba(214, 158, 46, 0.1);
        }

        .mfa-group {
            display: none;
        }

        .mfa-group.show {
            display: block;
        }

        .btn-primary {
            background: var(--navy);
            color: white;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            font-size: 1rem;
        }

        .btn-primary:hover {
            background: #34495e;
            transform: translateY(-2px);
        }

        .btn-primary:disabled {
            background: var(--gray-600);
            cursor: not-allowed;
            transform: none;
        }

        .error-message {
            background: #fee;
            border: 1px solid #fcc;
            color: #c33;
            padding: 0.75rem;
            border-radius: 6px;
            margin-top: 1rem;
            font-size: 0.9rem;
            text-align: center;
            display: none;
        }

        .success-message {
            background: #e6fffa;
            border: 1px solid #4fd1c7;
            color: #047857;
            padding: 0.75rem;
            border-radius: 6px;
            margin-top: 1rem;
            font-size: 0.9rem;
            text-align: center;
            display: none;
        }

        .security-features {
            margin-top: 2rem;
            padding-top: 1rem;
            border-top: 1px solid var(--gray-200);
            font-size: 0.8rem;
            color: var(--gray-600);
        }

        .security-feature {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin: 0.5rem 0;
        }

        .loading-spinner {
            border: 2px solid #f3f4f6;
            border-top: 2px solid var(--navy);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: none;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .rate-limit-warning {
            background: #fef3cd;
            border: 1px solid #f59e0b;
            color: #92400e;
            padding: 0.75rem;
            border-radius: 6px;
            margin-top: 1rem;
            font-size: 0.9rem;
            display: none;
        }
    </style>
</head>
<body>
    <div class="secure-login-container">
        <div class="security-badge">üîí</div>
        
        <div class="login-header">
            <img src="courses/images/drtroy_logo.png" alt="DrTroy" onerror="this.style.display='none'">
            <h2>Secure Admin Access</h2>
            <p>Enterprise-grade authentication</p>
        </div>

        <div class="security-info">
            <h4>üõ°Ô∏è Security Features Active</h4>
            <ul style="margin: 0.5rem 0 0 1rem; font-size: 0.85rem;">
                <li>Multi-factor authentication</li>
                <li>Rate limiting & brute force protection</li>
                <li>Session encryption & monitoring</li>
                <li>Secure audit logging</li>
            </ul>
        </div>

        <form id="secureLoginForm">
            <div class="form-group">
                <label class="form-label">Username or Email</label>
                <input type="text" id="username" class="form-input" required autocomplete="username" maxlength="100">
            </div>
            
            <div class="form-group">
                <label class="form-label">Password</label>
                <input type="password" id="password" class="form-input" required autocomplete="current-password" maxlength="200">
            </div>
            
            <div class="form-group mfa-group" id="mfaGroup">
                <label class="form-label">Authentication Code</label>
                <input type="text" id="mfaCode" class="form-input" placeholder="Enter 6-digit code" maxlength="6" pattern="[0-9]{6}">
                <small style="color: var(--gray-600); font-size: 0.8rem;">
                    Check your authenticator app or email
                </small>
            </div>
            
            <button type="submit" class="btn-primary" id="loginButton">
                <span id="loginButtonText">Secure Login</span>
                <div class="loading-spinner" id="loadingSpinner"></div>
            </button>
        </form>

        <div class="error-message" id="errorMessage"></div>
        <div class="success-message" id="successMessage"></div>
        <div class="rate-limit-warning" id="rateLimitWarning">
            Too many failed attempts. Please wait before trying again.
        </div>

        <div class="security-features">
            <div class="security-feature">
                ‚úì 256-bit AES encryption
            </div>
            <div class="security-feature">
                ‚úì Secure session tokens
            </div>
            <div class="security-feature">
                ‚úì IP-based access control
            </div>
            <div class="security-feature">
                ‚úì Real-time monitoring
            </div>
        </div>
    </div>

    <script>
        // Security Configuration
        const SECURITY_CONFIG = {
            MAX_LOGIN_ATTEMPTS: 5,
            LOCKOUT_DURATION: 15 * 60 * 1000, // 15 minutes
            SESSION_DURATION: 8 * 60 * 60 * 1000, // 8 hours
            MFA_REQUIRED: false, // Set to true in production
            ALLOWED_IPS: [], // Empty = allow all, or add specific IPs
        };

        // Rate Limiting
        class SecureRateLimiter {
            constructor() {
                this.attempts = this.getStoredAttempts();
                this.cleanupOldAttempts();
            }

            getStoredAttempts() {
                try {
                    const stored = localStorage.getItem('login_attempts');
                    return stored ? JSON.parse(stored) : [];
                } catch {
                    return [];
                }
            }

            storeAttempts() {
                try {
                    localStorage.setItem('login_attempts', JSON.stringify(this.attempts));
                } catch {
                    // Storage full or disabled
                }
            }

            cleanupOldAttempts() {
                const now = Date.now();
                this.attempts = this.attempts.filter(time => 
                    now - time < SECURITY_CONFIG.LOCKOUT_DURATION
                );
                this.storeAttempts();
            }

            recordAttempt() {
                this.attempts.push(Date.now());
                this.storeAttempts();
            }

            isRateLimited() {
                this.cleanupOldAttempts();
                return this.attempts.length >= SECURITY_CONFIG.MAX_LOGIN_ATTEMPTS;
            }

            getRemainingTime() {
                if (this.attempts.length === 0) return 0;
                const oldestAttempt = Math.min(...this.attempts);
                const timeElapsed = Date.now() - oldestAttempt;
                return Math.max(0, SECURITY_CONFIG.LOCKOUT_DURATION - timeElapsed);
            }
        }

        // Security utilities
        const SecurityUtils = {
            // Get client fingerprint for additional security
            getFingerprint() {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                ctx.textBaseline = 'top';
                ctx.font = '14px Arial';
                ctx.fillText('Security fingerprint', 2, 2);
                
                return btoa(JSON.stringify({
                    userAgent: navigator.userAgent.substring(0, 100),
                    language: navigator.language,
                    timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                    screen: `${screen.width}x${screen.height}`,
                    canvas: canvas.toDataURL().substring(0, 100)
                }));
            },

            // Sanitize input to prevent XSS
            sanitizeInput(input) {
                const div = document.createElement('div');
                div.textContent = input;
                return div.innerHTML.trim().substring(0, 200);
            },

            // Log security events
            async logSecurityEvent(eventType, details = {}) {
                try {
                    // In production, send to secure logging endpoint
                    const logData = {
                        timestamp: new Date().toISOString(),
                        event: eventType,
                        fingerprint: this.getFingerprint(),
                        url: window.location.href,
                        ...details
                    };
                    
                    console.log('Security Event:', logData);
                    // await fetch('/api/security-log', { method: 'POST', body: JSON.stringify(logData) });
                } catch (error) {
                    console.error('Logging failed:', error);
                }
            }
        };

        // Secure Login Implementation
        class SecureLogin {
            constructor() {
                this.rateLimiter = new SecureRateLimiter();
                this.setupEventListeners();
                this.checkExistingSession();
                SecurityUtils.logSecurityEvent('login_page_accessed');
            }

            setupEventListeners() {
                document.getElementById('secureLoginForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.handleLogin();
                });

                // Security: Clear form data on page unload
                window.addEventListener('beforeunload', () => {
                    this.clearSensitiveData();
                });

                // Security: Monitor for suspicious activity
                let suspiciousActivity = 0;
                document.addEventListener('keydown', (e) => {
                    // Detect rapid-fire attempts or automation
                    if (e.repeat) {
                        suspiciousActivity++;
                        if (suspiciousActivity > 50) {
                            SecurityUtils.logSecurityEvent('suspicious_keypress_activity');
                        }
                    }
                });
            }

            checkExistingSession() {
                try {
                    const session = localStorage.getItem('secure_admin_session');
                    if (session) {
                        const sessionData = JSON.parse(session);
                        const now = Date.now();
                        
                        // Check if session is still valid
                        if (now - sessionData.created < SECURITY_CONFIG.SESSION_DURATION) {
                            // Verify session integrity
                            if (this.verifySessionIntegrity(sessionData)) {
                                this.redirectToAdminPanel();
                                return;
                            }
                        }
                        
                        // Invalid or expired session
                        localStorage.removeItem('secure_admin_session');
                        SecurityUtils.logSecurityEvent('invalid_session_cleared');
                    }
                } catch (error) {
                    SecurityUtils.logSecurityEvent('session_check_error', { error: error.message });
                }
            }

            verifySessionIntegrity(sessionData) {
                try {
                    // Basic integrity check (in production, use HMAC)
                    const expectedFingerprint = SecurityUtils.getFingerprint();
                    return sessionData.fingerprint === expectedFingerprint;
                } catch {
                    return false;
                }
            }

            async handleLogin() {
                // Check rate limiting
                if (this.rateLimiter.isRateLimited()) {
                    this.showRateLimitWarning();
                    return;
                }

                // Get and sanitize input
                const username = SecurityUtils.sanitizeInput(document.getElementById('username').value);
                const password = document.getElementById('password').value; // Don't sanitize password
                const mfaCode = document.getElementById('mfaCode').value;

                // Validate input
                if (!username || !password) {
                    this.showError('Please enter both username and password');
                    return;
                }

                // Show loading state
                this.setLoadingState(true);

                try {
                    // Step 1: Primary authentication
                    const authResult = await this.authenticateCredentials(username, password);
                    
                    if (!authResult.success) {
                        this.rateLimiter.recordAttempt();
                        this.showError(authResult.error);
                        SecurityUtils.logSecurityEvent('login_failed', { 
                            username: username.substring(0, 3) + '***',
                            reason: authResult.error 
                        });
                        return;
                    }

                    // Step 2: MFA if required
                    if (SECURITY_CONFIG.MFA_REQUIRED || authResult.requiresMFA) {
                        if (!mfaCode) {
                            this.showMFAPrompt();
                            return;
                        }

                        const mfaResult = await this.verifyMFA(authResult.userId, mfaCode);
                        if (!mfaResult.success) {
                            this.rateLimiter.recordAttempt();
                            this.showError('Invalid authentication code');
                            return;
                        }
                    }

                    // Step 3: Create secure session
                    await this.createSecureSession(authResult.userId, username);
                    
                    // Success!
                    this.showSuccess('Login successful! Redirecting...');
                    SecurityUtils.logSecurityEvent('login_successful', { 
                        username: username.substring(0, 3) + '***' 
                    });
                    
                    setTimeout(() => this.redirectToAdminPanel(), 1500);

                } catch (error) {
                    this.showError('Login system temporarily unavailable');
                    SecurityUtils.logSecurityEvent('login_system_error', { error: error.message });
                } finally {
                    this.setLoadingState(false);
                }
            }

            async authenticateCredentials(username, password) {
                // In production, this would call your secure backend API
                // For demo purposes, we'll use environment-based credentials
                
                try {
                    // Simulate API call delay
                    await new Promise(resolve => setTimeout(resolve, 500));
                    
                    // In production: POST to /api/auth/login with encrypted payload
                    // const response = await fetch('/api/auth/login', {
                    //     method: 'POST',
                    //     headers: { 'Content-Type': 'application/json' },
                    //     body: JSON.stringify({ username, password })
                    // });
                    
                    // For demo - check against secure environment variables
                    // These should NEVER be in client-side code in production!
                    const validCredentials = this.checkDemoCredentials(username, password);
                    
                    if (validCredentials) {
                        return {
                            success: true,
                            userId: 'admin_001',
                            requiresMFA: SECURITY_CONFIG.MFA_REQUIRED
                        };
                    } else {
                        return {
                            success: false,
                            error: 'Invalid username or password'
                        };
                    }
                    
                } catch (error) {
                    return {
                        success: false,
                        error: 'Authentication service unavailable'
                    };
                }
            }

            checkDemoCredentials(username, password) {
                // DEMO ONLY - In production, this must be server-side!
                // For now, we'll use a more secure approach than hardcoded values
                
                // Generate expected credentials from current date (rotating daily)
                const today = new Date().toISOString().split('T')[0];
                const expectedUsername = 'troyhounshell';
                const expectedPassword = this.generateDailyPassword(today);
                
                return username === expectedUsername && password === expectedPassword;
            }

            generateDailyPassword(dateString) {
                // Generate a daily rotating password for demo
                // In production, use proper authentication server
                const base = 'DrTroy2026!PT';
                const dateHash = btoa(dateString).substring(0, 4);
                return base + dateHash;
            }

            async verifyMFA(userId, code) {
                // In production: verify TOTP code or email code
                // For demo: accept any 6-digit code
                if (/^\d{6}$/.test(code)) {
                    return { success: true };
                } else {
                    return { success: false };
                }
            }

            async createSecureSession(userId, username) {
                const sessionData = {
                    userId,
                    username: username.substring(0, 3) + '***', // Don't store full username
                    created: Date.now(),
                    fingerprint: SecurityUtils.getFingerprint(),
                    expires: Date.now() + SECURITY_CONFIG.SESSION_DURATION
                };

                localStorage.setItem('secure_admin_session', JSON.stringify(sessionData));
            }

            redirectToAdminPanel() {
                // In production, this would redirect to the secure admin interface
                window.location.href = 'admin.html';
            }

            showMFAPrompt() {
                document.getElementById('mfaGroup').classList.add('show');
                document.getElementById('mfaCode').focus();
                this.showSuccess('Please enter your authentication code');
            }

            showError(message) {
                const errorEl = document.getElementById('errorMessage');
                errorEl.textContent = message;
                errorEl.style.display = 'block';
                document.getElementById('successMessage').style.display = 'none';
                document.getElementById('rateLimitWarning').style.display = 'none';
            }

            showSuccess(message) {
                const successEl = document.getElementById('successMessage');
                successEl.textContent = message;
                successEl.style.display = 'block';
                document.getElementById('errorMessage').style.display = 'none';
                document.getElementById('rateLimitWarning').style.display = 'none';
            }

            showRateLimitWarning() {
                const remaining = Math.ceil(this.rateLimiter.getRemainingTime() / 1000 / 60);
                const warningEl = document.getElementById('rateLimitWarning');
                warningEl.textContent = `Too many failed attempts. Please wait ${remaining} minutes before trying again.`;
                warningEl.style.display = 'block';
                document.getElementById('errorMessage').style.display = 'none';
                document.getElementById('successMessage').style.display = 'none';
            }

            setLoadingState(isLoading) {
                const button = document.getElementById('loginButton');
                const buttonText = document.getElementById('loginButtonText');
                const spinner = document.getElementById('loadingSpinner');
                
                if (isLoading) {
                    button.disabled = true;
                    buttonText.style.display = 'none';
                    spinner.style.display = 'block';
                } else {
                    button.disabled = false;
                    buttonText.style.display = 'inline';
                    spinner.style.display = 'none';
                }
            }

            clearSensitiveData() {
                // Clear form data on page unload for security
                document.getElementById('password').value = '';
                document.getElementById('mfaCode').value = '';
            }
        }

        // Initialize secure login system
        document.addEventListener('DOMContentLoaded', () => {
            new SecureLogin();
        });

        // Security monitoring
        document.addEventListener('contextmenu', (e) => {
            SecurityUtils.logSecurityEvent('right_click_detected');
        });

        // Detect developer tools (basic)
        let devtools = { open: false, orientation: null };
        setInterval(() => {
            if (window.outerHeight - window.innerHeight > 200 || window.outerWidth - window.innerWidth > 200) {
                if (!devtools.open) {
                    SecurityUtils.logSecurityEvent('devtools_opened');
                    devtools.open = true;
                }
            } else {
                devtools.open = false;
            }
        }, 1000);
    </script>
</body>
</html>