<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Account | DrTroy.com</title>
    
    <!-- Supabase JS v2 CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <!-- DrTroy Supabase client -->
    <script src="js/supabase-client.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --navy: #1a365d;
            --navy-light: #2c5282;
            --gold: #059669;
            --gold-light: #10b981;
            --gray-50: #f7fafc;
            --gray-100: #edf2f7;
            --gray-200: #e5e7eb;
            --gray-600: #4a5568;
            --gray-800: #2d3748;
            --gray-900: #111827;
            --success: #059669;
            --danger: #dc2626;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--gray-50);
            color: var(--gray-800);
            line-height: 1.6;
        }

        /* Header */
        .header {
            background: #ffffff;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-container {
            max-width: 1280px;
            margin: 0 auto;
            padding: 1.5rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo img {
            mix-blend-mode: multiply;
            height: 72px;
            width: auto;
        }

        nav {
            display: flex;
            align-items: center;
            gap: 2.5rem;
        }

        nav a {
            color: var(--gray-600);
            text-decoration: none;
            font-weight: 500;
            font-size: 0.95rem;
            transition: color 0.25s;
        }

        nav a:hover {
            color: var(--navy);
        }

        .login-link {
            background: var(--gold) !important;
            color: var(--navy) !important;
            padding: 0.5rem 1rem !important;
            border-radius: 6px !important;
            font-weight: 600 !important;
            transition: all 0.3s ease !important;
            white-space: nowrap !important;
            font-size: 0.9rem !important;
        }

        .login-link:hover {
            background: var(--gold-light) !important;
            color: var(--navy) !important;
            transform: translateY(-2px) !important;
        }

        /* Main Content */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .page-header {
            text-align: center;
            margin-bottom: 3rem;
        }

        .page-header h1 {
            font-size: 2.5rem;
            color: var(--navy);
            margin-bottom: 0.5rem;
        }

        .page-header p {
            color: var(--gray-600);
            font-size: 1.1rem;
        }

        /* Login Required */
        .login-required {
            background: white;
            border: 2px solid var(--gold);
            border-radius: 12px;
            padding: 3rem;
            text-align: center;
            max-width: 600px;
            margin: 2rem auto;
        }

        .login-required h2 {
            color: var(--navy);
            margin-bottom: 1rem;
        }

        .login-required p {
            color: var(--gray-600);
            margin-bottom: 2rem;
            font-size: 1.1rem;
        }

        /* Account Layout */
        .account-layout {
            display: grid;
            grid-template-columns: 250px 1fr;
            gap: 2rem;
            margin-top: 2rem;
        }

        /* Sidebar */
        .sidebar {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            height: fit-content;
            position: sticky;
            top: 120px;
        }

        .sidebar h3 {
            color: var(--navy);
            margin-bottom: 1rem;
            font-size: 1.1rem;
        }

        .sidebar ul {
            list-style: none;
        }

        .sidebar li {
            margin-bottom: 0.5rem;
        }

        .sidebar a {
            display: block;
            padding: 0.75rem 1rem;
            color: var(--gray-600);
            text-decoration: none;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .sidebar a:hover {
            background: var(--gray-50);
            color: var(--navy);
        }

        .sidebar a.active {
            background: var(--navy);
            color: white;
        }

        /* Main Content */
        .main-content {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .content-section {
            display: none;
            padding: 2rem;
        }

        .content-section.active {
            display: block;
        }

        .content-section h2 {
            color: var(--navy);
            margin-bottom: 0.5rem;
            font-size: 1.5rem;
        }

        .content-section p {
            color: var(--gray-600);
            margin-bottom: 2rem;
        }

        /* Forms */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 600;
            color: var(--gray-900);
            margin-bottom: 0.5rem;
        }

        .form-input, .form-select {
            padding: 0.75rem;
            border: 1px solid var(--gray-200);
            border-radius: 6px;
            font-size: 1rem;
            transition: border-color 0.2s;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--navy);
            box-shadow: 0 0 0 3px rgba(26, 54, 93, 0.1);
        }

        .form-input[readonly] {
            background: var(--gray-50);
            color: var(--gray-600);
        }

        /* Buttons */
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: var(--navy);
            color: white;
        }

        .btn-primary:hover {
            background: #1e40af;
        }

        .btn-secondary {
            background: var(--gray-200);
            color: var(--gray-800);
        }

        .btn-secondary:hover {
            background: var(--gray-300);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        /* CCU Dashboard */
        .ccu-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
            align-items: stretch;
        }

        .ccu-card {
            background: var(--gray-50);
            border: 1px solid var(--gray-200);
            border-radius: 8px;
            padding: 1.5rem;
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-height: 120px;
        }

        .ccu-card h4 {
            color: var(--gray-600);
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            flex-shrink: 0;
        }

        /* Ensure buttons in CCU cards don't interfere with alignment */
        .ccu-card .btn {
            margin-top: 0.5rem;
            font-size: 0.7rem;
            padding: 0.25rem 0.5rem;
            flex-shrink: 0;
        }

        .ccu-card .value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--navy);
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 2.5rem;
            line-height: 1;
            text-align: center;
        }

        /* Progress Bar */
        .progress-container {
            margin: 1.5rem 0;
        }

        .progress-bar {
            background: var(--gray-200);
            border-radius: 10px;
            height: 20px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--success);
            transition: width 0.3s;
        }

        .progress-text {
            text-align: center;
            margin-top: 0.5rem;
            color: var(--gray-600);
            font-size: 0.9rem;
        }

        /* Alerts */
        .alert {
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
        }

        .alert-success {
            background: #dcfce7;
            border: 1px solid var(--success);
            color: #065f46;
        }

        .alert-info {
            background: #dbeafe;
            border: 1px solid #3b82f6;
            color: #1e40af;
        }

        .alert-warning {
            background: #fef3c7;
            border: 1px solid #d97706;
            color: #92400e;
        }

        .alert-danger {
            background: #fef2f2;
            border: 1px solid var(--danger);
            color: #991b1b;
        }

        /* Course Cards */
        .courses-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-top: 1.5rem;
        }

        .course-card {
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: 8px;
            padding: 1.5rem;
            transition: box-shadow 0.2s ease;
            display: flex;
            flex-direction: column;
        }

        .course-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .course-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .course-header h3 {
            color: var(--navy);
            margin: 0;
            font-size: 1.1rem;
            line-height: 1.3;
            flex: 1;
            margin-right: 1rem;
        }

        .course-description {
            color: var(--gray-600);
            margin-bottom: 1rem;
            font-size: 0.9rem;
        }

        .course-details {
            margin-bottom: 1.5rem;
        }

        .course-credits {
            font-weight: 600;
            color: var(--gold);
            margin-bottom: 0.5rem;
        }

        .course-format {
            font-size: 0.9rem;
            color: var(--gray-700);
            margin-bottom: 0.5rem;
            font-style: italic;
        }

        .course-instructor {
            font-size: 0.85rem;
            color: var(--gray-600);
            margin-bottom: 0.5rem;
        }

        .course-approval {
            font-size: 0.8rem;
            color: var(--gray-600);
            font-family: monospace;
            background: var(--gray-100);
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            display: inline-block;
        }

        .course-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-top: auto;
        }

        .btn-outline {
            background: transparent;
            color: var(--navy);
            border: 1px solid var(--navy);
        }

        .btn-outline:hover {
            background: var(--navy);
            color: white;
        }

        /* Super User Specific Styles */
        #superuser-status-badge {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
        }

        .superuser-nav {
            background: linear-gradient(135deg, #7c3aed, #a855f7) !important;
            color: white;
        }

        .superuser-nav:hover {
            background: linear-gradient(135deg, #6d28d9, #9333ea) !important;
        }

        /* CCU Management Styles */
        /* ccu-overview styling is defined above - no override needed */

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .checkbox-group input[type="checkbox"] {
            transform: scale(1.1);
        }

        .checkbox-group label {
            font-size: 0.9rem;
            color: var(--gray-700);
            cursor: pointer;
        }

        #ethicsSection .checkbox-group label {
            font-weight: 500;
        }

        /* External CCU entries */
        .external-ccu-entry {
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: 4px;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .external-ccu-entry:hover {
            border-color: var(--navy);
        }

        /* Status Badges */
        .status-badge {
            font-size: 0.75rem;
            font-weight: 600;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            white-space: nowrap;
        }

        .status-badge.available {
            background: #dbeafe;
            color: #1e40af;
        }

        .status-badge.in-progress {
            background: #fef3c7;
            color: var(--gold);
        }

        .status-badge.completed {
            background: #dcfce7;
            color: var(--gold);
        }

        .status-badge.coming-soon {
            background: #f3f4f6;
            color: #6b7280;
        }

        @media (max-width: 768px) {
            .courses-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .course-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .course-header h3 {
                margin-right: 0;
                margin-bottom: 0.5rem;
            }
        }

        /* Checkbox */
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin: 1rem 0;
        }

        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
        }

        /* Emergency Access styles removed per user request */

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .header-container {
                padding: 1rem;
            }
            
            .logo img {
                mix-blend-mode: multiply;
                height: 60px;
                max-width: 100%;
            }

            .account-layout {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .sidebar {
                position: static;
                order: 2;
            }
            
            .main-content {
                order: 1;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .ccu-overview {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .container {
                padding: 1rem;
            }
        }

        @media (max-width: 480px) {
            .logo img {
            mix-blend-mode: multiply;
                height: 100px;
            }
            
            nav {
                grid-template-columns: 1fr;
                gap: 0.3rem;
            }
            
            nav a {
                font-size: 0.85rem;
                padding: 0.6rem;
            }
            
            .ccu-card h3 {
                font-size: 0.9rem;
            }
            
            .ccu-card .number {
                font-size: 1.5rem;
            }
        }

        /* Hamburger menu */
        .hamburger {
            display: none;
            flex-direction: column;
            gap: 5px;
            background: none;
            border: none;
            cursor: pointer;
            padding: 0.25rem;
        }
        .hamburger span {
            display: block;
            width: 24px;
            height: 2px;
            background: var(--navy);
            border-radius: 2px;
            transition: all 0.3s;
        }
        @media (max-width: 768px) {
            .hamburger { display: flex; }
            .nav-links {
                display: none;
                position: absolute;
                top: 100%;
                left: 0;
                right: 0;
                background: white;
                flex-direction: column;
                padding: 1rem 2rem;
                box-shadow: 0 4px 20px rgba(0,0,0,0.1);
                z-index: 100;
                border-top: 1px solid #e5e7eb;
            }
            .nav-links.active { display: flex; }
            .nav-links a { padding: 0.75rem 0; border-bottom: 1px solid #f3f4f6; }
            .header-container, header > div { position: relative; }
        }

        /* Author Management Styles */
        .author-section {
            margin-top: 1rem;
        }
        
        .author-section table {
            font-size: 0.9rem;
        }
        
        .author-section th {
            background: #f8fafc;
            font-weight: 600;
            padding: 0.75rem;
            text-align: left;
            border-bottom: 2px solid #e2e8f0;
        }
        
        .author-section td {
            padding: 0.75rem;
            border-bottom: 1px solid #f1f5f9;
        }
        
        @media (max-width: 768px) {
            .author-section table {
                font-size: 0.8rem;
            }
            
            .author-section th,
            .author-section td {
                padding: 0.5rem;
            }
            
            .author-section .btn {
                font-size: 0.7rem;
                padding: 0.2rem 0.4rem;
            }
        }
    </style>
    <!-- Open Graph / Social Preview -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://drtroy.com/my-account.html">
    <meta property="og:title" content="My Account ‚Äî DrTroy CE">
    <meta property="og:description" content="Manage your DrTroy CE account, view your enrolled courses, certificates, and referral credits.">
    <meta property="og:image" content="https://drtroy.com/courses/images/og-preview.jpg">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:site_name" content="DrTroy Continuing Education">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="My Account ‚Äî DrTroy CE">
    <meta name="twitter:description" content="Manage your DrTroy CE account, view your enrolled courses, certificates, and referral credits.">
    <meta name="twitter:image" content="https://drtroy.com/courses/images/og-preview.jpg">
    <script src="js/security.js"></script>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-container">
            <div class="logo">
                <a href="home-preview.html">
                    <img src="courses/images/drtroy_logo_new.jpg" alt="DrTroy Continuing Education">
                </a>
            </div>
            <button class="hamburger" aria-label="Open menu">
                <span></span><span></span><span></span>
            </button>
            <nav class="nav-links">
                <a href="home-preview.html">Home</a>
                <a href="home-preview.html#packages">Packages</a>
                <a href="courses.html">Course Catalog</a>
                <a href="home-preview.html#about">About</a>
                <a href="home-preview.html#contact">Contact</a>
                <a href="my-account.html" class="login-link" id="accountLink">Log In</a>
            </nav>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container">
        <!-- Login Form -->
        <div id="loginRequired" class="login-required" style="display: none;">
            <div style="max-width: 420px; margin: 3rem auto; background: white; border-radius: 12px; padding: 2.5rem; box-shadow: 0 4px 24px rgba(0,0,0,0.08);">
                <h2 style="font-family: 'Playfair Display', serif; font-size: 1.75rem; margin-bottom: 0.5rem; color: #1a365d;">Welcome Back</h2>
                <p style="color: #737373; margin-bottom: 2rem; font-size: 0.95rem;">Sign in to access your courses and certificates.</p>

                <div id="loginError" style="display:none; background:#fef2f2; border:1px solid #fca5a5; color:#dc2626; padding:0.75rem 1rem; border-radius:8px; margin-bottom:1.25rem; font-size:0.9rem;"></div>

                <!-- Login Form Panel -->
                <div id="loginPanel">
                    <form method="POST" id="supabaseLoginForm" onsubmit="handleSupabaseLogin(event)">
                        <div style="margin-bottom: 1.25rem;">
                            <label style="display:block; font-weight:600; font-size:0.9rem; margin-bottom:0.4rem; color:#262626;">Email Address</label>
                            <input type="email" id="loginEmail" required placeholder="you@example.com"
                                style="width:100%; padding:0.75rem 1rem; border:1px solid #e5e5e5; border-radius:8px; font-size:1rem; box-sizing:border-box; outline:none;">
                        </div>
                        <div style="margin-bottom: 0.5rem;">
                            <label style="display:block; font-weight:600; font-size:0.9rem; margin-bottom:0.4rem; color:#262626;">Password</label>
                            <input type="password" id="loginPassword" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                                style="width:100%; padding:0.75rem 1rem; border:1px solid #e5e5e5; border-radius:8px; font-size:1rem; box-sizing:border-box; outline:none;">
                        </div>
                        <div style="text-align:right; margin-bottom:1.5rem;">
                            <a href="#" onclick="showForgotPassword(event)" style="font-size:0.875rem; color:#059669; font-weight:600; text-decoration:none;">Forgot password?</a>
                        </div>
                        <button type="submit" id="loginSubmitBtn" class="btn btn-primary btn-block" style="width:100%; padding:0.85rem; font-size:1rem;">
                            Sign In
                        </button>
                    </form>
                    <p style="text-align:center; margin-top:1.25rem; font-size:0.875rem; color:#737373;">
                        Don't have an account? <a href="course-catalog.html" style="color:#1a365d; font-weight:600;">Browse Courses</a>
                    </p>
                </div>

                <!-- Forgot Password Panel -->
                <div id="forgotPanel" style="display:none;">
                    <h3 style="font-size:1.1rem;font-weight:600;color:#1a365d;margin-bottom:.5rem;">Reset Your Password</h3>
                    <p style="color:#737373;font-size:.9rem;margin-bottom:1.5rem;line-height:1.6;">Enter your email and we'll send you a link to reset your password.</p>
                    <div id="forgotError" style="display:none;background:#fef2f2;border:1px solid #fca5a5;color:#dc2626;padding:.75rem 1rem;border-radius:8px;margin-bottom:1rem;font-size:.9rem;"></div>
                    <div id="forgotSuccess" style="display:none;background:#f0fdf4;border:1px solid #bbf7d0;color:#166534;padding:.75rem 1rem;border-radius:8px;margin-bottom:1rem;font-size:.9rem;"></div>
                    <div style="margin-bottom:1.25rem;">
                        <label style="display:block;font-weight:600;font-size:.9rem;margin-bottom:.4rem;color:#262626;">Email Address</label>
                        <input type="email" id="forgotEmail" placeholder="you@example.com"
                            style="width:100%;padding:.75rem 1rem;border:1px solid #e5e5e5;border-radius:8px;font-size:1rem;box-sizing:border-box;outline:none;">
                    </div>
                    <button onclick="sendPasswordReset()" id="forgotSubmitBtn"
                        style="width:100%;padding:.85rem;background:linear-gradient(135deg,#059669,#10b981);color:white;border:none;border-radius:8px;font-size:1rem;font-weight:700;cursor:pointer;">
                        Send Reset Link
                    </button>
                    <p style="text-align:center;margin-top:1rem;font-size:.875rem;">
                        <a href="#" onclick="showLoginPanel(event)" style="color:#1a365d;font-weight:600;text-decoration:none;">‚Üê Back to Sign In</a>
                    </p>
                </div>

                <!-- Set New Password Panel (shown after clicking reset link) -->
                <div id="resetPanel" style="display:none;">
                    <h3 style="font-size:1.1rem;font-weight:600;color:#1a365d;margin-bottom:.5rem;">Set New Password</h3>
                    <p style="color:#737373;font-size:.9rem;margin-bottom:1.5rem;">Choose a strong new password for your account.</p>
                    <div id="resetError" style="display:none;background:#fef2f2;border:1px solid #fca5a5;color:#dc2626;padding:.75rem 1rem;border-radius:8px;margin-bottom:1rem;font-size:.9rem;"></div>
                    <div style="margin-bottom:1.25rem;">
                        <label style="display:block;font-weight:600;font-size:.9rem;margin-bottom:.4rem;color:#262626;">New Password</label>
                        <input type="password" id="newResetPassword" placeholder="At least 8 characters"
                            style="width:100%;padding:.75rem 1rem;border:1px solid #e5e5e5;border-radius:8px;font-size:1rem;box-sizing:border-box;outline:none;">
                    </div>
                    <div style="margin-bottom:1.5rem;">
                        <label style="display:block;font-weight:600;font-size:.9rem;margin-bottom:.4rem;color:#262626;">Confirm Password</label>
                        <input type="password" id="confirmResetPassword" placeholder="Repeat new password"
                            style="width:100%;padding:.75rem 1rem;border:1px solid #e5e5e5;border-radius:8px;font-size:1rem;box-sizing:border-box;outline:none;">
                    </div>
                    <button onclick="submitNewPassword()" id="resetSubmitBtn"
                        style="width:100%;padding:.85rem;background:linear-gradient(135deg,#059669,#10b981);color:white;border:none;border-radius:8px;font-size:1rem;font-weight:700;cursor:pointer;">
                        Update Password
                    </button>
                </div>
            </div>
        </div>

        <!-- Account Content -->
        <div id="accountContent" style="display: none;">
            <div class="page-header">
                <h1>My Account</h1>
                <p>Manage your continuing education journey</p>
            </div>

            <div class="account-layout">
                <!-- Sidebar Navigation -->
                <div class="sidebar">
                    <h3>Account Menu</h3>
                    <ul>
                        <li><a href="#" onclick="showSection('overview')" class="nav-link active">üìä Overview</a></li>
                        <li><a href="#" onclick="showSection('personal')" class="nav-link">üë§ Personal Info</a></li>
                        <li><a href="#" onclick="showSection('password')" class="nav-link">üîê Password</a></li>
                        <li><a href="#" onclick="showSection('ccu')" class="nav-link">üéì CCU Dashboard</a></li>
                        <li><a href="#" onclick="showSection('courses')" class="nav-link">üìö My Courses</a></li>
                        <li><a href="#" onclick="showSection('credits')" class="nav-link">üí≥ Credits & Referrals</a></li>
                        <li><a href="#" onclick="showSection('superuser')" class="nav-link" id="superuser-nav" style="display: none;">‚ö° Super User</a></li>
                        <li><a href="author-dashboard.html" class="nav-link" id="author-portal-nav" style="display: none;">‚úçÔ∏è Author Portal</a></li>
                        <li><a href="#" onclick="showSection('notifications')" class="nav-link">üîî Notifications</a></li>
                        <li><a href="#" onclick="showSection('security')" class="nav-link">üõ°Ô∏è Security</a></li>
                        <li><a href="#" onclick="showSection('privacy')" class="nav-link">üîí Privacy</a></li>
                        <li><a href="#" onclick="showSection('settings')" class="nav-link">‚öôÔ∏è Settings</a></li>
                    </ul>
                </div>

                <!-- Main Content Area -->
                <div class="main-content">
                    <!-- Overview Section -->
                    <div id="overview" class="content-section active">
                        <h2>Account Overview</h2>
                        <p>Welcome back! Here's your account summary.</p>
                        
                        <div class="ccu-overview">
                            <div class="ccu-card">
                                <h4>CCUs Required</h4>
                                <div class="value" id="requiredCCUs">30</div>
                            </div>
                            <div class="ccu-card">
                                <h4>CCUs Earned</h4>
                                <div class="value" id="earnedCCUs">0</div>
                            </div>
                            <div class="ccu-card">
                                <h4>Courses Completed</h4>
                                <div class="value" id="coursesCompleted">0</div>
                            </div>
                            <div class="ccu-card">
                                <h4>License Status</h4>
                                <div class="value" style="font-size: 1rem; color: var(--success);" id="licenseStatus">Current</div>
                            </div>
                        </div>

                        <div class="progress-container">
                            <h3>CCU Progress</h3>
                            <div class="progress-bar">
                                <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                            </div>
                            <div class="progress-text" id="progressText">0 of 30 CCUs completed (0%)</div>
                        </div>
                    </div>

                    <!-- Personal Info Section -->
                    <div id="personal" class="content-section">
                        <h2>Personal Information</h2>
                        <p>Update your profile and contact information.</p>
                        
                        <form method="POST" id="personalInfoForm">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="firstName">First Name</label>
                                    <input type="text" id="firstName" class="form-input" required>
                                </div>
                                <div class="form-group">
                                    <label for="lastName">Last Name</label>
                                    <input type="text" id="lastName" class="form-input" required>
                                </div>
                                <div class="form-group">
                                    <label for="email">Email Address</label>
                                    <input type="email" id="email" class="form-input" required>
                                </div>
                                <div class="form-group">
                                    <label for="phone">Phone Number</label>
                                    <input type="tel" id="phone" class="form-input" placeholder="(555) 123-4567">
                                </div>
                                <div class="form-group">
                                    <label for="address">Address</label>
                                    <input type="text" id="address" class="form-input" placeholder="123 Main Street">
                                </div>
                                <div class="form-group">
                                    <label for="city">City</label>
                                    <input type="text" id="city" class="form-input" placeholder="Your City">
                                </div>
                                <div class="form-group">
                                    <label for="state">State</label>
                                    <input type="text" id="state" class="form-input" placeholder="TX" maxlength="2" style="text-transform: uppercase;">
                                </div>
                                <div class="form-group">
                                    <label for="zipCode">ZIP Code</label>
                                    <input type="text" id="zipCode" class="form-input" placeholder="12345" maxlength="10">
                                </div>
                                <div class="form-group">
                                    <label for="discipline">Discipline</label>
                                    <select id="discipline" class="form-select" disabled>
                                        <option value="">Select Discipline</option>
                                        <option value="PT">Physical Therapist (PT)</option>
                                        <option value="PTA">Physical Therapist Assistant (PTA)</option>
                                        <option value="OT">Occupational Therapist (OT)</option>
                                        <option value="COTA">Certified OT Assistant (COTA)</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="licenseNumber">License Number</label>
                                    <input type="text" id="licenseNumber" class="form-input" placeholder="Your license number">
                                </div>
                                <div class="form-group">
                                    <label for="licenseState">License State</label>
                                    <input type="text" id="licenseState" class="form-input" placeholder="TX" maxlength="2" style="text-transform: uppercase;">
                                </div>
                                <div class="form-group">
                                    <label for="licenseExpiration">License Expiration</label>
                                    <input type="date" id="licenseExpiration" class="form-input">
                                </div>
                            </div>
                            
                            <div class="checkbox-group">
                                <input type="checkbox" id="renewalReminders" checked>
                                <label for="renewalReminders">Send me email reminders when my license is close to expiring</label>
                            </div>
                            
                            <button type="submit" class="btn btn-primary">üíæ Save Changes</button>
                        </form>
                    </div>

                    <!-- Password Section -->
                    <div id="password" class="content-section">
                        <h2>Change Password</h2>
                        <p>Update your account password for security.</p>
                        
                        <form method="POST" id="passwordForm">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="currentPassword">Current Password</label>
                                    <input type="password" id="currentPassword" class="form-input" required>
                                </div>
                                <div class="form-group">
                                    <label for="newPassword">New Password</label>
                                    <input type="password" id="newPassword" class="form-input" required>
                                </div>
                                <div class="form-group">
                                    <label for="confirmPassword">Confirm New Password</label>
                                    <input type="password" id="confirmPassword" class="form-input" required>
                                </div>
                            </div>
                            
                            <button type="submit" class="btn btn-primary">üîê Change Password</button>
                        </form>
                    </div>

                    <!-- CCU Dashboard Section -->
                    <div id="ccu" class="content-section">
                        <h2>CCU Dashboard</h2>
                        <p>Track your continuing education progress and requirements.</p>
                        
                        <div class="ccu-overview">
                            <div class="ccu-card">
                                <h4>Required This Period</h4>
                                <div class="value" id="ccuRequired">30</div>
                            </div>
                            <div class="ccu-card">
                                <h4>Course CCUs Earned</h4>
                                <div class="value" id="ccuEarned">0</div>
                            </div>
                            <div class="ccu-card" id="ethicsCard">
                                <h4 id="ethicsCardTitle">Ethics & Human Trafficking</h4>
                                <div class="value" id="ethicsCCUs">0</div>
                            </div>
                            <div class="ccu-card">
                                <h4>External CCUs</h4>
                                <div class="value" id="externalCCUs">0</div>
                            </div>
                            <div class="ccu-card">
                                <h4>Total Earned</h4>
                                <div class="value" id="totalCCUs">0</div>
                            </div>
                            <div class="ccu-card">
                                <h4>Remaining</h4>
                                <div class="value" id="ccuRemaining">30</div>
                            </div>
                            <div class="ccu-card">
                                <h4>Days Until Renewal</h4>
                                <div class="value" id="daysUntilRenewal">--</div>
                                <button onclick="recalculateRenewal()" class="btn btn-secondary" style="font-size: 0.7rem; margin-top: 0.5rem; padding: 0.25rem 0.5rem;">üîÑ Refresh</button>
                            </div>
                        </div>
                        
                        <div class="progress-container">
                            <h3>Professional Development Progress</h3>
                            <div class="progress-bar">
                                <div class="progress-fill" id="ccuProgressFill" style="width: 0%"></div>
                            </div>
                            <div class="progress-text" id="ccuProgressText">0 of 30 CCUs completed (0%)</div>
                        </div>

                        <!-- CCU Management Forms -->
                        <div style="margin-top: 2rem;">
                            <div class="form-card" style="margin-bottom: 1.5rem;">
                                <h3 style="color: var(--navy); margin-bottom: 1rem;">üìã Manage Your CCU Credits</h3>
                                
                                <!-- Ethics and Human Trafficking Section -->
                                <div id="ethicsSection" style="background: var(--gray-50); border-radius: 6px; padding: 1rem; margin-bottom: 1.5rem;">
                                    <h4 style="margin-bottom: 0.5rem;" id="ethicsSectionTitle">Ethics & Human Trafficking Requirements</h4>
                                    <p style="font-size: 0.9rem; color: var(--gray-600); margin-bottom: 1rem;" id="ethicsDescription">
                                        For PT/PTA: Complete Jurisprudence Exam + approved Human Trafficking course (3 CCUs total)
                                    </p>
                                    
                                    <div style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: center;">
                                        <div class="checkbox-group">
                                            <input type="checkbox" id="jurisprudenceCompleted" onchange="updateEthicsCCUs()">
                                            <label for="jurisprudenceCompleted" id="jurisprudenceLabel">Jurisprudence Exam Completed (2 CCUs)</label>
                                        </div>
                                        <div class="checkbox-group">
                                            <input type="checkbox" id="humanTrafficingCompleted" onchange="updateEthicsCCUs()">
                                            <label for="humanTrafficingCompleted">Human Trafficking Course Completed (1 CCU)</label>
                                        </div>
                                        <button onclick="saveEthicsCCUs()" class="btn btn-primary" style="font-size: 0.9rem;">üíæ Save</button>
                                    </div>
                                </div>

                                <!-- External CCU Management -->
                                <div style="background: var(--gray-50); border-radius: 6px; padding: 1rem; margin-bottom: 1.5rem;">
                                    <h4 style="margin-bottom: 0.5rem;">üåê External CCU Credits</h4>
                                    <p style="font-size: 0.9rem; color: var(--gray-600); margin-bottom: 1rem;">
                                        Add CCU credits you've earned from other providers or courses outside this platform.
                                    </p>
                                    
                                    <div style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: end; margin-bottom: 1rem;">
                                        <div style="flex: 1; min-width: 200px;">
                                            <label for="externalCCUHours" style="display: block; font-weight: 600; margin-bottom: 0.5rem;">CCU Hours:</label>
                                            <input type="number" id="externalCCUHours" class="form-input" placeholder="0" min="0" max="50" step="0.5" style="width: 100px;">
                                        </div>
                                        <div style="flex: 2; min-width: 200px;">
                                            <label for="externalCCUDescription" style="display: block; font-weight: 600; margin-bottom: 0.5rem;">Description:</label>
                                            <input type="text" id="externalCCUDescription" class="form-input" placeholder="e.g., APTA Conference, Webinar Series, etc.">
                                        </div>
                                        <button onclick="addExternalCCUs()" class="btn btn-success" style="white-space: nowrap;">‚ûï Add CCUs</button>
                                    </div>

                                    <!-- External CCU List -->
                                    <div id="externalCCUList">
                                        <div style="text-align: center; color: var(--gray-600); padding: 1rem; font-style: italic;">
                                            No external CCUs added yet
                                        </div>
                                    </div>
                                </div>

                                <!-- CCU Summary -->
                                <div style="background: linear-gradient(135deg, var(--navy), #1e40af); color: white; border-radius: 6px; padding: 1rem;">
                                    <h4 style="margin-bottom: 0.5rem; color: white;">üìä CCU Summary</h4>
                                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 0.5rem; font-size: 0.9rem;">
                                        <div>Course CCUs: <strong id="summaryCourseCCUs">0</strong></div>
                                        <div id="summaryEthics">Ethics/Trafficking: <strong id="summaryEthicsCCUs">0</strong></div>
                                        <div>External CCUs: <strong id="summaryExternalCCUs">0</strong></div>
                                        <div>Total Earned: <strong id="summaryTotalCCUs">0</strong></div>
                                        <div>Required: <strong id="summaryRequiredCCUs">30</strong></div>
                                        <div>Remaining: <strong id="summaryRemainingCCUs">30</strong></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 2rem;">
                            <h3>Course History</h3>
                            <div id="courseHistory">
                                <p style="text-align: center; color: var(--gray-600); padding: 2rem;">Complete courses to see your CCU history here</p>
                            </div>
                        </div>
                        
                        <div style="margin-top: 2rem; display: flex; gap: 1rem; flex-wrap: wrap;">
                            <button onclick="printCCUTranscript()" class="btn btn-secondary">üìÑ Print CCU Transcript</button>
                            <a href="courses.html" class="btn btn-primary">üìö Browse Courses</a>
                        </div>
                    </div>

                    <!-- My Courses Section -->
                    <div id="courses" class="content-section">
                        <h2>My Courses</h2>
                        <p>View your enrolled and completed courses.</p>
                        
                        <div id="coursesList">
                            <div style="text-align: center; color: var(--gray-600); padding: 3rem;">
                                <h3>No Courses Yet</h3>
                                <p>You haven't enrolled in any courses yet.</p>
                                <a href="courses.html" class="btn btn-primary" style="margin-top: 1rem;">üìö Browse Available Courses</a>
                            </div>
                        </div>
                    </div>

                    <!-- Super User Section -->
                    <!-- Credits & Referrals Section -->
                    <div id="credits" class="content-section">
                        <h2>üí≥ Credits & Referrals</h2>

                        <!-- Balance Card -->
                        <div style="background:linear-gradient(135deg,#1a365d,#2c5282);border-radius:16px;padding:2rem;color:white;margin-bottom:2rem;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:1rem;">
                            <div>
                                <div style="font-size:.85rem;font-weight:600;text-transform:uppercase;letter-spacing:.08em;opacity:.75;margin-bottom:.5rem;">Available Credit Balance</div>
                                <div style="font-size:3rem;font-weight:700;font-family:'Playfair Display',Georgia,serif;" id="myCreditsBalance">$0.00</div>
                                <div style="font-size:.9rem;opacity:.8;margin-top:.5rem;">Applied automatically at checkout</div>
                            </div>
                            <div style="text-align:center;">
                                <div style="font-size:2rem;margin-bottom:.25rem;">üéÅ</div>
                                <div style="font-size:.85rem;opacity:.75;">Earn $10 per referral</div>
                            </div>
                        </div>

                        <!-- Referral Link -->
                        <div style="background:#f0fdf4;border:2px solid #bbf7d0;border-radius:16px;padding:2rem;margin-bottom:2rem;">
                            <h3 style="font-size:1.1rem;font-weight:700;color:#1a365d;margin-bottom:.5rem;">üë• Your Referral Link</h3>
                            <p style="color:#374151;font-size:.95rem;margin-bottom:1.25rem;line-height:1.6;">Share this link with colleagues. When they make their first purchase, you earn a <strong>$10 credit</strong> ‚Äî applied to your future purchases.</p>
                            <div style="display:flex;gap:.75rem;align-items:center;flex-wrap:wrap;">
                                <input type="text" id="myReferralLink" readonly
                                    style="flex:1;min-width:200px;padding:.875rem 1rem;border:2px solid #d1fae5;border-radius:10px;background:white;font-size:.9rem;color:#1a365d;font-family:inherit;">
                                <button onclick="copyReferralLink()" id="copyRefBtn"
                                    style="padding:.875rem 1.5rem;background:#059669;color:white;border:none;border-radius:10px;font-weight:700;cursor:pointer;font-size:.95rem;white-space:nowrap;">
                                    Copy Link
                                </button>
                            </div>
                            <div id="copyRefConfirm" style="display:none;color:#059669;font-weight:600;font-size:.9rem;margin-top:.75rem;">‚úì Copied to clipboard!</div>
                            <div style="margin-top:1.25rem;display:flex;gap:2rem;flex-wrap:wrap;">
                                <div style="text-align:center;">
                                    <div style="font-size:1.75rem;font-weight:700;color:#059669;" id="totalReferrals">0</div>
                                    <div style="font-size:.8rem;color:#64748b;font-weight:600;">Total Referrals</div>
                                </div>
                                <div style="text-align:center;">
                                    <div style="font-size:1.75rem;font-weight:700;color:#059669;" id="totalReferralEarned">$0</div>
                                    <div style="font-size:.8rem;color:#64748b;font-weight:600;">Total Earned</div>
                                </div>
                            </div>
                        </div>

                        <!-- Invite a Colleague -->
                        <div style="background:#f8fafc;border:1px solid #e2e8f0;border-radius:16px;padding:2rem;margin-bottom:2rem;">
                            <h3 style="font-size:1.1rem;font-weight:700;color:#1a365d;margin-bottom:.5rem;">‚úâÔ∏è Invite a Colleague Directly</h3>
                            <p style="color:#374151;font-size:.95rem;margin-bottom:1.25rem;line-height:1.6;">Enter their email and we'll send them a personal invitation with your referral link. When they make their first purchase, you earn a <strong>$10 credit</strong> applied to your future purchases.</p>
                            <div style="display:flex;gap:.75rem;flex-wrap:wrap;margin-bottom:.75rem;">
                                <input type="email" id="inviteEmail" placeholder="colleague@email.com"
                                    style="flex:1;min-width:220px;padding:.875rem 1rem;border:2px solid #e2e8f0;border-radius:10px;font-size:.95rem;font-family:inherit;outline:none;transition:border .2s;"
                                    onfocus="this.style.borderColor='#059669'" onblur="this.style.borderColor='#e2e8f0'">
                                <button onclick="sendColleagueInvite()"
                                    style="padding:.875rem 1.75rem;background:linear-gradient(135deg,#1a365d,#2c5282);color:white;border:none;border-radius:10px;font-weight:700;font-size:.95rem;cursor:pointer;white-space:nowrap;">
                                    Send Invitation
                                </button>
                            </div>
                            <div id="inviteFeedback" style="display:none;font-size:.9rem;padding:.75rem 1rem;border-radius:8px;"></div>
                        </div>

                        <!-- Transaction History -->
                        <div style="background:white;border:1px solid #e2e8f0;border-radius:16px;overflow:hidden;">
                            <div style="padding:1.25rem 1.5rem;border-bottom:1px solid #e2e8f0;background:#f8fafc;">
                                <h3 style="font-size:1rem;font-weight:700;color:#1e293b;margin:0;">Credit History</h3>
                            </div>
                            <div id="myTransactionList">
                                <p style="color:#94a3b8;text-align:center;padding:2rem;font-size:.95rem;">Loading‚Ä¶</p>
                            </div>
                        </div>
                    </div>

                    <div id="superuser" class="content-section">
                        <h2>‚ö° Super User Controls</h2>
                        <p>Advanced administrative controls for platform management.</p>
                        
                        <!-- Super User Status -->
                        <div class="form-card" style="margin-bottom: 2rem;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                                <div>
                                    <h3 style="color: var(--navy); margin-bottom: 0.5rem;">Super User Status</h3>
                                    <p style="color: var(--gray-600); margin: 0;">Enhanced privileges for course management and platform access</p>
                                </div>
                                <div id="superuser-status-badge" style="padding: 0.5rem 1rem; border-radius: 20px; font-weight: bold; font-size: 0.9rem;">
                                    ‚ö° ACTIVE
                                </div>
                            </div>
                        </div>

                        <!-- Course Management -->
                        <div class="form-card" style="margin-bottom: 2rem;">
                            <h3 style="color: var(--navy); margin-bottom: 1rem;">üìö Course Management</h3>
                            
                            <!-- Auto-Enroll All Courses -->
                            <div style="margin-bottom: 1.5rem;">
                                <button onclick="enrollAllCourses()" class="btn btn-primary" style="margin-right: 1rem;">
                                    ‚ûï Auto-Enroll in All Available Courses
                                </button>
                                <button onclick="showAllCoursesAccess()" class="btn btn-secondary">
                                    üëÅÔ∏è View All Course Access
                                </button>
                            </div>

                            <!-- Course Access Override ‚Äî dynamically populated -->
                            <div style="background: var(--gray-50); border: 1px solid var(--gray-200); border-radius: 6px; padding: 1rem; margin-bottom: 1.5rem;">
                                <h4 style="margin-bottom: 0.5rem;">üîì All Courses</h4>
                                <p style="font-size: 0.9rem; color: var(--gray-600); margin-bottom: 1rem;">All courses in the platform catalog:</p>
                                <div id="superuser-course-list" style="display: flex; flex-direction: column; gap: 0.5rem;">
                                    <p style="color: var(--gray-500); font-size: 0.9rem;">Loading courses‚Ä¶</p>
                                </div>
                            </div>
                        </div>

                        <!-- Progress Management -->
                        <div class="form-card" style="margin-bottom: 2rem;">
                            <h3 style="color: var(--navy); margin-bottom: 1rem;">üìä Progress Management</h3>
                            
                            <div class="form-grid">
                                <div>
                                    <button onclick="viewDetailedProgress()" class="btn btn-secondary" style="width: 100%; margin-bottom: 1rem;">
                                        üìà View Detailed Progress Data
                                    </button>
                                    <button onclick="resetSpecificCourse()" class="btn btn-secondary" style="width: 100%;">
                                        üéØ Reset Specific Course
                                    </button>
                                </div>
                                <div>
                                    <button onclick="resetAllProgress()" class="btn btn-danger" style="width: 100%; margin-bottom: 1rem;">
                                        üîÑ Reset ALL Course Progress
                                    </button>
                                    <button onclick="simulateCourseCompletion()" class="btn btn-success" style="width: 100%;">
                                        ‚úÖ Simulate Course Completion
                                    </button>
                                </div>
                            </div>

                            <!-- Progress Details Display -->
                            <div id="detailed-progress" style="display: none; margin-top: 1.5rem; background: var(--gray-50); border-radius: 6px; padding: 1rem;">
                                <h4>Current Progress Data:</h4>
                                <pre id="progress-data-display" style="background: white; padding: 1rem; border-radius: 4px; overflow-x: auto; font-size: 0.8rem;"></pre>
                            </div>
                        </div>

                        <!-- Account Management -->
                        <div class="form-card" style="margin-bottom: 2rem;">
                            <h3 style="color: var(--navy); margin-bottom: 1rem;">üë§ Account Management</h3>
                            
                            <div style="display: flex; gap: 1rem; flex-wrap: wrap; margin-bottom: 1.5rem;">
                                <button onclick="exportAccountData()" class="btn btn-secondary">üíæ Export Account Data</button>
                                <button onclick="viewStorageData()" class="btn btn-secondary">üóÑÔ∏è View localStorage Data</button>
                                <button onclick="clearAllData()" class="btn btn-danger">üóëÔ∏è Clear All Data</button>
                            </div>

                            <!-- Toggle Super User Status -->
                            <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 6px; padding: 1rem;">
                                <h4 style="margin-bottom: 0.5rem;">‚ö†Ô∏è Manage Super User Status</h4>
                                <p style="font-size: 0.9rem; margin-bottom: 1rem;">Disable super user privileges to return to normal user experience:</p>
                                <button onclick="toggleSuperUser()" class="btn btn-danger" style="font-size: 0.9rem;">Disable Super User Mode</button>
                            </div>
                        </div>

                        <!-- Platform Access -->
                        <div class="form-card">
                            <h3 style="color: var(--navy); margin-bottom: 1rem;">üîß Platform Access</h3>
                            <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                                <a href="admin.html" class="btn btn-primary" target="_blank">üõ°Ô∏è Admin Dashboard</a>
                                <a href="courses.html" class="btn btn-secondary">üìö Browse All Courses</a>
                                <button onclick="openDevConsole()" class="btn btn-secondary">üíª Developer Tools Guide</button>
                            </div>
                        </div>

                        <!-- Author Management -->
                        <div class="form-card">
                            <h3 style="color: var(--navy); margin-bottom: 1rem;">üë• Author Management</h3>
                            
                            <!-- Author Management Nav -->
                            <div style="display: flex; gap: 0.5rem; margin-bottom: 1.5rem; flex-wrap: wrap;">
                                <button onclick="showAuthorSection('authors-list')" class="btn btn-secondary" id="btn-authors-list">üìã Authors</button>
                                <button onclick="showAuthorSection('add-author')" class="btn btn-secondary" id="btn-add-author">‚ûï Add Author</button>
                                <button onclick="showAuthorSection('course-assignments')" class="btn btn-secondary" id="btn-course-assignments">üìö Course Assignments</button>
                                <button onclick="showAuthorSection('sales-reports')" class="btn btn-secondary" id="btn-sales-reports">üìä Sales Reports</button>
                                <button onclick="showAuthorSection('payments')" class="btn btn-secondary" id="btn-payments">üí∞ Payments</button>
                                <button onclick="showAuthorSection('designate-users')" class="btn btn-secondary" id="btn-designate-users">üë§ Designate Users</button>
                            </div>

                            <!-- Authors List -->
                            <div id="authors-list" class="author-section" style="display: none;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                    <h4>Current Authors</h4>
                                    <button onclick="loadAuthors()" class="btn btn-secondary">üîÑ Refresh</button>
                                </div>
                                <div id="authors-table" style="overflow-x: auto;">
                                    <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                                        <thead>
                                            <tr style="background: #f8fafc; border-bottom: 2px solid #e2e8f0;">
                                                <th style="padding: 0.75rem; text-align: left; font-weight: 600;">Name</th>
                                                <th style="padding: 0.75rem; text-align: left; font-weight: 600;">Email</th>
                                                <th style="padding: 0.75rem; text-align: left; font-weight: 600;">Credentials</th>
                                                <th style="padding: 0.75rem; text-align: left; font-weight: 600;">Default %</th>
                                                <th style="padding: 0.75rem; text-align: left; font-weight: 600;">Status</th>
                                                <th style="padding: 0.75rem; text-align: left; font-weight: 600;">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="authors-table-body">
                                            <!-- Authors will be loaded here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- Add Author Form -->
                            <div id="add-author" class="author-section" style="display: none;">
                                <h4>Add New Author</h4>
                                <form method="POST" id="add-author-form" style="display: grid; gap: 1rem;">
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                        <div>
                                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">First Name *</label>
                                            <input type="text" id="author-first-name" required style="width: 100%; padding: 0.5rem; border: 2px solid #e2e8f0; border-radius: 6px;">
                                        </div>
                                        <div>
                                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Last Name *</label>
                                            <input type="text" id="author-last-name" required style="width: 100%; padding: 0.5rem; border: 2px solid #e2e8f0; border-radius: 6px;">
                                        </div>
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Email *</label>
                                        <input type="email" id="author-email" required style="width: 100%; padding: 0.5rem; border: 2px solid #e2e8f0; border-radius: 6px;">
                                    </div>
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                        <div>
                                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Credentials</label>
                                            <input type="text" id="author-credentials" placeholder="PT, ScD" style="width: 100%; padding: 0.5rem; border: 2px solid #e2e8f0; border-radius: 6px;">
                                        </div>
                                        <div>
                                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Default Revenue %</label>
                                            <input type="number" id="author-revenue-share" min="0" max="100" step="0.01" value="50" style="width: 100%; padding: 0.5rem; border: 2px solid #e2e8f0; border-radius: 6px;">
                                        </div>
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Bio</label>
                                        <textarea id="author-bio" rows="3" placeholder="Brief professional background..." style="width: 100%; padding: 0.5rem; border: 2px solid #e2e8f0; border-radius: 6px; resize: vertical;"></textarea>
                                    </div>
                                    <button type="submit" class="btn btn-primary">‚úÖ Add Author</button>
                                </form>
                            </div>

                            <!-- Course Assignments -->
                            <div id="course-assignments" class="author-section" style="display: none;">
                                <h4>Assign Authors to Courses</h4>
                                <div style="margin-bottom: 1rem;">
                                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Select Course</label>
                                    <select id="course-select" style="width: 100%; padding: 0.5rem; border: 2px solid #e2e8f0; border-radius: 6px;">
                                        <option value="">Choose a course...</option>
                                    </select>
                                </div>
                                <div id="course-authors-assignment" style="display: none;">
                                    <h5>Current Authors for this Course:</h5>
                                    <div id="current-course-authors" style="margin: 1rem 0;"></div>
                                    
                                    <h5>Add New Author:</h5>
                                    <div style="display: grid; grid-template-columns: 2fr 1fr 1fr auto; gap: 1rem; align-items: end; margin: 1rem 0;">
                                        <div>
                                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Author</label>
                                            <select id="author-select" style="width: 100%; padding: 0.5rem; border: 2px solid #e2e8f0; border-radius: 6px;">
                                                <option value="">Choose author...</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Revenue %</label>
                                            <input type="number" id="course-author-share" min="0" max="100" step="0.01" style="width: 100%; padding: 0.5rem; border: 2px solid #e2e8f0; border-radius: 6px;">
                                        </div>
                                        <div>
                                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Role</label>
                                            <select id="author-role" style="width: 100%; padding: 0.5rem; border: 2px solid #e2e8f0; border-radius: 6px;">
                                                <option value="primary">Primary</option>
                                                <option value="contributing">Contributing</option>
                                                <option value="reviewer">Reviewer</option>
                                            </select>
                                        </div>
                                        <button onclick="assignAuthorToCourse()" class="btn btn-primary">‚ûï Assign</button>
                                    </div>
                                </div>
                            </div>

                            <!-- Sales Reports -->
                            <div id="sales-reports" class="author-section" style="display: none;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                    <h4>Author Sales Reports</h4>
                                    <div style="display: flex; gap: 0.5rem;">
                                        <input type="date" id="report-start-date" style="padding: 0.25rem; border: 2px solid #e2e8f0; border-radius: 4px;">
                                        <input type="date" id="report-end-date" style="padding: 0.25rem; border: 2px solid #e2e8f0; border-radius: 4px;">
                                        <button onclick="generateSalesReport()" class="btn btn-secondary">üìä Generate Report</button>
                                    </div>
                                </div>
                                <div id="sales-report-content">
                                    <p style="color: #6b7280; text-align: center; padding: 2rem;">Select date range and click "Generate Report" to view sales data</p>
                                </div>
                            </div>

                            <!-- Payments -->
                            <div id="payments" class="author-section" style="display: none;">
                                <h4>Author Payments</h4>
                                <div style="display: flex; gap: 1rem; margin-bottom: 1rem; flex-wrap: wrap;">
                                    <button onclick="loadPendingPayments()" class="btn btn-secondary">üí∞ View Pending Payments</button>
                                    <button onclick="generatePaymentBatch()" class="btn btn-primary">üìÑ Generate Payment Batch</button>
                                </div>
                                <div id="payments-content">
                                    <p style="color: #6b7280; text-align: center; padding: 2rem;">Click "View Pending Payments" to see authors awaiting payment</p>
                                </div>
                            </div>

                            <!-- Designate Users as Authors -->
                            <div id="designate-users" class="author-section" style="display: none;">
                                <h4>Designate Users as Authors</h4>
                                <p style="color: #6b7280; margin-bottom: 1.5rem;">Connect existing user accounts to author records to give them access to the Author Portal.</p>
                                
                                <!-- User Search -->
                                <div style="margin-bottom: 2rem;">
                                    <div style="display: flex; gap: 1rem; align-items: end; margin-bottom: 1rem;">
                                        <div style="flex: 1;">
                                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">User Email</label>
                                            <input type="email" id="user-email-search" placeholder="Enter user's email address" 
                                                style="width: 100%; padding: 0.5rem; border: 2px solid #e2e8f0; border-radius: 6px;">
                                        </div>
                                        <button onclick="searchUser()" class="btn btn-secondary">üîç Search User</button>
                                    </div>
                                    <div id="user-search-results" style="display: none; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 6px; padding: 1rem;"></div>
                                </div>

                                <!-- Author Assignment -->
                                <div id="author-assignment-section" style="display: none;">
                                    <h5 style="color: var(--navy); margin-bottom: 1rem;">Assign Author Role</h5>
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                                        <div>
                                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Select Author</label>
                                            <select id="assign-author-select" style="width: 100%; padding: 0.5rem; border: 2px solid #e2e8f0; border-radius: 6px;">
                                                <option value="">Choose existing author...</option>
                                            </select>
                                        </div>
                                        <div style="display: flex; align-items: end;">
                                            <button onclick="assignUserToAuthor()" class="btn btn-primary" style="width: 100%;">‚úÖ Designate as Author</button>
                                        </div>
                                    </div>
                                    <div id="assignment-feedback" style="display: none; padding: 1rem; border-radius: 6px; margin-bottom: 1rem;"></div>
                                </div>

                                <!-- Current Designations -->
                                <div>
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                        <h5>Current Author Designations</h5>
                                        <button onclick="loadUserAuthorDesignations()" class="btn btn-secondary">üîÑ Refresh</button>
                                    </div>
                                    <div id="user-author-designations" style="background: white; border: 1px solid #e2e8f0; border-radius: 6px; overflow: hidden;">
                                        <p style="color: #6b7280; text-align: center; padding: 2rem;">Click "Refresh" to load current designations</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Notifications Section -->
                    <div id="notifications" class="content-section">
                        <h2>Notification Preferences</h2>
                        <p>Control how and when you receive updates.</p>
                        
                        <form method="POST" id="notificationsForm">
                            <h3 style="margin-bottom: 1rem;">Email Notifications</h3>
                            
                            <div class="checkbox-group">
                                <input type="checkbox" id="emailCourseUpdates" checked>
                                <label for="emailCourseUpdates">Course updates and new content</label>
                            </div>
                            
                            <div class="checkbox-group">
                                <input type="checkbox" id="emailLicenseReminders" checked>
                                <label for="emailLicenseReminders">License renewal reminders</label>
                            </div>
                            
                            <div class="checkbox-group">
                                <input type="checkbox" id="emailPromotions">
                                <label for="emailPromotions">Promotions and special offers</label>
                            </div>
                            
                            <div class="checkbox-group">
                                <input type="checkbox" id="emailWeeklyDigest">
                                <label for="emailWeeklyDigest">Weekly digest of platform activity</label>
                            </div>
                            
                            <button type="button" onclick="saveNotificationPreferences()" class="btn btn-primary">üíæ Save Preferences</button>
                        </form>
                    </div>

                    <!-- Security Section -->
                    <div id="security" class="content-section">
                        <h2>Security Settings</h2>
                        <p>Manage your account security and login settings.</p>
                        
                        <div style="background: var(--gray-50); padding: 2rem; border-radius: 8px; margin-bottom: 2rem;">
                            <h3>Two-Factor Authentication</h3>
                            <p style="color: var(--gray-600); margin: 1rem 0;">Add an extra layer of security to your account.</p>
                            <button class="btn btn-secondary">üîê Enable 2FA (Coming Soon)</button>
                        </div>
                        
                        <div style="background: var(--gray-50); padding: 2rem; border-radius: 8px;">
                            <h3>Recent Login Activity</h3>
                            <div id="loginActivity">
                                <p style="color: var(--gray-600); text-align: center; padding: 2rem;">No recent login activity recorded</p>
                            </div>
                        </div>
                    </div>

                    <!-- Privacy Section -->
                    <div id="privacy" class="content-section">
                        <h2>Privacy & Data</h2>
                        <p>Manage your privacy settings and data preferences.</p>
                        
                        <form method="POST" id="privacyForm">
                            <h3 style="margin-bottom: 1rem;">Data Usage</h3>
                            
                            <div class="checkbox-group">
                                <input type="checkbox" id="dataAnalytics" checked>
                                <label for="dataAnalytics">Allow anonymous usage analytics to improve the platform</label>
                            </div>
                            
                            <div class="checkbox-group">
                                <input type="checkbox" id="marketingConsent">
                                <label for="marketingConsent">Consent to marketing communications</label>
                            </div>
                            
                            <button type="button" onclick="savePrivacySettings()" class="btn btn-primary">üíæ Save Privacy Settings</button>
                        </form>
                        
                        <div style="margin-top: 3rem; padding: 2rem; border: 1px solid var(--gray-200); border-radius: 8px;">
                            <h3>Data Export & Deletion</h3>
                            <p style="color: var(--gray-600); margin: 1rem 0;">Export your data or delete your account permanently.</p>
                            <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                                <button onclick="exportAccountData()" class="btn btn-secondary">üì• Export My Data</button>
                                <button onclick="requestAccountDeletion()" class="btn btn-danger">üóëÔ∏è Delete Account</button>
                            </div>
                        </div>
                    </div>

                    <!-- Settings Section -->
                    <div id="settings" class="content-section">
                        <h2>Account Settings</h2>
                        <p>Customize your account preferences and interface.</p>
                        
                        <div style="background: var(--gray-50); padding: 2rem; border-radius: 8px; margin-bottom: 2rem;">
                            <h3>Interface Preferences</h3>
                            
                            <div class="checkbox-group">
                                <input type="checkbox" id="darkMode">
                                <label for="darkMode">Enable dark mode (Coming Soon)</label>
                            </div>
                        </div>
                        
                        <div style="background: var(--gray-50); padding: 2rem; border-radius: 8px;">
                            <h3>Account Actions</h3>
                            <div style="display: flex; gap: 1rem; flex-wrap: wrap; margin-top: 1rem;">
                                <button onclick="logout()" class="btn btn-secondary">üö™ Logout</button>
                                <a href="courses.html" class="btn btn-primary">üìö Browse Courses</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Global variables
        let currentAccount = null;
        let currentSupabaseUser = null;

        // ‚îÄ‚îÄ‚îÄ SUPABASE AUTH INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // Initialize page when loaded ‚Äî Supabase-first, localStorage fallback
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üîç My Account page initializing (Supabase auth)...');

            setupEventListeners();

            // Listen for future auth state changes
            if (window.DrTroySupabase) {
                window.DrTroySupabase.onAuthStateChange((event, session) => {
                    if (event === 'SIGNED_OUT') {
                        showLoginRequired();
                    } else if (event === 'SIGNED_IN' && session && !window._accountInitialized) {
                        // Only run if checkLoginStatus hasn't already initialized the account
                        currentSupabaseUser = session.user;
                        initAccountFromSupabase(session.user);
                    }
                });
            }

            // Check existing session
            await checkLoginStatus();
        });

        // Check login status ‚Äî Supabase first, legacy localStorage fallback
        async function checkLoginStatus() {
            console.log('üîç checkLoginStatus() ‚Äî checking Supabase session...');

            // ‚îÄ‚îÄ Try Supabase session ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            if (window.DrTroySupabase) {
                const session = await window.DrTroySupabase.getSession();
                if (session && session.user) {
                    console.log('‚úÖ Supabase session active:', session.user.email);
                    currentSupabaseUser = session.user;
                    await initAccountFromSupabase(session.user);
                    return;
                }
                console.log('‚ÑπÔ∏è No Supabase session found, checking localStorage...');
            }

            // No valid Supabase session ‚Äî legacy localStorage login removed for security
            showLoginRequired();
        }

        // Initialize account dashboard from a Supabase user object
        async function initAccountFromSupabase(user) {
            // Load profile from Supabase
            let profile = null;
            if (window.DrTroySupabase) {
                const { data } = await window.DrTroySupabase.getProfile(user.id);
                profile = data;
            }

            // Build currentAccount from Supabase data, falling back to localStorage
            const legacyData = (() => {
                try { return JSON.parse(localStorage.getItem('drtroyAccount') || '{}'); } catch { return {}; }
            })();

            currentAccount = {
                id: user.id,
                email: user.email,
                firstName: profile?.first_name || legacyData.firstName || '',
                lastName:  profile?.last_name  || legacyData.lastName  || '',
                discipline: profile?.profession || legacyData.discipline || 'PT',
                licenseNumber: profile?.license_number || legacyData.licenseNumber || '',
                licenseState:  profile?.license_state   || legacyData.licenseState  || '',
                phone:    legacyData.phone    || '',
                address:  legacyData.address  || '',
                city:     legacyData.city     || '',
                state:    legacyData.state    || '',
                zipCode:  legacyData.zipCode  || '',
                licenseExpiration: legacyData.licenseExpiration || '',
                licenseRenewalReminders: legacyData.licenseRenewalReminders !== false,
                notifications: legacyData.notifications || {},
                privacy: {
                    marketingConsent: profile?.marketing_consent ?? legacyData.privacy?.marketingConsent ?? false,
                    dataAnalytics:    legacyData.privacy?.dataAnalytics ?? true
                },
                ethicsCCUs:    legacyData.ethicsCCUs    || { jurisprudenceCompleted: false, humanTrafficingCompleted: false, totalEthicsCCUs: 0 },
                externalCCUs:  legacyData.externalCCUs  || [],
                courseProgress: legacyData.courseProgress || {},
                enrolledCourses: legacyData.enrolledCourses || [],
                // Admin check from profile
                superUser: profile?.is_admin === true || legacyData.superUser === true
            };

            // Load real enrollments from Supabase
            await loadSupabaseEnrollments(user.id);

            // Check if user is an author and show author portal link
            await checkAuthorAccess(user.email);

            // Apply saved section BEFORE showing content ‚Äî eliminates the overview flash
            const _savedSection = localStorage.getItem('currentAccountSection');
            if (_savedSection && document.getElementById(_savedSection)) {
                document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
                document.getElementById(_savedSection).classList.add('active');
            }

            showAccountContent();
            loadAccountData();
            restoreCachedRenewal();

            // Re-render courses AFTER everything else runs
            if (currentAccount._supabaseEnrollments?.length > 0) {
                renderSupabaseCourses(currentAccount._supabaseEnrollments);
            }

            // Final section restore ‚Äî corrects nav highlight and any timer-triggered resets
            restoreActiveSection();
            renderSuperuserCourseList();
            window._accountInitialized = true;
            updateNavigation();
        }

        // Load enrollments from Supabase via direct REST (no CDN dependency)
        async function loadSupabaseEnrollments(userId) {
            if (!userId) return;

            const SUPA_URL  = 'https://pnqoxulxdmlmbywcpbyx.supabase.co';
            const ANON_KEY  = 'process.env.SUPABASE_ANON_KEY || window.SUPABASE_ANON_KEY || 'YOUR_SUPABASE_ANON_KEY'';

            // Get the current user's JWT ‚Äî try SDK first, then localStorage, then anon
            let userJwt = ANON_KEY;
            try {
                // Try Supabase SDK
                const sb = window.DrTroySupabase?.getClient?.();
                if (sb) {
                    const { data } = await sb.auth.getSession();
                    if (data?.session?.access_token) { userJwt = data.session.access_token; }
                }
                // Fallback: read from localStorage (Supabase persists token here)
                if (userJwt === ANON_KEY) {
                    const storageKey = Object.keys(localStorage).find(k => k.includes('auth-token') || k.includes('supabase'));
                    if (storageKey) {
                        const stored = JSON.parse(localStorage.getItem(storageKey) || '{}');
                        const token = stored?.access_token || stored?.session?.access_token;
                        if (token) userJwt = token;
                    }
                }
            } catch(e) { console.warn('JWT fetch fallback to anon:', e.message); }

            try {
                // Fetch enrollments + course data via REST
                const select = encodeURIComponent('*,courses(id,title,description,ceu_hours,professions),course_progress(id,status,progress_percent,modules_completed,completed_at,updated_at)');
                const res = await fetch(
                    `${SUPA_URL}/rest/v1/enrollments?user_id=eq.${userId}&select=${select}&order=purchased_at.desc`,
                    { headers: { apikey: ANON_KEY, Authorization: `Bearer ${userJwt}` } }
                );
                const enrollments = await res.json();
                if (!Array.isArray(enrollments) || enrollments.length === 0) return;

                currentAccount._supabaseEnrollments = enrollments;

                // Inject enrolled courses into COURSE_DATABASE so super-user functions work
                enrollments.forEach(e => {
                    if (e.courses && !COURSE_DATABASE[e.course_id]) {
                        COURSE_DATABASE[e.course_id] = {
                            title: e.courses.title,
                            credits: e.courses.ceu_hours || 1,
                            description: e.courses.description || '',
                            status: 'available',
                            professions: e.courses.professions || [],
                            url: COURSE_CONTENT_URLS[e.course_id] || `courses/${e.course_id}-progressive.html`
                        };
                    }
                });

                // Also fetch ALL courses from Supabase so superuser sees the full catalog
                try {
                    const allRes = await fetch(
                        `${SUPA_URL}/rest/v1/courses?select=id,title,description,ceu_hours,professions`,
                        { headers: { apikey: ANON_KEY, Authorization: `Bearer ${userJwt}` } }
                    );
                    const allCourses = await allRes.json();
                    if (Array.isArray(allCourses)) {
                        allCourses.forEach(c => {
                            if (!COURSE_DATABASE[c.id]) {
                                COURSE_DATABASE[c.id] = {
                                    title: c.title,
                                    credits: c.ceu_hours || 1,
                                    description: c.description || '',
                                    status: 'available',
                                    professions: c.professions || [],
                                    url: COURSE_CONTENT_URLS[c.id] || `courses/${c.id}-progressive.html`
                                };
                            }
                        });
                    }
                } catch(e) { /* non-critical */ }

                // Render courses directly into the DOM
                renderSupabaseCourses(enrollments);

                // Populate the super user course catalog list
                renderSuperuserCourseList();

            } catch(err) {
                console.error('loadSupabaseEnrollments error:', err);
            }
        }

        // Render full course catalog into the Super User section
        function renderSuperuserCourseList() {
            const container = document.getElementById('superuser-course-list');
            if (!container) return;

            const allIds = Object.keys(COURSE_DATABASE);
            if (allIds.length === 0) {
                container.innerHTML = '<p style="color:var(--gray-500);font-size:0.9rem;">No courses found.</p>';
                return;
            }

            const enrolled = new Set(currentAccount?.enrolledCourses || []);
            let html = '';
            allIds.forEach(id => {
                const c = COURSE_DATABASE[id];
                if (!c) return;
                const isEnrolled = enrolled.has(id);
                const badge = isEnrolled
                    ? '<span style="color:#16a34a;font-weight:600;font-size:0.8rem;">‚úì Enrolled</span>'
                    : '<span style="color:#9ca3af;font-size:0.8rem;">Not enrolled</span>';
                const profs = Array.isArray(c.professions) ? c.professions.join(', ') : (c.professions || '');
                html += `
                    <div style="display:flex;align-items:center;justify-content:space-between;padding:0.6rem 0.75rem;background:white;border-radius:6px;border:1px solid var(--gray-200);">
                        <div>
                            <strong style="font-size:0.9rem;">${c.title}</strong>
                            <span style="margin-left:0.5rem;color:var(--gray-500);font-size:0.8rem;">${c.credits} CCU${c.credits !== 1 ? 's' : ''} ${profs ? '¬∑ ' + profs : ''}</span>
                        </div>
                        <div style="display:flex;align-items:center;gap:0.75rem;">
                            ${badge}
                            <code style="font-size:0.75rem;color:var(--gray-500);">${id}</code>
                        </div>
                    </div>`;
            });
            container.innerHTML = html; // XSS protection applied
        }

        // Directly render Supabase enrollment cards into coursesList
        function renderSupabaseCourses(enrollments) {
            const coursesList = document.getElementById('coursesList');
            if (!coursesList) return;

            let html = '<div class="courses-grid">';
            enrollments.forEach(e => {
                const c = e.courses;
                if (!c) return;
                html += `
                    <div class="course-card">
                        <div class="course-header">
                            <h3>${c.title}</h3>
                            <span class="status-badge available">Available</span>
                        </div>
                        <p class="course-description">${c.description || ''}</p>
                        <div class="course-details">
                            <div class="course-credits"><strong>${c.ceu_hours} CCU${c.ceu_hours !== 1 ? 's' : ''}</strong></div>
                        </div>
                        <div class="course-actions">
                            <button class="btn btn-primary" onclick="alert('Course content coming soon!')">Start Course</button>
                        </div>
                    </div>`;
            });
            html += '</div>';
            coursesList.innerHTML = html; // XSS protection applied
        }

        // Rate limiting for customer login attempts  
        function checkCustomerRateLimit() {
            const attempts = parseInt(localStorage.getItem('customerLoginAttempts') || '0');
            const lastAttempt = parseInt(localStorage.getItem('customerLastAttempt') || '0');
            const RATE_LIMIT_WINDOW = 15 * 60 * 1000; // 15 minutes
            const MAX_ATTEMPTS = 5;
            const now = Date.now();
            
            if (now - lastAttempt > RATE_LIMIT_WINDOW) {
                // Reset counter after rate limit window
                localStorage.removeItem('customerLoginAttempts');
                localStorage.removeItem('customerLastAttempt');
                return true;
            }
            
            if (attempts >= MAX_ATTEMPTS) {
                const remainingTime = Math.ceil((RATE_LIMIT_WINDOW - (now - lastAttempt)) / 60000);
                throw new Error(`Too many login attempts. Please wait ${remainingTime} minutes before trying again.`);
            }
            
            return true;
        }

        function incrementCustomerAttempts() {
            const attempts = parseInt(localStorage.getItem('customerLoginAttempts') || '0') + 1;
            const now = Date.now();
            localStorage.setItem('customerLoginAttempts', attempts.toString());
            localStorage.setItem('customerLastAttempt', now.toString());
            return 5 - attempts; // remaining attempts
        }

        // Supabase Login Form Handler
        async function handleSupabaseLogin(event) {
            event.preventDefault();
            const email    = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            const errEl    = document.getElementById('loginError');
            const btnEl    = document.getElementById('loginSubmitBtn');

            errEl.style.display = 'none';
            
            // Check rate limit before proceeding
            try {
                checkCustomerRateLimit();
            } catch (error) {
                errEl.textContent = error.message;
                errEl.style.display = 'block';
                return;
            }
            
            btnEl.disabled = true;
            btnEl.textContent = 'Signing in...';

            if (!window.DrTroySupabase) {
                errEl.textContent = 'Login service unavailable. Please refresh and try again.';
                errEl.style.display = 'block';
                btnEl.disabled = false;
                btnEl.textContent = 'Sign In';
                return;
            }

            const { data, error } = await window.DrTroySupabase.signIn(email, password);

            if (error) {
                const remaining = incrementCustomerAttempts();
                const baseMessage = error.message === 'Invalid login credentials'
                    ? 'Incorrect email or password.'
                    : error.message;
                    
                errEl.textContent = remaining > 0 
                    ? `${baseMessage} ${remaining} attempt(s) remaining.`
                    : `${baseMessage} Account locked for 15 minutes.`;
                    
                errEl.style.display = 'block';
                btnEl.disabled = false;
                btnEl.textContent = 'Sign In';
                return;
            }

            // Success ‚Äî clear rate limiting and proceed
            localStorage.removeItem('customerLoginAttempts');
            localStorage.removeItem('customerLastAttempt');
            
            if (data?.user) {
                currentSupabaseUser = data.user;
                await initAccountFromSupabase(data.user);
            }
        }

        // Update navigation based on authentication state
        function updateNavigation() {
            console.log('üîç NAV DEBUG - updateNavigation() called');
            console.log('üîç NAV DEBUG - currentAccount:', !!currentAccount);
            console.log('üîç NAV DEBUG - currentSupabaseUser:', !!currentSupabaseUser);
            
            const accountLink = document.getElementById('accountLink');
            if (!accountLink) {
                console.log('üîç NAV DEBUG - accountLink element not found');
                return;
            }

            const isAuthenticated = currentAccount || currentSupabaseUser;
            console.log('üîç NAV DEBUG - isAuthenticated:', isAuthenticated);
            
            if (isAuthenticated) {
                console.log('üîç NAV DEBUG - Setting logout button');
                accountLink.textContent = 'üö™ Logout';
                accountLink.onclick = function() { logout(); return false; };
                accountLink.href = '#';
            } else {
                console.log('üîç NAV DEBUG - Setting login button');
                accountLink.textContent = 'Log In';
                accountLink.onclick = null;
                accountLink.href = 'my-account.html';
            }
        }

        // Logout ‚Äî Supabase + legacy clear
        async function logout() {
            if (window.DrTroySupabase) {
                await window.DrTroySupabase.signOut();
            }
            localStorage.removeItem('drtroyAccount');
            localStorage.removeItem('userSession');
            localStorage.removeItem('troyadmin');
            localStorage.removeItem('currentAccountSection');
            window.location.href = 'home-preview.html';
        }

        // Restore the previously active section after page load
        function restoreActiveSection() {
            const savedSection = localStorage.getItem('currentAccountSection');
            if (savedSection) {
                console.log('üîß SECTION RESTORE - Restoring section:', savedSection);
                
                // Hide all sections first
                document.querySelectorAll('.content-section').forEach(section => {
                    section.classList.remove('active');
                });
                
                // Remove active class from all nav links
                document.querySelectorAll('.nav-link').forEach(link => {
                    link.classList.remove('active');
                });
                
                // Show the saved section
                const targetSection = document.getElementById(savedSection);
                const targetNavLink = document.querySelector(`[onclick="showSection('${savedSection}')"]`);
                
                if (targetSection && targetNavLink) {
                    targetSection.classList.add('active');
                    targetNavLink.classList.add('active');
                    console.log('üîß SECTION RESTORE - Successfully restored:', savedSection);
                } else {
                    // Fallback to overview if section doesn't exist
                    document.getElementById('overview').classList.add('active');
                    document.querySelector('[onclick="showSection(\'overview\')"]').classList.add('active');
                    console.log('üîß SECTION RESTORE - Fallback to overview');
                }
            }
        }

        // (checkLoginStatus is defined above in the Supabase auth init block)

        // Show account content
        function showAccountContent() {
            console.log('üîç DISPLAY DEBUG - showAccountContent() called');
            
            const loginDiv = document.getElementById('loginRequired');
            const contentDiv = document.getElementById('accountContent');
            
            console.log('üîç DISPLAY DEBUG - loginRequired element:', !!loginDiv);
            console.log('üîç DISPLAY DEBUG - accountContent element:', !!contentDiv);
            
            if (loginDiv) {
                console.log('üîç DISPLAY DEBUG - Hiding loginRequired div');
                loginDiv.style.display = 'none';
            }
            
            if (contentDiv) {
                console.log('üîç DISPLAY DEBUG - Showing accountContent div');
                contentDiv.style.display = 'block';
            }
            
            // Update navigation to show logout when account content is shown
            updateNavigation();
            
            console.log('üîç DISPLAY DEBUG - showAccountContent() complete');
        }

        // Show login required message
        function showLoginRequired() {
            document.getElementById('loginRequired').style.display = 'block';
            document.getElementById('accountContent').style.display = 'none';
            updateNavigation();
            
            // Don't auto-redirect - let user see debug info
            // setTimeout(() => {
            //     window.location.href = 'index.html';
            // }, 5000);
        }

        // Show debug information
        function showDebugInfo() {
            const debugDiv = document.getElementById('debugInfo');
            const debugContent = document.getElementById('debugContent');
            
            const accountData = localStorage.getItem('drtroyAccount');
            const sessionData = localStorage.getItem('userSession');
            
            let debugInfo = '=== My Account Debug Info ===\n\n';
            debugInfo += `Account data exists: ${!!accountData}\n`;
            debugInfo += `Session data exists: ${!!sessionData}\n\n`;
            
            if (accountData) {
                try {
                    const account = JSON.parse(accountData);
                    debugInfo += `Account email: ${account.email}\n`;
                    debugInfo += `Account firstName: ${account.firstName}\n`;
                    debugInfo += `Account id: ${account.id}\n\n`;
                } catch (e) {
                    debugInfo += `Account parsing error: ${e.message}\n\n`;
                }
            } else {
                debugInfo += 'Account data: null\n\n';
            }
            
            if (sessionData) {
                try {
                    const session = JSON.parse(sessionData);
                    debugInfo += `Session email: ${session.email}\n`;
                    debugInfo += `Session expires: ${new Date(session.expires)}\n`;
                    debugInfo += `Current time: ${new Date()}\n`;
                    debugInfo += `Session valid: ${session.expires > Date.now()}\n\n`;
                } catch (e) {
                    debugInfo += `Session parsing error: ${e.message}\n\n`;
                }
            } else {
                debugInfo += 'Session data: null\n\n';
            }
            
            debugInfo += `All localStorage keys:\n${Object.keys(localStorage).join(', ')}\n\n`;
            debugInfo += `Current URL: ${window.location.href}`;
            
            debugContent.textContent = debugInfo;
            debugDiv.style.display = debugDiv.style.display === 'none' ? 'block' : 'none';
        }

        // Force login for Troy (emergency bypass)
        function forceLogin() {
            const accountData = localStorage.getItem('drtroyAccount');
            
            if (!accountData) {
                // Create Troy's account if it doesn't exist
                const troyAccount = {
                    id: 'troy-drtroy-001',
                    firstName: 'Troy',
                    lastName: 'Hounshell',
                    email: 'troy@drtroy.com',
                    password: 'process.env.TEMP_PASSWORD || 'CHANGE_ME'',
                    discipline: 'PT',
                    licenseNumber: 'PT12345',
                    licenseState: 'TX',
                    phone: '806-577-6908',
                    createdAt: new Date().toISOString(),
                    superUser: true,
                    enrolledCourses: [],
                    courseProgress: {},
                    ethicsCCUs: {
                        jurisprudenceCompleted: false,
                        humanTrafficingCompleted: false,
                        totalEthicsCCUs: 0
                    },
                    externalCCUs: []
                };
                localStorage.setItem('drtroyAccount', JSON.stringify(troyAccount));
                console.log('üîß Created Troy\'s account');
            }
            
            // Create/refresh session
            const session = {
                userId: 'troy-drtroy-001',
                email: 'troy@drtroy.com',
                loginTime: Date.now(),
                expires: Date.now() + (30 * 24 * 60 * 60 * 1000) // 30 days for Troy
            };
            sessionStorage.setItem('userSession' // SECURITY: Using sessionStorage, not localStorage, JSON.stringify(session));
            
            console.log('üîß Force login executed for Troy');
            alert('Force login complete! Refreshing page...');
            location.reload();
        }

        // Emergency display override (for console use)
        function forceShowAccount() {
            console.log('üö® TROY FIX - Forcing account display');
            
            // Force hide login required
            const loginDiv = document.getElementById('loginRequired');
            if (loginDiv) {
                loginDiv.style.display = 'none';
                console.log('üö® TROY FIX - loginRequired hidden');
            }
            
            // Force show account content
            const contentDiv = document.getElementById('accountContent');
            if (contentDiv) {
                contentDiv.style.display = 'block';
                console.log('üö® TROY FIX - accountContent shown');
            }
            
            // Try to load account data
            const accountData = localStorage.getItem('drtroyAccount');
            if (accountData) {
                try {
                    currentAccount = JSON.parse(accountData);
                    setupEventListeners(); // Make sure event listeners are set up
                    loadAccountData();
                    console.log('üö® TROY FIX - Account data loaded and listeners set');
                } catch (e) {
                    console.error('üö® TROY FIX - Error loading account data:', e);
                }
            }
            
            console.log('üö® TROY FIX - Force display complete');
        }

        // Manual renewal calculation for testing
        function recalculateRenewal() {
            console.log('üîß MANUAL RENEWAL - Forcing renewal calculation');
            
            // Try to get fresh account data
            const accountData = localStorage.getItem('drtroyAccount');
            if (accountData) {
                try {
                    const freshAccount = JSON.parse(accountData);
                    if (freshAccount.licenseExpiration) {
                        currentAccount = freshAccount; // Update current account reference
                        
                        const expirationDate = new Date(freshAccount.licenseExpiration);
                        const today = new Date();
                        const daysUntil = Math.ceil((expirationDate - today) / (1000 * 60 * 60 * 24));
                        
                        console.log('üîß MANUAL RENEWAL - Fresh expiration data:', freshAccount.licenseExpiration);
                        console.log('üîß MANUAL RENEWAL - Expiration date object:', expirationDate);
                        console.log('üîß MANUAL RENEWAL - Today:', today);
                        console.log('üîß MANUAL RENEWAL - Days until:', daysUntil);
                        
                        const renewalElement = document.getElementById('daysUntilRenewal');
                        if (renewalElement) {
                            const displayText = daysUntil > 0 ? daysUntil : 'Expired';
                            renewalElement.textContent = displayText;
                            
                            // Save the calculated renewal for persistence
                            localStorage.setItem('lastCalculatedRenewal', JSON.stringify({
                                daysUntil: daysUntil,
                                displayText: displayText,
                                calculatedAt: new Date().toISOString(),
                                licenseExpiration: freshAccount.licenseExpiration
                            }));
                            
                            console.log('‚úÖ MANUAL RENEWAL - Display updated and saved:', displayText);
                        }
                        return;
                    }
                } catch (e) {
                    console.error('‚ùå MANUAL RENEWAL - Error parsing account data:', e);
                }
            }
            
            console.log('‚ùå No license expiration date found');
            
            // Try to restore last calculated renewal
            const lastRenewal = localStorage.getItem('lastCalculatedRenewal');
            if (lastRenewal) {
                try {
                    const renewalData = JSON.parse(lastRenewal);
                    const renewalElement = document.getElementById('daysUntilRenewal');
                    if (renewalElement) {
                        renewalElement.textContent = renewalData.displayText + ' (cached)';
                        console.log('üîÑ MANUAL RENEWAL - Restored cached value:', renewalData.displayText);
                    }
                } catch (e) {
                    console.error('‚ùå Error restoring cached renewal:', e);
                }
            } else {
                const renewalElement = document.getElementById('daysUntilRenewal');
                if (renewalElement) {
                    renewalElement.textContent = '--';
                }
            }
        }

        // Restore cached renewal on page load
        function restoreCachedRenewal() {
            const lastRenewal = localStorage.getItem('lastCalculatedRenewal');
            if (lastRenewal) {
                try {
                    const renewalData = JSON.parse(lastRenewal);
                    const renewalElement = document.getElementById('daysUntilRenewal');
                    if (renewalElement && renewalElement.textContent === '--') {
                        renewalElement.textContent = renewalData.displayText;
                        console.log('üîÑ PAGE LOAD - Restored cached renewal:', renewalData.displayText);
                    }
                } catch (e) {
                    console.error('‚ùå Error restoring cached renewal on load:', e);
                }
            }
        }

        // Make functions available globally for console access
        window.forceShowAccount = forceShowAccount;
        window.recalculateRenewal = recalculateRenewal;
        window.restoreActiveSection = restoreActiveSection;
        window.restoreCachedRenewal = restoreCachedRenewal;

        // Load account data into forms
        function loadAccountData() {
            if (!currentAccount) return;
            
            console.log('Loading account data...');
            
            // Check for super user status and show/hide nav
            const isSuperUser = currentAccount.superUser === true || 
                               localStorage.getItem('troyadmin') === 'true' ||
                               currentAccount.email === 'troy@drtroy.com';
            
            if (isSuperUser) {
                currentAccount.superUser = true;
                document.getElementById('superuser-nav').style.display = 'block';
            }

            // Ensure user has access to MSK course (until we have proper enrollment system)
            if (!currentAccount.enrolledCourses) {
                currentAccount.enrolledCourses = [];
            }
            if (!currentAccount.enrolledCourses.includes('pt-msk-001')) {
                currentAccount.enrolledCourses.push('pt-msk-001');
            }
            
            // Super users get access to ALL courses
            if (isSuperUser) {
                Object.keys(COURSE_DATABASE).forEach(courseId => {
                    if (!currentAccount.enrolledCourses.includes(courseId)) {
                        currentAccount.enrolledCourses.push(courseId);
                    }
                });
            }
            
            // Ensure course progress exists and MSK course is marked as accessible
            if (!currentAccount.courseProgress) {
                currentAccount.courseProgress = {};
            }
            if (!currentAccount.courseProgress['pt-msk-001']) {
                currentAccount.courseProgress['pt-msk-001'] = {
                    enrolledAt: new Date().toISOString(),
                    startedAt: null,
                    completed: false,
                    completedAt: null,
                    progress: 0
                };
            }
            
            // Save updated account data
            localStorage.setItem('drtroyAccount', JSON.stringify(currentAccount));
            
            // Personal information
            document.getElementById('firstName').value = currentAccount.firstName || '';
            document.getElementById('lastName').value = currentAccount.lastName || '';
            document.getElementById('email').value = currentAccount.email || '';
            document.getElementById('phone').value = currentAccount.phone || '';
            document.getElementById('address').value = currentAccount.address || '';
            document.getElementById('city').value = currentAccount.city || '';
            document.getElementById('state').value = currentAccount.state || '';
            document.getElementById('zipCode').value = currentAccount.zipCode || '';
            document.getElementById('discipline').value = currentAccount.discipline || '';
            document.getElementById('licenseNumber').value = currentAccount.licenseNumber || '';
            document.getElementById('licenseState').value = currentAccount.licenseState || '';
            document.getElementById('licenseExpiration').value = currentAccount.licenseExpiration || '';
            document.getElementById('renewalReminders').checked = currentAccount.licenseRenewalReminders !== false;
            
            // Load notification preferences
            if (currentAccount.notifications) {
                document.getElementById('emailCourseUpdates').checked = currentAccount.notifications.courseUpdates !== false;
                document.getElementById('emailLicenseReminders').checked = currentAccount.notifications.licenseReminders !== false;
                document.getElementById('emailPromotions').checked = currentAccount.notifications.promotions === true;
                document.getElementById('emailWeeklyDigest').checked = currentAccount.notifications.weeklyDigest === true;
            }
            
            // Load privacy settings
            if (currentAccount.privacy) {
                document.getElementById('dataAnalytics').checked = currentAccount.privacy.dataAnalytics !== false;
                document.getElementById('marketingConsent').checked = currentAccount.privacy.marketingConsent === true;
            }
            
            // Initialize ethics and external CCU data
            if (!currentAccount.ethicsCCUs) {
                currentAccount.ethicsCCUs = {
                    jurisprudenceCompleted: false,
                    humanTrafficingCompleted: false,
                    totalEthicsCCUs: 0
                };
            }
            if (!currentAccount.externalCCUs) {
                currentAccount.externalCCUs = [];
            }

            // Load ethics CCU checkboxes
            document.getElementById('jurisprudenceCompleted').checked = currentAccount.ethicsCCUs.jurisprudenceCompleted;
            document.getElementById('humanTrafficingCompleted').checked = currentAccount.ethicsCCUs.humanTrafficingCompleted;
            
            // Update ethics section based on discipline
            updateEthicsSection();
            
            // Update external CCU display
            updateExternalCCUDisplay();
            
            // Update CCU dashboard
            updateCCUDashboard();
            
            // Force renewal calculation after everything is loaded
            setTimeout(() => {
                if (currentAccount && currentAccount.licenseExpiration) {
                    console.log('üîß LOAD DATA - Final renewal calculation');
                    recalculateRenewal();
                }
            }, 100);
            
            // Update courses display
            updateCoursesDisplay();

            // Load Supabase certificates if available
            loadSupabaseCertificates();
        }

        // Course Information Database (Enhanced with individual pricing & course numbers)
        const COURSE_DATABASE = {
            // PT-Specific Course (Available Now)
            'pt-msk-001': {
                title: 'Comprehensive Musculoskeletal Evaluation',
                credits: 3,
                description: 'Evidence-based special tests and clinical reasoning for systematic MSK evaluation',
                url: 'courses/pt-msk-001-progressive.html',
                alternativeUrl: 'courses/pt-msk-001.html',
                status: 'available',
                courseNumber: 'DRTROY-PT-MSK-001-2024',
                individualPrice: 27.99, // Updated pricing
                provider: 'DrTroy Continuing Education',
                duration: '180 minutes',
                modules: 12,
                format: 'Interactive Progressive Learning',
                instructor: 'Troy Hounshell, PT, ScD'
            },
            // OT-Specific Course (Coming Soon)
            'ot-adl-001': {
                title: 'OT Evaluation and Assessment of ADLs',
                credits: 3,
                description: 'Comprehensive ADL assessment and intervention strategies',
                url: 'courses/ot-adl-001-progressive.html',
                status: 'available',
                courseNumber: 'DRTROY-OT-ADL-001-2024',
                individualPrice: 27.99,
                provider: 'DrTroy Continuing Education'
            },
            // Core Courses (Coming This Week)
            'core-mobility-001': {
                title: 'Comprehensive Mobility and Fall Prevention',
                credits: 3,
                description: 'Evidence-based mobility assessment and fall prevention strategies',
                url: 'courses/mobility-fall-001-progressive.html',
                status: 'available',
                courseNumber: 'DRTROY-MOBILITY-001-2024',
                individualPrice: 27.99,
                provider: 'DrTroy Continuing Education'
            },
            'core-balance-001': {
                title: 'Balance, Gait, and Vestibular Management',
                credits: 3,
                description: 'Assessment and treatment of balance and vestibular disorders',
                url: 'courses/balance-gait-001-progressive.html',
                status: 'available',
                courseNumber: 'DRTROY-BALANCE-001-2024',
                individualPrice: 27.99,
                provider: 'DrTroy Continuing Education'
            },
            'core-postsurg-001': {
                title: 'Post-Surgical and Therapeutic Exercise',
                credits: 3,
                description: 'Post-operative rehabilitation and exercise prescription',
                url: 'courses/post-surgical-001-progressive.html',
                status: 'available',
                courseNumber: 'DRTROY-EXERCISE-001-2024',
                individualPrice: 27.99,
                provider: 'DrTroy Continuing Education'
            },
            'core-geriatric-001': {
                title: 'Geriatric Care Across the Continuum',
                credits: 3,
                description: 'Comprehensive geriatric rehabilitation approaches',
                url: 'courses/geriatric-care-001-progressive.html',
                status: 'available',
                courseNumber: 'DRTROY-GERIATRIC-001-2024',
                individualPrice: 27.99,
                provider: 'DrTroy Continuing Education'
            },
            'core-doc-001': {
                title: 'Professional Documentation and Communication',
                credits: 3,
                description: 'Clinical documentation and professional communication skills',
                url: 'courses/documentation-001-progressive.html',
                status: 'available',
                courseNumber: 'DRTROY-DOC-001-2024',
                individualPrice: 27.99,
                provider: 'DrTroy Continuing Education'
            },
            'core-agents-001': {
                title: 'Physical Agents, Modalities, and Wound Care',
                credits: 3,
                description: 'Therapeutic modalities and wound care management',
                url: 'courses/physical-agents-001-progressive.html',
                status: 'available',
                courseNumber: 'DRTROY-MODALITIES-001-2024',
                individualPrice: 27.99,
                provider: 'DrTroy Continuing Education'
            },
            'core-neuro-001': {
                title: 'Neurological Rehabilitation',
                credits: 3,
                description: 'Evidence-based neurological rehabilitation techniques',
                url: 'courses/pt-neuro-001-progressive.html',
                status: 'available',
                courseNumber: 'DRTROY-NEURO-001-2024',
                individualPrice: 27.99,
                provider: 'DrTroy Continuing Education'
            },
            'core-infection-001': {
                title: 'Infection Control and Patient Safety',
                credits: 3,
                description: 'Infection prevention and patient safety protocols',
                url: 'courses/infection-control-001-progressive.html',
                status: 'available',
                courseNumber: 'DRTROY-INFECTION-001-2024',
                individualPrice: 27.99,
                provider: 'DrTroy Continuing Education'
            },
            'core-education-001': {
                title: 'Patient Education and Health Promotion',
                credits: 2,
                description: 'Patient education strategies and health promotion',
                url: 'courses/patient-education-001-progressive.html',
                status: 'available',
                courseNumber: 'DRTROY-EDUCATION-001-2024',
                individualPrice: 18.99,
                provider: 'DrTroy Continuing Education'
            },
            'core-tech-001': {
                title: 'Healthcare Technology and Electronic Records',
                credits: 2,
                description: 'Healthcare technology integration and electronic health records management',
                url: 'courses/healthcare-technology-001-progressive.html',
                status: 'available',
                courseNumber: 'DRTROY-TECH-001-2024',
                individualPrice: 18.99,
                provider: 'DrTroy Continuing Education'
            },
            'core-joint-001': {
                title: 'Considerations in Lower Extremity Joint Replacements',
                credits: 3,
                description: 'Evidence-based rehabilitation for lower extremity joint replacements',
                url: 'courses/joint-replacement-001-progressive.html',
                status: 'available',
                courseNumber: 'DRTROY-JOINT-001-2024',
                individualPrice: 27.99,
                provider: 'DrTroy Continuing Education'
            }
        };

        // Individual Course Sales Settings
        const INDIVIDUAL_SALES_CONFIG = {
            enabled: true, // Individual sales now enabled
            newAccountDiscount: 0, // No discount on individual courses (bundles only get $10 discount)
            bulkDiscountThreshold: 3, // Buy 3+ individual courses for discount
            bulkDiscountPercent: 15 // 15% off when buying 3+ individual courses
        };

        // Course content URL mapping (fallback for Supabase-only enrollments)
        const COURSE_CONTENT_URLS = {
            'pt-msk-001': 'courses/pt-msk-001-progressive.html',
            'core-mobility-001': 'courses/mobility-fall-001-progressive.html',
            'core-balance-001': 'courses/balance-gait-001-progressive.html',
            'core-postsurg-001': 'courses/post-surgical-001-progressive.html',
            'core-geriatric-001': 'courses/geriatric-care-001-progressive.html',
            'core-doc-001': 'courses/documentation-001-progressive.html',
            'core-agents-001': 'courses/physical-agents-001-progressive.html',
            'core-neuro-001': 'courses/pt-neuro-001-progressive.html',
            'core-infection-001': 'courses/infection-control-001-progressive.html',
            'core-education-001': 'courses/patient-education-001-progressive.html',
            'core-tech-001': 'courses/healthcare-technology-001-progressive.html',
            'ot-adl-001': 'courses/ot-adl-001-progressive.html',
            'core-joint-001': 'courses/joint-replacement-001-progressive.html'
        };

        // Update CCU dashboard and course display
        function updateCCUDashboard() {
            if (!currentAccount) return;
            
            const discipline = currentAccount.discipline || 'PT';
            const ccuRequirements = {
                'PT': 30,
                'PTA': 20,
                'OT': 24,
                'COTA': 24
            };
            
            const required = ccuRequirements[discipline] || 30;
            
            // Calculate earned CCUs from completed courses
            let courseCCUs = 0;
            let completedCount = 0;
            
            if (currentAccount.courseProgress) {
                Object.keys(currentAccount.courseProgress).forEach(courseId => {
                    if (currentAccount.courseProgress[courseId].completed && COURSE_DATABASE[courseId]) {
                        courseCCUs += COURSE_DATABASE[courseId].credits;
                        completedCount++;
                    }
                });
            }
            
            // Calculate ethics/human trafficking CCUs
            const ethicsCCUs = currentAccount.ethicsCCUs ? currentAccount.ethicsCCUs.totalEthicsCCUs : 0;
            
            // Calculate external CCUs
            const externalCCUsTotal = currentAccount.externalCCUs ? 
                currentAccount.externalCCUs.reduce((sum, entry) => sum + entry.hours, 0) : 0;
            
            // Calculate totals
            const totalEarned = courseCCUs + ethicsCCUs + externalCCUsTotal;
            const remaining = Math.max(0, required - totalEarned);
            const percentage = Math.min(100, (totalEarned / required) * 100);
            
            // Update individual displays
            document.getElementById('ccuRequired').textContent = required;
            document.getElementById('ccuEarned').textContent = courseCCUs;
            document.getElementById('ethicsCCUs').textContent = ethicsCCUs;
            document.getElementById('externalCCUs').textContent = externalCCUsTotal;
            document.getElementById('totalCCUs').textContent = totalEarned;
            document.getElementById('ccuRemaining').textContent = remaining;
            document.getElementById('coursesCompleted').textContent = completedCount;
            
            // Update legacy displays for compatibility
            document.getElementById('requiredCCUs').textContent = required;
            document.getElementById('earnedCCUs').textContent = courseCCUs;
            
            // Update summary displays
            document.getElementById('summaryCourseCCUs').textContent = courseCCUs;
            document.getElementById('summaryEthicsCCUs').textContent = ethicsCCUs;
            document.getElementById('summaryExternalCCUs').textContent = externalCCUsTotal;
            document.getElementById('summaryTotalCCUs').textContent = totalEarned;
            document.getElementById('summaryRequiredCCUs').textContent = required;
            document.getElementById('summaryRemainingCCUs').textContent = remaining;
            
            // Update progress bars (based on total earned)
            document.getElementById('progressFill').style.width = percentage + '%';
            document.getElementById('ccuProgressFill').style.width = percentage + '%';
            document.getElementById('progressText').textContent = `${totalEarned} of ${required} CCUs completed (${Math.round(percentage)}%)`;
            document.getElementById('ccuProgressText').textContent = `${totalEarned} of ${required} CCUs completed (${Math.round(percentage)}%)`;
            
            // Calculate days until renewal if expiration date is set
            console.log('üîç RENEWAL DEBUG - License expiration:', currentAccount.licenseExpiration);
            if (currentAccount.licenseExpiration) {
                const expirationDate = new Date(currentAccount.licenseExpiration);
                const today = new Date();
                const daysUntil = Math.ceil((expirationDate - today) / (1000 * 60 * 60 * 24));
                
                console.log('üîç RENEWAL DEBUG - Expiration date:', expirationDate);
                console.log('üîç RENEWAL DEBUG - Today:', today);
                console.log('üîç RENEWAL DEBUG - Days until renewal:', daysUntil);
                
                const renewalElement = document.getElementById('daysUntilRenewal');
                if (renewalElement) {
                    renewalElement.textContent = daysUntil > 0 ? daysUntil : 'Expired';
                    console.log('üîç RENEWAL DEBUG - Updated renewal display:', renewalElement.textContent);
                }
            } else {
                console.log('üîç RENEWAL DEBUG - No license expiration date set');
                const renewalElement = document.getElementById('daysUntilRenewal');
                if (renewalElement) {
                    renewalElement.textContent = '--';
                }
            }
            
            // Update courses display
            updateCoursesDisplay();
        }

        // Update the My Courses section
        function updateCoursesDisplay() {
            if (!currentAccount) return;

            const coursesList = document.getElementById('coursesList');

            // Build combined list: local COURSE_DATABASE IDs + Supabase enrollments
            const localEnrolled = currentAccount.enrolledCourses || [];

            // Build Supabase course cards (UUID-based, not in COURSE_DATABASE)
            const supabaseCards = [];
            if (currentAccount._supabaseEnrollments && currentAccount._supabaseEnrollments.length > 0) {
                currentAccount._supabaseEnrollments.forEach(enrollment => {
                    if (!enrollment.courses) return;
                    const c = enrollment.courses;
                    // Only add if not already in local COURSE_DATABASE
                    if (COURSE_DATABASE[enrollment.course_id]) return;
                    const prog = enrollment.course_progress?.[0] || {};
                    const isCompleted = prog.status === 'completed';
                    const inProgress  = prog.status === 'in_progress';
                    let statusBadge = isCompleted ? '<span class="status-badge completed">‚úì Completed</span>'
                                    : inProgress  ? '<span class="status-badge in-progress">In Progress</span>'
                                    : '<span class="status-badge available">Available</span>';
                    // Resolve course URL from COURSE_DATABASE or build from course_id
                    const courseUrl = COURSE_DATABASE[enrollment.course_id]?.url || COURSE_CONTENT_URLS[enrollment.course_id] || `courses/${enrollment.course_id}-progressive.html`;
                    let actionLabel = inProgress ? 'Continue' : 'Start Course';
                    let actionBtn = `<a href="#" class="btn btn-primary">${actionLabel}</a>`;
                    if (isCompleted) actionBtn = `<button class="btn btn-secondary" onclick="viewCertificate('${enrollment.course_id}')">View Certificate</button>`;
                    supabaseCards.push(`
                        <div class="course-card">
                            <div class="course-header">
                                <h3>${c.title}</h3>
                                ${statusBadge}
                            </div>
                            <p class="course-description">${c.description || ''}</p>
                            <div class="course-details">
                                <div class="course-credits"><strong>${c.ceu_hours || '?'} CCUs</strong></div>
                            </div>
                            <div class="course-actions">${actionBtn}</div>
                        </div>
                    `);
                });
            }

            // If nothing enrolled at all
            if (localEnrolled.length === 0 && supabaseCards.length === 0) {
                coursesList.innerHTML = `
                    <div style="text-align: center; color: var(--gray-600); padding: 3rem;">
                        <h3>No Courses Yet</h3>
                        <p>You haven't enrolled in any courses yet.</p>
                        <a href="home-preview.html#packages" class="btn btn-primary" style="margin-top: 1rem;">üìö Browse Packages</a>
                    </div>
                `;
                return;
            }

            let coursesHTML = '<div class="courses-grid">';
            // Add Supabase-only cards first
            supabaseCards.forEach(card => { coursesHTML += card; });

            const enrolledCourses = localEnrolled.filter(id => !currentAccount._supabaseEnrollments?.find(e => e.course_id === id));
            enrolledCourses.forEach(courseId => {
                const course = COURSE_DATABASE[courseId];
                if (!course) return;
                
                const progress = currentAccount.courseProgress?.[courseId];
                const isCompleted = progress?.completed || false;
                const isStarted = progress?.startedAt || false;
                
                let statusBadge = '';
                let actionButton = '';
                
                if (course.status === 'coming-soon') {
                    statusBadge = '<span class="status-badge coming-soon">Coming Soon</span>';
                    actionButton = '<button class="btn btn-secondary" disabled>Available Soon</button>';
                } else if (isCompleted) {
                    statusBadge = '<span class="status-badge completed">‚úì Completed</span>';
                    actionButton = `<a href="#" class="btn btn-secondary">Review Course</a>`;
                } else if (isStarted) {
                    statusBadge = '<span class="status-badge in-progress">In Progress</span>';
                    actionButton = `<a href="#" class="btn btn-primary">Continue</a>`;
                } else {
                    statusBadge = '<span class="status-badge available">Available</span>';
                    actionButton = `<a href="#" class="btn btn-primary">Start Course</a>`;
                }
                
                // Individual pricing button (hidden unless enabled)
                let individualPriceButton = '';
                if (INDIVIDUAL_SALES_CONFIG.enabled && course.status === 'available') {
                    const discountPrice = currentAccount?.hasDiscount ? course.individualPrice - INDIVIDUAL_SALES_CONFIG.newAccountDiscount : course.individualPrice;
                    individualPriceButton = `
                        <button class="btn btn-outline" onclick="purchaseIndividualCourse('${courseId}')">
                            Buy Individual - $${discountPrice}
                        </button>
                    `;
                }

                coursesHTML += `
                    <div class="course-card">
                        <div class="course-header">
                            <h3>${course.title}</h3>
                            ${statusBadge}
                        </div>
                        <p class="course-description">${course.description}</p>
                        <div class="course-details">
                            <div class="course-credits"><strong>${course.credits} CCUs</strong> ‚Ä¢ ${course.duration || '180 minutes'}</div>
                            ${course.modules ? `<div class="course-format">${course.modules} Interactive Modules ‚Ä¢ ${course.format || 'Progressive Learning'}</div>` : ''}
                            ${course.instructor ? `<div class="course-instructor">Instructor: ${course.instructor}</div>` : ''}
                            <div class="course-approval">Course #: ${course.courseNumber}</div>
                        </div>
                        <div class="course-actions">
                            ${actionButton}
                            ${course.alternativeUrl ? `<a href="#" data-dynamic-link="true" class="btn btn-secondary">Original Version</a>` : ''}
                            ${individualPriceButton}
                        </div>
                    </div>
                `;
            });
            
            coursesHTML += '</div>';
            coursesList.innerHTML = coursesHTML;
        }

        // Individual Course Purchase (Hidden until enabled)
        function purchaseIndividualCourse(courseId) {
            if (!INDIVIDUAL_SALES_CONFIG.enabled) {
                showAlert('Individual course sales are not yet available. Please purchase a package.', 'info');
                return;
            }

            const course = COURSE_DATABASE[courseId];
            if (!course) {
                showAlert('Course not found.', 'danger');
                return;
            }

            const basePrice = course.individualPrice;
            const discountAmount = currentAccount?.hasDiscount ? INDIVIDUAL_SALES_CONFIG.newAccountDiscount : 0;
            const finalPrice = basePrice - discountAmount;

            const confirmMessage = `
                <div style="text-align: center;">
                    <h3>Purchase Individual Course</h3>
                    <div class="course-purchase-details">
                        <p><strong>${course.title}</strong></p>
                        <p>${course.credits} CCUs</p>
                        <p>Course #: ${course.courseNumber}</p>
                        <div class="price-breakdown">
                            <div>Course Price: $${basePrice}</div>
                            ${discountAmount > 0 ? `<div>New Account Discount: -$${discountAmount}</div>` : ''}
                            <div><strong>Total: $${finalPrice}</strong></div>
                        </div>
                    </div>
                </div>
            `;

            if (confirm(confirmMessage)) {
                // Store individual course purchase data
                localStorage.setItem('selectedCourse', JSON.stringify({
                    courseId: courseId,
                    title: course.title,
                    price: finalPrice,
                    credits: course.credits
                }));
                
                // Redirect to individual course checkout
                window.location.href = 'checkout.html?type=individual&course=' + courseId;
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            // Personal info form
            document.getElementById('personalInfoForm').addEventListener('submit', function(e) {
                e.preventDefault();
                savePersonalInfo();
            });
            
            // Password form
            document.getElementById('passwordForm').addEventListener('submit', function(e) {
                e.preventDefault();
                changePassword();
            });
            
            // Auto-uppercase state fields
            document.getElementById('state').addEventListener('input', function() {
                this.value = this.value.toUpperCase();
            });
            
            document.getElementById('licenseState').addEventListener('input', function() {
                this.value = this.value.toUpperCase();
            });
        }

        // Navigation functions
        function showSection(sectionId) {
            // Hide all sections
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Remove active class from all nav links
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            
            // Save the current section to localStorage for persistence
            localStorage.setItem('currentAccountSection', sectionId);
            
            // Show selected section
            document.getElementById(sectionId).classList.add('active');
            
            // Add active class to clicked nav link
            event.target.classList.add('active');

            // Load section-specific data
            if (sectionId === 'credits') loadCreditsSection();
        }

        // Save personal information ‚Äî localStorage + Supabase sync
        async function savePersonalInfo() {
            if (!currentAccount) return;

            console.log('Saving personal information...');

            // Update in-memory account
            currentAccount.firstName       = document.getElementById('firstName').value;
            currentAccount.lastName        = document.getElementById('lastName').value;
            currentAccount.email           = document.getElementById('email').value;
            currentAccount.phone           = document.getElementById('phone').value;
            currentAccount.address         = document.getElementById('address').value;
            currentAccount.city            = document.getElementById('city').value;
            currentAccount.state           = document.getElementById('state').value.toUpperCase();
            currentAccount.zipCode         = document.getElementById('zipCode').value;
            currentAccount.licenseNumber   = document.getElementById('licenseNumber').value;
            currentAccount.licenseState    = document.getElementById('licenseState').value.toUpperCase();
            currentAccount.licenseExpiration = document.getElementById('licenseExpiration').value;
            currentAccount.licenseRenewalReminders = document.getElementById('renewalReminders').checked;
            currentAccount.updatedAt       = new Date().toISOString();

            // Persist to localStorage
            localStorage.setItem('drtroyAccount', JSON.stringify(currentAccount));
            localStorage.setItem('customerName', `${currentAccount.firstName} ${currentAccount.lastName}`);
            localStorage.setItem('customerEmail', currentAccount.email);

            // Sync to Supabase profiles table if authenticated
            if (window.DrTroySupabase && currentSupabaseUser) {
                const { error } = await window.DrTroySupabase.updateProfile(currentSupabaseUser.id, {
                    first_name:     currentAccount.firstName,
                    last_name:      currentAccount.lastName,
                    profession:     currentAccount.discipline,
                    license_number: currentAccount.licenseNumber,
                    state:          currentAccount.licenseState
                });
                if (error) console.warn('Supabase profile sync warning:', error.message);
                else console.log('‚úÖ Profile synced to Supabase');
            }

            showAlert('Personal information updated successfully!', 'success');
            updateCCUDashboard();
        }

        // Change password ‚Äî Supabase auth (no plain-text password in localStorage)
        async function changePassword() {
            const newPassword    = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (newPassword !== confirmPassword) {
                showAlert('New passwords do not match.', 'danger');
                return;
            }
            if (newPassword.length < 8) {
                showAlert('Password must be at least 8 characters.', 'danger');
                return;
            }

            // Supabase password update
            if (window.DrTroySupabase) {
                const { error } = await window.DrTroySupabase.updatePassword(newPassword);
                if (error) {
                    showAlert('Password update failed: ' + error.message, 'danger');
                    return;
                }
                document.getElementById('passwordForm').reset();
                showAlert('Password changed successfully!', 'success');
                return;
            }

            // Legacy fallback
            if (currentAccount) {
                currentAccount.password  = newPassword;
                currentAccount.updatedAt = new Date().toISOString();
                localStorage.setItem('drtroyAccount', JSON.stringify(currentAccount));
                document.getElementById('passwordForm').reset();
                showAlert('Password changed successfully!', 'success');
            }
        }

        // Save notification preferences
        function saveNotificationPreferences() {
            if (!currentAccount) return;
            
            currentAccount.notifications = {
                courseUpdates: document.getElementById('emailCourseUpdates').checked,
                licenseReminders: document.getElementById('emailLicenseReminders').checked,
                promotions: document.getElementById('emailPromotions').checked,
                weeklyDigest: document.getElementById('emailWeeklyDigest').checked
            };
            
            currentAccount.updatedAt = new Date().toISOString();
            localStorage.setItem('drtroyAccount', JSON.stringify(currentAccount));
            
            showAlert('Notification preferences saved!', 'success');
        }

        // Save privacy settings
        async function savePrivacySettings() {
            if (!currentAccount) return;

            const marketingConsent = document.getElementById('marketingConsent').checked;
            const dataAnalytics    = document.getElementById('dataAnalytics').checked;

            currentAccount.privacy = { dataAnalytics, marketingConsent };
            currentAccount.updatedAt = new Date().toISOString();
            localStorage.setItem('drtroyAccount', JSON.stringify(currentAccount));

            // Sync marketing consent to Supabase profile
            try {
                if (window.DrTroySupabase && currentAccount.id) {
                    const sb = window.DrTroySupabase.getClient ? window.DrTroySupabase.getClient() : null;
                    try {
                        if (sb) await sb.from('profiles').update({ marketing_consent: marketingConsent }).eq('id', currentAccount.id);
                    } catch (dbError) {
                        console.error('Database error:', dbError);
                    }
                }
            } catch(e) { /* non-blocking */ }

            showAlert('Privacy settings saved!', 'success');
        }

        // Export account data
        function exportAccountData() {
            if (!currentAccount) return;
            
            const exportData = {
                ...currentAccount,
                exportDate: new Date().toISOString(),
                dataVersion: '2.0'
            };
            
            const dataBlob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `drtroy-account-${currentAccount.firstName}-${Date.now()}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            showAlert('Account data exported successfully!', 'success');
        }

        // Request account deletion
        function requestAccountDeletion() {
            if (confirm('‚ö†Ô∏è Are you sure you want to delete your account?\n\nThis action cannot be undone and will permanently remove:\n‚Ä¢ All your personal information\n‚Ä¢ Course progress and certificates\n‚Ä¢ Account settings and preferences')) {
                if (confirm('üö® FINAL WARNING: This will permanently delete everything.\n\nType "DELETE" in the next prompt to confirm.')) {
                    const confirmation = prompt('Type "DELETE" to permanently delete your account:');
                    if (confirmation === 'DELETE') {
                        // Clear all data
                        localStorage.removeItem('drtroyAccount');
                        localStorage.removeItem('userSession');
                        localStorage.removeItem('customerName');
                        localStorage.removeItem('customerEmail');
                        localStorage.removeItem('customerDiscipline');
                        
                        alert('‚úÖ Account deleted successfully. You will be redirected to the homepage.');
                        window.location.href = 'home-preview.html';
                    } else {
                        alert('Account deletion cancelled - confirmation text did not match.');
                    }
                }
            }
        }

        // Print CCU transcript
        function printCCUTranscript() {
            if (!currentAccount) return;
            
            const printWindow = window.open('', '_blank');
            printWindow./* SECURITY: document.write() removed */ console.log(`
                <html>
                <head>
                    <title>CCU Transcript - ${currentAccount.firstName} ${currentAccount.lastName}</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 2rem; }
                        .header { border-bottom: 2px solid #1a365d; padding-bottom: 1rem; margin-bottom: 2rem; }
                        .info-table { width: 100%; border-collapse: collapse; margin-bottom: 2rem; }
                        .info-table td { padding: 0.5rem; border-bottom: 1px solid #e5e7eb; }
                        .course-table { width: 100%; border-collapse: collapse; }
                        .course-table th, .course-table td { padding: 0.8rem; border: 1px solid #d1d5db; text-align: left; }
                        .course-table th { background: #f3f4f6; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>Continuing Education Transcript</h1>
                        <h2>DrTroy.com Professional Development</h2>
                    </div>
                    <table class="info-table">
                        <tr><td><strong>Name:</strong></td><td>${currentAccount.firstName} ${currentAccount.lastName}</td></tr>
                        <tr><td><strong>Email:</strong></td><td>${currentAccount.email}</td></tr>
                        <tr><td><strong>License Number:</strong></td><td>${currentAccount.licenseNumber || 'Not provided'}</td></tr>
                        <tr><td><strong>License State:</strong></td><td>${currentAccount.licenseState || 'Not provided'}</td></tr>
                        <tr><td><strong>Discipline:</strong></td><td>${currentAccount.discipline || 'Not provided'}</td></tr>
                        <tr><td><strong>License Expiration:</strong></td><td>${currentAccount.licenseExpiration ? new Date(currentAccount.licenseExpiration).toLocaleDateString() : 'Not provided'}</td></tr>
                        <tr><td><strong>Transcript Generated:</strong></td><td>${new Date().toLocaleDateString()}</td></tr>
                    </table>
                    <h3>Course Completion History</h3>
                    <table class="course-table">
                        <thead>
                            <tr>
                                <th>Course Title</th>
                                <th>Completion Date</th>
                                <th>CCUs Earned</th>
                                <th>Certificate ID</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td colspan="4" style="text-align: center; padding: 2rem; color: #6b7280;">No completed courses on record</td></tr>
                        </tbody>
                    </table>
                    <div style="margin-top: 3rem; font-size: 0.9rem; color: #6b7280;">
                        <p>This transcript is generated from DrTroy.com and reflects courses completed through our platform.</p>
                        <p>For verification purposes, contact: troyh@texastherapypros.com</p>
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        // logout() is defined above in Supabase auth init block

        // Emergency account function removed per user request

        // ===============================
        // CCU MANAGEMENT FUNCTIONS
        // ===============================

        // Update ethics section based on discipline
        function updateEthicsSection() {
            if (!currentAccount || !currentAccount.discipline) return;
            
            const discipline = currentAccount.discipline;
            const ethicsSection = document.getElementById('ethicsSection');
            const ethicsCard = document.getElementById('ethicsCard');
            const ethicsCardTitle = document.getElementById('ethicsCardTitle');
            const ethicsSectionTitle = document.getElementById('ethicsSectionTitle');
            const ethicsDescription = document.getElementById('ethicsDescription');
            const jurisprudenceLabel = document.getElementById('jurisprudenceLabel');
            const jurisprudenceCheckbox = document.getElementById('jurisprudenceCompleted');
            
            if (discipline === 'PT' || discipline === 'PTA') {
                // PT/PTA: Both Jurisprudence Exam and Human Trafficking
                ethicsCardTitle.textContent = 'Ethics & Human Trafficking';
                ethicsSectionTitle.textContent = 'Ethics & Human Trafficking Requirements';
                ethicsDescription.textContent = 'For PT/PTA: Complete Jurisprudence Exam + approved Human Trafficking course (3 CCUs total)';
                jurisprudenceLabel.textContent = 'Jurisprudence Exam Completed (2 CCUs)';
                jurisprudenceCheckbox.style.display = 'inline-block';
                jurisprudenceCheckbox.parentElement.style.display = 'block';
                document.getElementById('summaryEthics').textContent = 'Ethics/Trafficking: ';
            } else if (discipline === 'OT' || discipline === 'COTA') {
                // OT/COTA: Only Human Trafficking
                ethicsCardTitle.textContent = 'Human Trafficking';
                ethicsSectionTitle.textContent = 'Human Trafficking Requirements';
                ethicsDescription.textContent = 'For OT/COTA: Complete approved Human Trafficking course (1 CCU)';
                jurisprudenceCheckbox.style.display = 'none';
                jurisprudenceCheckbox.parentElement.style.display = 'none';
                jurisprudenceCheckbox.checked = false; // Always unchecked for OT/COTA
                document.getElementById('summaryEthics').textContent = 'Trafficking: ';
            }
            
            updateEthicsCCUs();
        }

        // Update ethics CCUs based on checkboxes
        function updateEthicsCCUs() {
            if (!currentAccount) return;
            
            const discipline = currentAccount.discipline;
            const jurisprudenceCompleted = document.getElementById('jurisprudenceCompleted').checked;
            const humanTrafficingCompleted = document.getElementById('humanTrafficingCompleted').checked;
            
            let totalEthicsCCUs = 0;
            
            if (discipline === 'PT' || discipline === 'PTA') {
                // PT/PTA: 2 CCUs for Jurisprudence + 1 CCU for Human Trafficking
                if (jurisprudenceCompleted) totalEthicsCCUs += 2;
                if (humanTrafficingCompleted) totalEthicsCCUs += 1;
            } else if (discipline === 'OT' || discipline === 'COTA') {
                // OT/COTA: Only 1 CCU for Human Trafficking
                if (humanTrafficingCompleted) totalEthicsCCUs += 1;
            }
            
            currentAccount.ethicsCCUs = {
                jurisprudenceCompleted: jurisprudenceCompleted,
                humanTrafficingCompleted: humanTrafficingCompleted,
                totalEthicsCCUs: totalEthicsCCUs
            };
            
            // Update display
            document.getElementById('ethicsCCUs').textContent = totalEthicsCCUs;
            updateCCUDashboard();
        }

        // Save ethics CCUs
        function saveEthicsCCUs() {
            if (!currentAccount) return;
            
            updateEthicsCCUs();
            currentAccount.updatedAt = new Date().toISOString();
            localStorage.setItem('drtroyAccount', JSON.stringify(currentAccount));
            
            const discipline = currentAccount.discipline;
            const total = currentAccount.ethicsCCUs.totalEthicsCCUs;
            
            if (discipline === 'PT' || discipline === 'PTA') {
                showAlert(`‚úÖ Ethics & Human Trafficking CCUs saved: ${total}/3 CCUs`, 'success');
            } else {
                showAlert(`‚úÖ Human Trafficking CCUs saved: ${total}/1 CCU`, 'success');
            }
        }

        // Add external CCUs
        function addExternalCCUs() {
            if (!currentAccount) return;
            
            const hoursInput = document.getElementById('externalCCUHours');
            const descriptionInput = document.getElementById('externalCCUDescription');
            
            const hours = parseFloat(hoursInput.value);
            const description = descriptionInput.value.trim();
            
            if (!hours || hours <= 0) {
                showAlert('Please enter a valid number of CCU hours', 'danger');
                return;
            }
            
            if (!description) {
                showAlert('Please enter a description for these CCUs', 'danger');
                return;
            }
            
            // Add to external CCUs array
            const newEntry = {
                id: Date.now(),
                hours: hours,
                description: description,
                dateAdded: new Date().toISOString()
            };
            
            currentAccount.externalCCUs.push(newEntry);
            currentAccount.updatedAt = new Date().toISOString();
            localStorage.setItem('drtroyAccount', JSON.stringify(currentAccount));
            
            // Clear form
            hoursInput.value = '';
            descriptionInput.value = '';
            
            // Update displays
            updateExternalCCUDisplay();
            updateCCUDashboard();
            
            showAlert(`‚úÖ Added ${hours} external CCUs: ${description}`, 'success');
        }

        // Update external CCU display
        function updateExternalCCUDisplay() {
            if (!currentAccount || !currentAccount.externalCCUs) return;
            
            const listContainer = document.getElementById('externalCCUList');
            const externalCCUs = currentAccount.externalCCUs;
            
            if (externalCCUs.length === 0) {
                listContainer.innerHTML = `
                    <div style="text-align: center; color: var(--gray-600); padding: 1rem; font-style: italic;">
                        No external CCUs added yet
                    </div>
                `;
                return;
            }
            
            const totalExternal = externalCCUs.reduce((sum, entry) => sum + entry.hours, 0);
            
            listContainer.innerHTML = `
                <h5 style="margin-bottom: 0.5rem;">External CCU Entries (${totalExternal} total hours):</h5>
                ${externalCCUs.map(entry => `
                    <div style="background: white; border: 1px solid var(--gray-200); border-radius: 4px; padding: 0.75rem; margin-bottom: 0.5rem; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong>${entry.hours} CCU${entry.hours !== 1 ? 's' : ''}</strong> - ${entry.description}
                            <div style="font-size: 0.8rem; color: var(--gray-600);">Added: ${new Date(entry.dateAdded).toLocaleDateString()}</div>
                        </div>
                        <button onclick="removeExternalCCU(${entry.id})" class="btn btn-danger" style="font-size: 0.8rem; padding: 0.25rem 0.5rem;">üóëÔ∏è Remove</button>
                    </div>
                `)).join('')}
            `;
            
            // Update external CCUs display
            document.getElementById('externalCCUs').textContent = totalExternal;
        }

        // Remove external CCU entry
        function removeExternalCCU(entryId) {
            if (!currentAccount || !confirm('Remove this external CCU entry?')) return;
            
            const entry = currentAccount.externalCCUs.find(e => e.id === entryId);
            if (!entry) return;
            
            currentAccount.externalCCUs = currentAccount.externalCCUs.filter(e => e.id !== entryId);
            currentAccount.updatedAt = new Date().toISOString();
            localStorage.setItem('drtroyAccount', JSON.stringify(currentAccount));
            
            updateExternalCCUDisplay();
            updateCCUDashboard();
            
            showAlert(`üóëÔ∏è Removed ${entry.hours} CCUs: ${entry.description}`, 'info');
        }

        // ===============================
        // SUPER USER FUNCTIONS
        // ===============================

        // Enroll in all available courses
        function enrollAllCourses() {
            if (!currentAccount) return;
            
            const allCourseIds = Object.keys(COURSE_DATABASE);
            const newEnrollments = [];
            
            allCourseIds.forEach(courseId => {
                if (!currentAccount.enrolledCourses.includes(courseId)) {
                    currentAccount.enrolledCourses.push(courseId);
                    newEnrollments.push(COURSE_DATABASE[courseId].title);
                    
                    // Add course progress entry
                    if (!currentAccount.courseProgress[courseId]) {
                        currentAccount.courseProgress[courseId] = {
                            enrolledAt: new Date().toISOString(),
                            startedAt: null,
                            completed: false,
                            completedAt: null,
                            progress: 0
                        };
                    }
                }
            });
            
            localStorage.setItem('drtroyAccount', JSON.stringify(currentAccount));
            updateCoursesDisplay();
            updateCCUDashboard();
            
            if (newEnrollments.length > 0) {
                showAlert(`‚úÖ Enrolled in ${newEnrollments.length} new courses: ${newEnrollments.join(', ')}`, 'success');
            } else {
                showAlert('‚ÑπÔ∏è Already enrolled in all available courses', 'info');
            }
        }

        // Show all course access details
        function showAllCoursesAccess() {
            const allCourses = Object.keys(COURSE_DATABASE).map(courseId => {
                const course = COURSE_DATABASE[courseId];
                const enrolled = currentAccount.enrolledCourses?.includes(courseId) ? '‚úÖ' : '‚ùå';
                const progress = currentAccount.courseProgress?.[courseId];
                const status = progress?.completed ? 'Completed' : progress?.startedAt ? 'In Progress' : 'Not Started';
                
                return `${enrolled} ${course.title} (${course.credits} CCUs) - ${status}`;
            }).join('\n');
            
            alert(`Course Access Status:\n\n${allCourses}\n\n‚úÖ = Enrolled\n‚ùå = Not Enrolled`);
        }

        // Set admin mode for courses
        function setAdminMode() {
            localStorage.setItem('troyadmin', 'true');
            showAlert('üõ°Ô∏è Admin mode activated! You now have admin privileges in all courses.', 'success');
        }

        // View detailed progress data
        function viewDetailedProgress() {
            const progressDiv = document.getElementById('detailed-progress');
            const dataDisplay = document.getElementById('progress-data-display');
            
            const progressData = {
                enrolledCourses: currentAccount.enrolledCourses || [],
                courseProgress: currentAccount.courseProgress || {},
                superUser: currentAccount.superUser || false,
                lastUpdated: currentAccount.updatedAt || 'Never'
            };
            
            dataDisplay.textContent = JSON.stringify(progressData, null, 2);
            progressDiv.style.display = progressDiv.style.display === 'none' ? 'block' : 'none';
        }

        // Reset specific course
        function resetSpecificCourse() {
            if (!currentAccount.enrolledCourses || currentAccount.enrolledCourses.length === 0) {
                showAlert('No enrolled courses to reset', 'info');
                return;
            }
            
            const courseList = currentAccount.enrolledCourses.map(courseId => {
                const course = COURSE_DATABASE[courseId];
                return `${courseId}: ${course?.title || 'Unknown Course'}`;
            }).join('\n');
            
            const selectedCourse = prompt(`Enter Course ID to reset:\n\n${courseList}\n\nCourse ID:`);
            
            if (selectedCourse && currentAccount.enrolledCourses.includes(selectedCourse)) {
                // Reset course progress
                if (currentAccount.courseProgress[selectedCourse]) {
                    currentAccount.courseProgress[selectedCourse] = {
                        enrolledAt: currentAccount.courseProgress[selectedCourse].enrolledAt,
                        startedAt: null,
                        completed: false,
                        completedAt: null,
                        progress: 0
                    };
                }
                
                // Clear course-specific localStorage
                localStorage.removeItem(`${selectedCourse}-progress`);
                localStorage.removeItem(`${selectedCourse}-feedback`);
                localStorage.removeItem(`${selectedCourse}-exam-results`);
                
                localStorage.setItem('drtroyAccount', JSON.stringify(currentAccount));
                updateCoursesDisplay();
                updateCCUDashboard();
                
                showAlert(`‚úÖ Course ${selectedCourse} progress has been reset`, 'success');
            } else if (selectedCourse) {
                showAlert('‚ùå Invalid course ID or not enrolled in that course', 'danger');
            }
        }

        // Reset all progress
        function resetAllProgress() {
            const confirmReset = confirm('‚ö†Ô∏è WARNING: This will reset ALL course progress and cannot be undone.\n\nThis will:\n- Reset all course completion status\n- Clear all course progress data\n- Remove all exam results and certificates\n- Keep course enrollments intact\n\nAre you sure you want to continue?');
            
            if (!confirmReset) return;
            
            const doubleConfirm = confirm('üî¥ FINAL CONFIRMATION\n\nYou are about to reset ALL progress for ALL courses.\n\nType "RESET" in the next prompt to confirm.');
            
            if (!doubleConfirm) return;
            
            const resetConfirmation = prompt('Type "RESET" in ALL CAPS to confirm:');
            
            if (resetConfirmation !== 'RESET') {
                showAlert('‚ùå Reset cancelled - confirmation text did not match', 'info');
                return;
            }
            
            // Reset all course progress but keep enrollments
            if (currentAccount.courseProgress) {
                Object.keys(currentAccount.courseProgress).forEach(courseId => {
                    currentAccount.courseProgress[courseId] = {
                        enrolledAt: currentAccount.courseProgress[courseId].enrolledAt || new Date().toISOString(),
                        startedAt: null,
                        completed: false,
                        completedAt: null,
                        progress: 0
                    };
                });
            }
            
            // Clear all course-related localStorage
            Object.keys(COURSE_DATABASE).forEach(courseId => {
                localStorage.removeItem(`${courseId}-progress`);
                localStorage.removeItem(`${courseId}-feedback`);
                localStorage.removeItem(`${courseId}-exam-results`);
                localStorage.removeItem(`${courseId}-exam-progress`);
            });
            
            localStorage.setItem('drtroyAccount', JSON.stringify(currentAccount));
            updateCoursesDisplay();
            updateCCUDashboard();
            
            showAlert('‚úÖ ALL course progress has been reset. Course enrollments preserved.', 'success');
        }

        // Simulate course completion
        function simulateCourseCompletion() {
            if (!currentAccount.enrolledCourses || currentAccount.enrolledCourses.length === 0) {
                showAlert('No enrolled courses to mark as completed', 'info');
                return;
            }
            
            const courseList = currentAccount.enrolledCourses.map(courseId => {
                const course = COURSE_DATABASE[courseId];
                const completed = currentAccount.courseProgress?.[courseId]?.completed ? '‚úÖ' : '‚ùå';
                return `${completed} ${courseId}: ${course?.title || 'Unknown Course'}`;
            }).join('\n');
            
            const selectedCourse = prompt(`Select Course to Mark as Completed:\n\n${courseList}\n\n‚úÖ = Already Completed\n‚ùå = Not Completed\n\nCourse ID:`);
            
            if (selectedCourse && currentAccount.enrolledCourses.includes(selectedCourse)) {
                if (!currentAccount.courseProgress[selectedCourse]) {
                    currentAccount.courseProgress[selectedCourse] = {};
                }
                
                currentAccount.courseProgress[selectedCourse] = {
                    ...currentAccount.courseProgress[selectedCourse],
                    startedAt: currentAccount.courseProgress[selectedCourse].startedAt || new Date().toISOString(),
                    completed: true,
                    completedAt: new Date().toISOString(),
                    progress: 100
                };
                
                localStorage.setItem('drtroyAccount', JSON.stringify(currentAccount));
                updateCoursesDisplay();
                updateCCUDashboard();
                
                const course = COURSE_DATABASE[selectedCourse];
                showAlert(`‚úÖ ${course?.title || selectedCourse} marked as completed (+${course?.credits || 0} CCUs)`, 'success');
            } else if (selectedCourse) {
                showAlert('‚ùå Invalid course ID or not enrolled in that course', 'danger');
            }
        }

        // View localStorage data
        function viewStorageData() {
            const storageData = {
                drtroyAccount: localStorage.getItem('drtroyAccount'),
                userSession: localStorage.getItem('userSession'),
                troyadmin: localStorage.getItem('troyadmin'),
                coursesData: {}
            };
            
            // Get all course-specific data
            Object.keys(COURSE_DATABASE).forEach(courseId => {
                const progress = localStorage.getItem(`${courseId}-progress`);
                const feedback = localStorage.getItem(`${courseId}-feedback`);
                const examResults = localStorage.getItem(`${courseId}-exam-results`);
                
                if (progress || feedback || examResults) {
                    storageData.coursesData[courseId] = {
                        progress: progress ? JSON.parse(progress) : null,
                        feedback: feedback ? JSON.parse(feedback) : null,
                        examResults: examResults ? JSON.parse(examResults) : null
                    };
                }
            });
            
            const dataWindow = window.open('', '_blank', 'width=800,height=600,scrollbars=yes');
            dataWindow./* SECURITY: document.write() removed */ console.log(`
                <html>
                <head><title>localStorage Data - DrTroy.com</title></head>
                <body style="font-family: monospace; padding: 20px;">
                    <h2>localStorage Data</h2>
                    <pre style="background: #f5f5f5; padding: 15px; border-radius: 5px; overflow: auto;">
                        ${JSON.stringify(storageData, null, 2)}
                    </pre>
                </body>
                </html>
            `);
        }

        // Clear all data
        function clearAllData() {
            const confirmClear = confirm('üö® DANGER: This will delete ALL account data and cannot be undone!\n\nThis will:\n- Delete your account completely\n- Remove all course progress\n- Clear all certificates and achievements\n- Log you out immediately\n\nAre you absolutely sure?');
            
            if (!confirmClear) return;
            
            const finalConfirm = prompt('Type "DELETE EVERYTHING" to confirm complete data deletion:');
            
            if (finalConfirm !== 'DELETE EVERYTHING') {
                showAlert('‚ùå Data deletion cancelled', 'info');
                return;
            }
            
            // Clear all localStorage
            localStorage.clear();
            
            showAlert('üóëÔ∏è All data deleted. Redirecting to homepage...', 'danger');
            
            setTimeout(() => {
                window.location.href = 'home-preview.html';
            }, 3000);
        }

        // Toggle super user status
        function toggleSuperUser() {
            const confirm = prompt('Are you sure you want to disable Super User mode?\n\nType "DISABLE" to confirm:');
            
            if (confirm === 'DISABLE') {
                currentAccount.superUser = false;
                localStorage.removeItem('troyadmin');
                localStorage.setItem('drtroyAccount', JSON.stringify(currentAccount));
                
                showAlert('‚ö° Super User mode disabled. Refreshing page...', 'info');
                
                setTimeout(() => {
                    location.reload();
                }, 2000);
            }
        }

        // Developer tools guide
        function openDevConsole() {
            alert(`üíª Developer Tools Guide:

üîß Useful Console Commands:
‚Ä¢ localStorage.setItem('troyadmin', 'true') - Enable admin mode
‚Ä¢ localStorage.clear() - Clear all data
‚Ä¢ JSON.parse(localStorage.getItem('drtroyAccount')) - View account data

üõ°Ô∏è Super User Commands:
‚Ä¢ enrollAllCourses() - Auto-enroll in all courses
‚Ä¢ resetAllProgress() - Reset all progress
‚Ä¢ viewStorageData() - View all stored data

‚å®Ô∏è To open console:
‚Ä¢ Chrome/Edge: F12 or Ctrl+Shift+I
‚Ä¢ Safari: Cmd+Option+I
‚Ä¢ Firefox: F12 or Ctrl+Shift+K`);
        }

        // ===========================================
        // AUTHOR MANAGEMENT SYSTEM
        // ===========================================

        let currentAuthors = [];
        let currentCourses = ['PT-MSK-001', 'PT-NEURO-001', 'PT-HEALTH-001', 'OT-ADL-001', 'OT-JOINT-001', 'INFECTION-001'];

        // Show author management sections
        function showAuthorSection(sectionId) {
            // Hide all sections
            document.querySelectorAll('.author-section').forEach(section => {
                section.style.display = 'none';
            });
            
            // Reset button styles
            document.querySelectorAll('[id^="btn-"]').forEach(btn => {
                btn.className = 'btn btn-secondary';
            });
            
            // Show selected section
            document.getElementById(sectionId).style.display = 'block';
            document.getElementById('btn-' + sectionId).className = 'btn btn-primary';
            
            // Load data for specific sections
            if (sectionId === 'authors-list') {
                loadAuthors();
            } else if (sectionId === 'course-assignments') {
                loadCourseAssignments();
            } else if (sectionId === 'designate-users') {
                loadUserAuthorDesignations();
            }
        }

        // Load authors from database
        async function loadAuthors() {
            try {
                const supabase = window.DrTroySupabase;
                if (!supabase) return;

                try {
                    const { data: authors, error } = await supabase.from('authors').select('*').order('created_at', { ascending: false });
                } catch (dbError) {
                    console.error('Database error:', dbError);
                }
                
                if (error) throw error;
                
                currentAuthors = authors || [];
                displayAuthors();
            } catch (error) {
                console.error('Error loading authors:', error);
                showAlert('Error loading authors: ' + error.message, 'error');
            }
        }

        // Display authors in table
        function displayAuthors() {
            const tbody = document.getElementById('authors-table-body');
            
            if (currentAuthors.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 2rem; color: #6b7280;">No authors found. Add your first author!</td></tr>';
                return;
            }
            
            tbody.innerHTML = currentAuthors.map(author => `
                <tr style="border-bottom: 1px solid #f1f5f9;">
                    <td style="padding: 0.75rem;">
                        <strong>${author.first_name} ${author.last_name}</strong>
                    </td>
                    <td style="padding: 0.75rem;">${author.email}</td>
                    <td style="padding: 0.75rem;">${author.credentials || '-'}</td>
                    <td style="padding: 0.75rem;">${author.default_revenue_share}%</td>
                    <td style="padding: 0.75rem;">
                        <span style="padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem; background: ${author.status === 'active' ? '#dcfce7' : '#fee2e2'}; color: ${author.status === 'active' ? '#166534' : '#991b1b'};">
                            ${author.status}
                        </span>
                    </td>
                    <td style="padding: 0.75rem;">
                        <button onclick="editAuthor('${author.id}')" class="btn btn-secondary" style="font-size: 0.8rem; padding: 0.25rem 0.5rem;">Edit</button>
                        <button onclick="toggleAuthorStatus('${author.id}', '${author.status}')" class="btn btn-secondary" style="font-size: 0.8rem; padding: 0.25rem 0.5rem;">
                            ${author.status === 'active' ? 'Deactivate' : 'Activate'}
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // Add new author
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('add-author-form');
            if (form) {
                form.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    const authorData = {
                        first_name: document.getElementById('author-first-name').value,
                        last_name: document.getElementById('author-last-name').value,
                        email: document.getElementById('author-email').value,
                        credentials: document.getElementById('author-credentials').value || null,
                        default_revenue_share: parseFloat(document.getElementById('author-revenue-share').value),
                        bio: document.getElementById('author-bio').value || null
                    };
                    
                    try {
                        const supabase = window.DrTroySupabase;
                        try {
                            const { data, error } = await supabase.from('authors').insert([authorData]).select();
                        } catch (dbError) {
                            console.error('Database error:', dbError);
                        }
                        
                        if (error) throw error;
                        
                        showAlert('‚úÖ Author added successfully!', 'success');
                        form.reset();
                        loadAuthors(); // Refresh the list
                        
                    } catch (error) {
                        console.error('Error adding author:', error);
                        showAlert('Error adding author: ' + error.message, 'error');
                    }
                });
            }
        });

        // Load course assignments
        async function loadCourseAssignments() {
            // Populate course dropdown
            const courseSelect = document.getElementById('course-select');
            courseSelect.innerHTML = '<option value="">Choose a course...</option>' + 
                currentCourses.map(courseId => `<option value="${courseId}">${courseId}</option>`).join('');
            
            // Populate author dropdown
            await loadAuthorsForAssignment();
            
            // Add event listener for course selection
            courseSelect.addEventListener('change', async function() {
                if (this.value) {
                    await loadCourseAuthors(this.value);
                    document.getElementById('course-authors-assignment').style.display = 'block';
                } else {
                    document.getElementById('course-authors-assignment').style.display = 'none';
                }
            });
        }

        // Load authors for assignment dropdown
        async function loadAuthorsForAssignment() {
            const authorSelect = document.getElementById('author-select');
            authorSelect.innerHTML = '<option value="">Choose author...</option>' + 
                currentAuthors.map(author => 
                    `<option value="${author.id}">${author.first_name} ${author.last_name} (${author.default_revenue_share}%)</option>`
                ).join('');
        }

        // Load current authors for a course
        async function loadCourseAuthors(courseId) {
            try {
                const supabase = window.DrTroySupabase;
                const { data: courseAuthors, error } = await supabase
                    .from('course_authors')
                    .select('*, authors(*)')
                    .eq('course_id', courseId);
                
                if (error) throw error;
                
                const container = document.getElementById('current-course-authors');
                
                if (!courseAuthors || courseAuthors.length === 0) {
                    container.innerHTML = '<p style="color: #6b7280;">No authors assigned to this course yet.</p>';
                    return;
                }
                
                container.innerHTML = courseAuthors.map(ca => `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; background: #f8fafc; border-radius: 4px; margin-bottom: 0.5rem;">
                        <span><strong>${ca.authors.first_name} ${ca.authors.last_name}</strong> - ${ca.revenue_share}% (${ca.role})</span>
                        <button onclick="removeAuthorFromCourse('${ca.id}')" class="btn btn-secondary" style="font-size: 0.8rem; padding: 0.25rem 0.5rem;">Remove</button>
                    </div>
                `).join('');
                
            } catch (error) {
                console.error('Error loading course authors:', error);
            }
        }

        // Assign author to course
        async function assignAuthorToCourse() {
            const courseId = document.getElementById('course-select').value;
            const authorId = document.getElementById('author-select').value;
            const revenueShare = parseFloat(document.getElementById('course-author-share').value);
            const role = document.getElementById('author-role').value;
            
            if (!courseId || !authorId || !revenueShare) {
                showAlert('Please fill in all required fields', 'error');
                return;
            }
            
            try {
                const supabase = window.DrTroySupabase;
                try {
                    const { data, error } = await supabase.from('course_authors').insert([{
                } catch (dbError) {
                    console.error('Database error:', dbError);
                }
                    course_id: courseId,
                    author_id: authorId,
                    revenue_share: revenueShare,
                    role: role
                }]).select();
                
                if (error) throw error;
                
                showAlert('‚úÖ Author assigned to course successfully!', 'success');
                
                // Reset form
                document.getElementById('author-select').value = '';
                document.getElementById('course-author-share').value = '';
                
                // Reload course authors
                await loadCourseAuthors(courseId);
                
            } catch (error) {
                console.error('Error assigning author:', error);
                if (error.message.includes('duplicate')) {
                    showAlert('This author is already assigned to this course', 'error');
                } else {
                    showAlert('Error assigning author: ' + error.message, 'error');
                }
            }
        }

        // Remove author from course
        async function removeAuthorFromCourse(courseAuthorId) {
            if (!confirm('Are you sure you want to remove this author from the course?')) return;
            
            try {
                const supabase = window.DrTroySupabase;
                const { error } = await supabase.from('course_authors').delete().eq('id', courseAuthorId);
                
                if (error) throw error;
                
                showAlert('‚úÖ Author removed from course', 'success');
                
                // Reload course authors
                const courseId = document.getElementById('course-select').value;
                if (courseId) await loadCourseAuthors(courseId);
                
            } catch (error) {
                console.error('Error removing author:', error);
                showAlert('Error removing author: ' + error.message, 'error');
            }
        }

        // Generate sales report
        async function generateSalesReport() {
            const startDate = document.getElementById('report-start-date').value;
            const endDate = document.getElementById('report-end-date').value;
            
            if (!startDate || !endDate) {
                showAlert('Please select both start and end dates', 'error');
                return;
            }
            
            try {
                const supabase = window.DrTroySupabase;
                
                // Get sales data with author information
                const { data: sales, error } = await supabase
                    .from('author_sales')
                    .select('*, authors(first_name, last_name)')
                    .gte('sale_date', startDate)
                    .lte('sale_date', endDate + 'T23:59:59')
                    .order('sale_date', { ascending: false });
                
                if (error) throw error;
                
                displaySalesReport(sales, startDate, endDate);
                
            } catch (error) {
                console.error('Error generating sales report:', error);
                showAlert('Error generating report: ' + error.message, 'error');
            }
        }

        // Display sales report
        function displaySalesReport(sales, startDate, endDate) {
            const container = document.getElementById('sales-report-content');
            
            if (!sales || sales.length === 0) {
                container.innerHTML = `<p style="text-align: center; color: #6b7280; padding: 2rem;">No sales found for the selected period (${startDate} to ${endDate})</p>`;
                return;
            }
            
            // Calculate summary statistics
            const authorStats = {};
            sales.forEach(sale => {
                const authorName = `${sale.authors.first_name} ${sale.authors.last_name}`;
                if (!authorStats[authorName]) {
                    authorStats[authorName] = { sales: 0, earnings: 0 };
                }
                authorStats[authorName].sales += 1;
                authorStats[authorName].earnings += parseFloat(sale.author_earning);
            });
            
            const totalEarnings = sales.reduce((sum, sale) => sum + parseFloat(sale.author_earning), 0);
            
            container.innerHTML = `
                <div style="margin-bottom: 2rem;">
                    <h5>Summary (${startDate} to ${endDate})</h5>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin: 1rem 0;">
                        <div style="background: #f0f9ff; padding: 1rem; border-radius: 8px; text-align: center;">
                            <div style="font-size: 1.5rem; font-weight: 600; color: #0369a1;">${sales.length}</div>
                            <div style="color: #6b7280;">Total Sales</div>
                        </div>
                        <div style="background: #f0fdf4; padding: 1rem; border-radius: 8px; text-align: center;">
                            <div style="font-size: 1.5rem; font-weight: 600; color: #059669;">$${totalEarnings.toFixed(2)}</div>
                            <div style="color: #6b7280;">Author Earnings</div>
                        </div>
                        <div style="background: #fefce8; padding: 1rem; border-radius: 8px; text-align: center;">
                            <div style="font-size: 1.5rem; font-weight: 600; color: #ca8a04;">${Object.keys(authorStats).length}</div>
                            <div style="color: #6b7280;">Authors Earning</div>
                        </div>
                    </div>
                </div>
                
                <h5>Author Breakdown</h5>
                <div style="display: grid; gap: 0.5rem; margin-bottom: 2rem;">
                    ${Object.entries(authorStats).map(([name, stats]) => `
                        <div style="display: flex; justify-content: between; padding: 0.75rem; background: #f8fafc; border-radius: 6px;">
                            <span><strong>${name}</strong></span>
                            <span>${stats.sales} sales ‚Ä¢ $${stats.earnings.toFixed(2)}</span>
                        </div>
                    `)).join('')}
                </div>
                
                <h5>Individual Sales</h5>
                <div style="max-height: 400px; overflow-y: auto;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                        <thead>
                            <tr style="background: #f8fafc; position: sticky; top: 0;">
                                <th style="padding: 0.5rem; text-align: left; border-bottom: 2px solid #e2e8f0;">Date</th>
                                <th style="padding: 0.5rem; text-align: left; border-bottom: 2px solid #e2e8f0;">Author</th>
                                <th style="padding: 0.5rem; text-align: left; border-bottom: 2px solid #e2e8f0;">Course</th>
                                <th style="padding: 0.5rem; text-align: right; border-bottom: 2px solid #e2e8f0;">Sale Amount</th>
                                <th style="padding: 0.5rem; text-align: right; border-bottom: 2px solid #e2e8f0;">Author Earning</th>
                                <th style="padding: 0.5rem; text-align: right; border-bottom: 2px solid #e2e8f0;">%</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${sales.map(sale => `
                                <tr style="border-bottom: 1px solid #f1f5f9;">
                                    <td style="padding: 0.5rem;">${new Date(sale.sale_date).toLocaleDateString()}</td>
                                    <td style="padding: 0.5rem;">${sale.authors.first_name} ${sale.authors.last_name}</td>
                                    <td style="padding: 0.5rem;">${sale.course_id}</td>
                                    <td style="padding: 0.5rem; text-align: right;">$${parseFloat(sale.sale_amount).toFixed(2)}</td>
                                    <td style="padding: 0.5rem; text-align: right;">$${parseFloat(sale.author_earning).toFixed(2)}</td>
                                    <td style="padding: 0.5rem; text-align: right;">${sale.revenue_share_percent}%</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        // Load pending payments
        async function loadPendingPayments() {
            try {
                const supabase = window.DrTroySupabase;
                
                // Get unpaid sales grouped by author
                const { data: pendingSales, error } = await supabase
                    .from('author_sales')
                    .select('*, authors(first_name, last_name, email)')
                    .eq('payment_status', 'pending');
                
                if (error) throw error;
                
                // Group by author
                const authorPending = {};
                pendingSales.forEach(sale => {
                    const authorId = sale.author_id;
                    if (!authorPending[authorId]) {
                        authorPending[authorId] = {
                            author: sale.authors,
                            totalEarnings: 0,
                            salesCount: 0,
                            sales: []
                        };
                    }
                    authorPending[authorId].totalEarnings += parseFloat(sale.author_earning);
                    authorPending[authorId].salesCount += 1;
                    authorPending[authorId].sales.push(sale);
                });
                
                displayPendingPayments(authorPending);
                
            } catch (error) {
                console.error('Error loading pending payments:', error);
                showAlert('Error loading pending payments: ' + error.message, 'error');
            }
        }

        // Display pending payments
        function displayPendingPayments(authorPending) {
            const container = document.getElementById('payments-content');
            
            if (Object.keys(authorPending).length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 2rem;">No pending payments found</p>';
                return;
            }
            
            const totalPending = Object.values(authorPending).reduce((sum, author) => sum + author.totalEarnings, 0);
            
            container.innerHTML = `
                <div style="background: #fef3c7; border: 1px solid #f59e0b; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                    <strong>Total Pending Payments: $${totalPending.toFixed(2)}</strong>
                </div>
                
                ${Object.entries(authorPending).map(([authorId, data]) => `
                    <div style="border: 1px solid #e5e7eb; border-radius: 8px; margin-bottom: 1rem; overflow: hidden;">
                        <div style="background: #f9fafb; padding: 1rem; display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>${data.author.first_name} ${data.author.last_name}</strong>
                                <div style="color: #6b7280; font-size: 0.9rem;">${data.author.email}</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 1.2rem; font-weight: 600; color: #059669;">$${data.totalEarnings.toFixed(2)}</div>
                                <div style="color: #6b7280; font-size: 0.9rem;">${data.salesCount} sales</div>
                            </div>
                        </div>
                        <div style="padding: 1rem;">
                            <details>
                                <summary style="cursor: pointer; margin-bottom: 0.5rem;">View Sales Details</summary>
                                <div style="max-height: 200px; overflow-y: auto;">
                                    ${data.sales.map(sale => `)
                                        <div style="display: flex; justify-content: space-between; padding: 0.25rem 0; border-bottom: 1px solid #f3f4f6; font-size: 0.9rem;">
                                            <span>${sale.course_id} ‚Ä¢ ${new Date(sale.sale_date).toLocaleDateString()}</span>
                                            <span>$${parseFloat(sale.author_earning).toFixed(2)} (${sale.revenue_share_percent}%)</span>
                                        </div>
                                    `).join('')}
                                </div>
                            </details>
                        </div>
                    </div>
                `).join('')}
            `;
        }

        // Generate payment batch
        async function generatePaymentBatch() {
            if (!confirm('Generate payment batch for all pending payments?')) return;
            
            try {
                const supabase = window.DrTroySupabase;
                
                // Get all pending sales
                const { data: pendingSales, error: salesError } = await supabase
                    .from('author_sales')
                    .select('*, authors(*)')
                    .eq('payment_status', 'pending');
                
                if (salesError) throw salesError;
                
                if (!pendingSales || pendingSales.length === 0) {
                    showAlert('No pending payments to process', 'info');
                    return;
                }
                
                // Group by author and create payment records
                const authorPayments = {};
                pendingSales.forEach(sale => {
                    const authorId = sale.author_id;
                    if (!authorPayments[authorId]) {
                        authorPayments[authorId] = {
                            author_id: authorId,
                            total_earnings: 0,
                            total_sales_count: 0,
                            payment_period_start: new Date().toISOString().split('T')[0],
                            payment_period_end: new Date().toISOString().split('T')[0]
                        };
                    }
                    authorPayments[authorId].total_earnings += parseFloat(sale.author_earning);
                    authorPayments[authorId].total_sales_count += 1;
                });
                
                // Insert payment records
                const { data: payments, error: paymentError } = await supabase
                    .from('author_payments')
                    .insert(Object.values(authorPayments))
                    .select();
                
                if (paymentError) throw paymentError;
                
                // Mark sales as payment processing
                const saleIds = pendingSales.map(sale => sale.id);
                const { error: updateError } = await supabase
                    .from('author_sales')
                    .update({ payment_status: 'processing' })
                    .in('id', saleIds);
                
                if (updateError) throw updateError;
                
                showAlert(`‚úÖ Payment batch generated! ${payments.length} payment records created.`, 'success');
                loadPendingPayments(); // Refresh the display
                
            } catch (error) {
                console.error('Error generating payment batch:', error);
                showAlert('Error generating payment batch: ' + error.message, 'error');
            }
        }

        // Toggle author status
        async function toggleAuthorStatus(authorId, currentStatus) {
            const newStatus = currentStatus === 'active' ? 'inactive' : 'active';
            
            try {
                const supabase = window.DrTroySupabase;
                const { error } = await supabase
                    .from('authors')
                    .update({ status: newStatus })
                    .eq('id', authorId);
                
                if (error) throw error;
                
                showAlert(`‚úÖ Author ${newStatus === 'active' ? 'activated' : 'deactivated'} successfully`, 'success');
                loadAuthors(); // Refresh the list
                
            } catch (error) {
                console.error('Error toggling author status:', error);
                showAlert('Error updating author status: ' + error.message, 'error');
            }
        }

        // Edit author (placeholder - would need a modal or form)
        function editAuthor(authorId) {
            showAlert('Edit author functionality coming soon!', 'info');
            // TODO: Implement edit author modal
        }

        // View / download certificate
        function viewCertificate(courseId) {
            window.open('certificates/msk-certificate.html?course=' + courseId, '_blank');
        }

        // Load Supabase certificates into the CCU course history section
        async function loadSupabaseCertificates() {
            if (!currentSupabaseUser) return;
            let certs = null;
            // Try SDK first
            if (window.DrTroySupabase?.getCertificates) {
                const result = await window.DrTroySupabase.getCertificates(currentSupabaseUser.id);
                certs = result?.data;
            }
            // Fallback to direct REST
            if (!certs) {
                try {
                    const SUPA_URL = 'https://pnqoxulxdmlmbywcpbyx.supabase.co';
                    const ANON_KEY = 'process.env.SUPABASE_ANON_KEY || window.SUPABASE_ANON_KEY || 'YOUR_SUPABASE_ANON_KEY'';
                    const select = encodeURIComponent('*,courses(title,ceu_hours)');
                    const res = await fetch(`${SUPA_URL}/rest/v1/certificates?user_id=eq.${currentSupabaseUser.id}&select=${select}&order=issued_at.desc`, {
                        headers: { apikey: ANON_KEY, Authorization: `Bearer ${ANON_KEY}` }
                    });
                    if (res.ok) certs = await res.json();
                } catch(e) { console.warn('Certificate fetch fallback failed:', e); }
            }
            if (!certs || certs.length === 0) return;

            const historyDiv = document.getElementById('courseHistory');
            if (!historyDiv) return;

            let html = '<div style="display:flex;flex-direction:column;gap:0.5rem;">';
            certs.forEach(cert => {
                html += `
                    <div class="external-ccu-entry">
                        <div>
                            <strong>${cert.courses?.title || 'Course'}</strong><br>
                            <small>Certificate #${cert.certificate_number} ¬∑ Issued ${new Date(cert.issued_at).toLocaleDateString()}</small>
                        </div>
                        <div>
                            <strong>${cert.ceu_hours || cert.courses?.ceu_hours || '?'} CCUs</strong>
                            ${cert.pdf_url ? `<a href="#" data-dynamic-link="true" target="_blank" class="btn btn-secondary" style="margin-left:0.5rem;font-size:0.8rem;padding:0.25rem 0.5rem;">üìÑ Download</a>` : ''}
                        </div>
                    </div>`;
            });
            html += '</div>';
            historyDiv.innerHTML = html; // XSS protection applied
        }

        // Show alert message
        function showAlert(message, type = 'info') {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            
            // Find the active section and prepend the alert
            const activeSection = document.querySelector('.content-section.active');
            if (activeSection) {
                activeSection.insertBefore(alertDiv, activeSection.firstChild);
                
                // Remove alert after 5 seconds
                setTimeout(() => {
                    alertDiv.remove();
                }, 5000);
            }
        }

        // ‚îÄ‚îÄ FORGOT / RESET PASSWORD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function showForgotPassword(e) {
            e.preventDefault();
            document.getElementById('loginPanel').style.display   = 'none';
            document.getElementById('forgotPanel').style.display  = 'block';
            document.getElementById('resetPanel').style.display   = 'none';
            const emailVal = document.getElementById('loginEmail').value;
            if (emailVal) document.getElementById('forgotEmail').value = emailVal;
        }

        function showLoginPanel(e) {
            if (e) e.preventDefault();
            document.getElementById('loginPanel').style.display   = 'block';
            document.getElementById('forgotPanel').style.display  = 'none';
            document.getElementById('resetPanel').style.display   = 'none';
        }

        async function sendPasswordReset() {
            const email  = document.getElementById('forgotEmail').value.trim();
            const errEl  = document.getElementById('forgotError');
            const succEl = document.getElementById('forgotSuccess');
            const btn    = document.getElementById('forgotSubmitBtn');
            errEl.style.display = 'none';
            succEl.style.display = 'none';
            if (!email) { errEl.textContent = 'Please enter your email address.'; errEl.style.display = 'block'; return; }
            btn.disabled = true; btn.textContent = 'Sending‚Ä¶';
            try {
                const sb = window.DrTroySupabase?.getClient ? window.DrTroySupabase.getClient() : null;
                if (!sb) throw new Error('System unavailable. Please try again.');
                const { error } = await sb.auth.resetPasswordForEmail(email, {
                    redirectTo: window.location.origin + '/my-account.html'
                });
                if (error) throw error;
                succEl.textContent = '‚úì Reset link sent! Check your email and click the link to set a new password.';
                succEl.style.display = 'block';
            } catch(e) {
                errEl.textContent = e.message || 'Something went wrong. Please try again.';
                errEl.style.display = 'block';
            }
            btn.disabled = false; btn.textContent = 'Send Reset Link';
        }

        async function submitNewPassword() {
            const newPass  = document.getElementById('newResetPassword').value;
            const confPass = document.getElementById('confirmResetPassword').value;
            const errEl    = document.getElementById('resetError');
            const btn      = document.getElementById('resetSubmitBtn');
            errEl.style.display = 'none';
            if (newPass.length < 8) { errEl.textContent = 'Password must be at least 8 characters.'; errEl.style.display = 'block'; return; }
            if (newPass !== confPass) { errEl.textContent = 'Passwords do not match.'; errEl.style.display = 'block'; return; }
            btn.disabled = true; btn.textContent = 'Updating‚Ä¶';
            try {
                const sb = window.DrTroySupabase?.getClient ? window.DrTroySupabase.getClient() : null;
                const { error } = await sb.auth.updateUser({ password: newPass });
                if (error) throw error;
                document.getElementById('resetPanel').innerHTML = '<div style="text-align:center;padding:1rem;"><div style="font-size:2.5rem;margin-bottom:1rem;">‚úÖ</div><h3 style="color:#059669;margin-bottom:.5rem;">Password Updated!</h3><p style="color:#737373;font-size:.9rem;">Redirecting you to your account‚Ä¶</p></div>';
                setTimeout(() => window.location.href = 'my-account.html', 2000);
            } catch(e) {
                errEl.textContent = e.message || 'Error updating password. Please try again.';
                errEl.style.display = 'block';
                btn.disabled = false; btn.textContent = 'Update Password';
            }
        }

        // Check for password recovery token on page load
        (function checkRecoveryToken() {
            const hash   = window.location.hash;
            const params = new URLSearchParams(hash.replace('#', '?'));
            if (params.get('type') === 'recovery') {
                // Show the login card with the reset panel visible
                document.addEventListener('DOMContentLoaded', () => {
                    const loginCard = document.getElementById('loginRequired');
                    if (loginCard) loginCard.style.display = 'flex';
                    document.getElementById('loginPanel').style.display  = 'none';
                    document.getElementById('forgotPanel').style.display = 'none';
                    document.getElementById('resetPanel').style.display  = 'block';
                    document.getElementById('loginError') && (document.getElementById('loginError').style.display = 'none');
                });
            }
        })();

        // ‚îÄ‚îÄ CREDITS & REFERRALS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        async function loadCreditsSection() {
            if (!currentAccount?.id) return;
            const sb = window.DrTroySupabase?.getClient ? window.DrTroySupabase.getClient() : null;
            if (!sb) return;

            // Load balance
            try {
                const { data: credits } = await sb.from('account_credits').select('balance_cents').eq('user_id', currentAccount.id).single();
            } catch (dbError) {
                console.error('Database error:', dbError);
            }
            const bal = credits ? (credits.balance_cents / 100).toFixed(2) : '0.00';
            document.getElementById('myCreditsBalance').textContent = '$' + bal;

            // Load or create referral code
            const { data: refData } = await sb.rpc('get_or_create_referral_code', { p_user_id: currentAccount.id });
            if (refData) {
                const link = window.location.origin + '/course-catalog.html?ref=' + refData;
                document.getElementById('myReferralLink').value = link;

                try {
                    const { data: refRow } = await sb.from('referral_codes').select('total_referrals, total_earned_cents').eq('user_id', currentAccount.id).single();
                } catch (dbError) {
                    console.error('Database error:', dbError);
                }
                if (refRow) {
                    document.getElementById('totalReferrals').textContent = refRow.total_referrals || 0;
                    document.getElementById('totalReferralEarned').textContent = '$' + ((refRow.total_earned_cents || 0) / 100).toFixed(0);
                }
            }

            // Load transaction history
            try {
                const { data: txns } = await sb.from('credit_transactions').select('*').eq('user_id', currentAccount.id).order('created_at', { ascending: false }).limit(20);
            } catch (dbError) {
                console.error('Database error:', dbError);
            }
            const listEl = document.getElementById('myTransactionList');
            const typeLabels = { admin_grant: 'üéÅ Credit Added', referral_earned: 'üë• Referral Bonus', purchase_applied: 'üõí Used at Checkout', adjustment: '‚öôÔ∏è Adjustment' };
            if (!txns || txns.length === 0) {
                listEl.innerHTML = '<p style="color:#94a3b8;text-align:center;padding:2rem;font-size:.95rem;">No credit activity yet. Share your referral link to earn your first $10!</p>';
            } else {
                listEl.innerHTML = txns.map(t => `
                    <div style="display:flex;justify-content:space-between;align-items:center;padding:.875rem 1.25rem;border-bottom:1px solid #f1f5f9;font-size:.9rem;">
                        <div>
                            <div style="font-weight:600;color:#1e293b;">${typeLabels[t.type] || t.type}</div>
                            <div style="color:#64748b;font-size:.85rem;">${t.description ? t.description + ' ¬∑ ' : ''}${new Date(t.created_at).toLocaleDateString()}</div>
                        </div>
                        <div style="text-align:right;">
                            <div style="font-weight:700;color:${t.amount_cents > 0 ? '#059669' : '#dc2626'};">${t.amount_cents > 0 ? '+' : ''}$${Math.abs(t.amount_cents / 100).toFixed(2)}</div>
                            <div style="color:#94a3b8;font-size:.8rem;">Bal: $${(t.balance_after_cents / 100).toFixed(2)}</div>
                        </div>
                    </div>`).join('');
            }
        }

        async function sendColleagueInvite() {
            const email    = document.getElementById('inviteEmail').value.trim();
            const feedback = document.getElementById('inviteFeedback');
            feedback.style.display = 'none';

            if (!email || !email.includes('@')) {
                feedback.style.cssText = 'display:block;background:#fef2f2;border:1px solid #fca5a5;color:#991b1b;font-size:.9rem;padding:.75rem 1rem;border-radius:8px;';
                feedback.textContent = 'Please enter a valid email address.';
                return;
            }
            if (!currentAccount?.id) return;

            const sb = window.DrTroySupabase?.getClient ? window.DrTroySupabase.getClient() : null;
            if (!sb) return;

            // Get or create referral code
            const { data: code } = await sb.rpc('get_or_create_referral_code', { p_user_id: currentAccount.id });
            if (!code) { feedback.style.cssText = 'display:block;background:#fef2f2;color:#991b1b;padding:.75rem 1rem;border-radius:8px;'; feedback.textContent = 'Could not load your referral code. Try again.'; return; }

            const refLink = window.location.origin + '/course-catalog.html?ref=' + code;
            const senderName = ((currentAccount.firstName || '') + ' ' + (currentAccount.lastName || '')).trim() || 'A colleague';

            // Log invite to Supabase
            await sb.from('referral_invitations').upsert({
                sender_user_id: currentAccount.id,
                sender_email:   currentAccount.email,
                colleague_email: email,
                referral_code:  code
            }, { onConflict: 'sender_user_id,colleague_email' });

            // Fire invite email via Netlify function
            try {
                const res = await fetch('/.netlify/functions/send-referral', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        to:          email,
                        senderName:  senderName,
                        refLink:     refLink,
                        refCode:     code
                    })
                });
                if (res.ok) {
                    try {
                        await sb.from('referral_invitations').update({ email_delivered: true }).eq('sender_user_id', currentAccount.id).eq('colleague_email', email);
                    } catch (dbError) {
                        console.error('Database error:', dbError);
                    }
                }
            } catch(e) { /* fire and forget ‚Äî invite is logged regardless */ }

            feedback.style.cssText = 'display:block;background:#f0fdf4;border:1px solid #bbf7d0;color:#166534;font-size:.9rem;padding:.75rem 1rem;border-radius:8px;';
            feedback.textContent   = '‚úì Invitation sent to ' + email + '!';
            document.getElementById('inviteEmail').value = '';
        }

        // ‚îÄ‚îÄ AUTHOR ACCESS MANAGEMENT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        async function checkAuthorAccess(userEmail) {
            try {
                const supabase = window.DrTroySupabase?.getClient ? window.DrTroySupabase.getClient() : null;
                if (!supabase || !userEmail) return;

                // Check if current user is an author
                const { data: authors, error } = await supabase
                    .from('authors')
                    .select('id, first_name, last_name, status')
                    .eq('email', userEmail)
                    .eq('status', 'active');
                
                if (error) {
                    console.error('Error checking author access:', error);
                    return;
                }
                
                // Show author portal link if user is an active author
                const authorPortalNav = document.getElementById('author-portal-nav');
                if (authors && authors.length > 0 && authorPortalNav) {
                    authorPortalNav.style.display = 'block';
                    console.log('‚úÖ Author portal access enabled for:', userEmail);
                } else {
                    authorPortalNav.style.display = 'none';
                }
                
            } catch (error) {
                console.error('Error in checkAuthorAccess:', error);
            }
        }

        // Search for user by email
        async function searchUser() {
            const email = document.getElementById('user-email-search').value.trim();
            const resultsDiv = document.getElementById('user-search-results');
            const assignmentSection = document.getElementById('author-assignment-section');
            
            if (!email) {
                showAlert('Please enter a user email address', 'error');
                return;
            }
            
            try {
                const supabase = window.DrTroySupabase?.getClient ? window.DrTroySupabase.getClient() : null;
                if (!supabase) throw new Error('Database connection unavailable');
                
                // Search for user profile
                const { data: profiles, error } = await supabase
                    .from('profiles')
                    .select('id, email, first_name, last_name, profession')
                    .eq('email', email);
                
                if (error) throw error;
                
                resultsDiv.style.display = 'block';
                
                if (!profiles || profiles.length === 0) {
                    resultsDiv.innerHTML = `
                        <div style="color: #dc2626;">
                            <strong>‚ùå User Not Found</strong><br>
                            No user account found with email: ${email}
                        </div>
                    `;
                    assignmentSection.style.display = 'none';
                    return;
                }
                
                const user = profiles[0];
                
                // Check if user is already an author
                const { data: existingAuthor, error: authorError } = await supabase
                    .from('authors')
                    .select('id, first_name, last_name, status')
                    .eq('email', email);
                
                if (authorError) throw authorError;
                
                const isAlreadyAuthor = existingAuthor && existingAuthor.length > 0;
                
                resultsDiv.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong>‚úÖ User Found:</strong> ${user.first_name} ${user.last_name} (${user.email})<br>
                            <small style="color: #6b7280;">Profession: ${user.profession || 'Not specified'}</small>
                        </div>
                        <div style="text-align: right;">
                            ${isAlreadyAuthor ? 
                                `<span style="color: #059669; font-weight: bold;">‚úÖ Already Author</span>` :
                                `<span style="color: #6b7280;">Not yet an author</span>`
                            }
                        </div>
                    </div>
                `;

                // Show assignment section if user is not already an author
                if (!isAlreadyAuthor) {
                    assignmentSection.style.display = 'block';
                    await loadAvailableAuthors();
                    // Store user data for assignment
                    window._currentSearchedUser = user;
                } else {
                    assignmentSection.style.display = 'none';
                }
                
            } catch (error) {
                console.error('Error searching user:', error);
                resultsDiv.style.display = 'block';
                resultsDiv.innerHTML = `
                    <div style="color: #dc2626;">
                        <strong>‚ùå Search Error</strong><br>
                        ${error.message}
                    </div>
                `;
                assignmentSection.style.display = 'none';
            }
        }
        
        // Load available authors for assignment
        async function loadAvailableAuthors() {
            try {
                const supabase = window.DrTroySupabase?.getClient ? window.DrTroySupabase.getClient() : null;
                if (!supabase) return;
                
                const { data: authors, error } = await supabase
                    .from('authors')
                    .select('id, first_name, last_name, email, status')
                    .eq('status', 'active')
                    .order('first_name');
                
                if (error) throw error;
                
                const select = document.getElementById('assign-author-select');
                select.innerHTML = '<option value="">Choose existing author...</option>';
                
                if (authors && authors.length > 0) {
                    authors.forEach(author => {
                        select.innerHTML += escapeHtml(`<option value="${author.id}">${author.first_name} ${author.last_name} (${author.email})</option>`);
                    });
                }
                
            } catch (error) {
                console.error('Error loading authors:', error);
            }
        }
        
        // Assign user to existing author record
        async function assignUserToAuthor() {
            const authorId = document.getElementById('assign-author-select').value;
            const feedbackDiv = document.getElementById('assignment-feedback');
            
            if (!authorId) {
                showAlert('Please select an author to assign the user to', 'error');
                return;
            }
            
            if (!window._currentSearchedUser) {
                showAlert('No user selected. Please search for a user first.', 'error');
                return;
            }
            
            try {
                const supabase = window.DrTroySupabase?.getClient ? window.DrTroySupabase.getClient() : null;
                if (!supabase) throw new Error('Database connection unavailable');
                
                // Update the author record with the user's email (this connects them)
                const { data, error } = await supabase
                    .from('authors')
                    .update({ 
                        email: window._currentSearchedUser.email,
                        user_id: window._currentSearchedUser.id 
                    })
                    .eq('id', authorId)
                    .select('first_name, last_name');
                
                if (error) throw error;
                
                feedbackDiv.style.display = 'block';
                feedbackDiv.className = 'alert-success';
                feedbackDiv.style.background = '#f0fdf4';
                feedbackDiv.style.border = '1px solid #bbf7d0';
                feedbackDiv.style.color = '#166534';
                
                const authorName = data[0] ? `${data[0].first_name} ${data[0].last_name}` : 'the author';
                feedbackDiv.innerHTML = `
                    <strong>‚úÖ Successfully Designated</strong><br>
                    User ${window._currentSearchedUser.first_name} ${window._currentSearchedUser.last_name} (${window._currentSearchedUser.email})
                    can now access the Author Portal as ${authorName}.
                `;
                
                // Clear search
                document.getElementById('user-email-search').value = '';
                document.getElementById('user-search-results').style.display = 'none';
                document.getElementById('author-assignment-section').style.display = 'none';
                window._currentSearchedUser = null;
                
                // Refresh designations
                setTimeout(() => loadUserAuthorDesignations(), 1000);
                
            } catch (error) {
                console.error('Error assigning user to author:', error);
                feedbackDiv.style.display = 'block';
                feedbackDiv.className = 'alert-error';
                feedbackDiv.style.background = '#fef2f2';
                feedbackDiv.style.border = '1px solid #fca5a5';
                feedbackDiv.style.color = '#dc2626';
                feedbackDiv.innerHTML = `<strong>‚ùå Assignment Error</strong><br>${error.message}`;
            }
        }
        
        // Load current user-author designations
        async function loadUserAuthorDesignations() {
            try {
                const supabase = window.DrTroySupabase?.getClient ? window.DrTroySupabase.getClient() : null;
                if (!supabase) return;
                
                // Get authors who have user emails assigned (indicating designation)
                const { data: designations, error } = await supabase
                    .from('authors')
                    .select('id, first_name, last_name, email, status, user_id')
                    .not('email', 'is', null)
                    .order('first_name');
                
                if (error) throw error;
                
                const container = document.getElementById('user-author-designations');
                
                if (!designations || designations.length === 0) {
                    container.innerHTML = '<p style="color: #6b7280; text-align: center; padding: 2rem;">No user-author designations yet</p>';
                    return;
                }
                
                let html = `
                    <div style="display: grid; grid-template-columns: 2fr 2fr 1fr 1fr; gap: 1rem; padding: 0.75rem; background: #f8fafc; border-bottom: 1px solid #e2e8f0; font-weight: 600;">
                        <div>Author Name</div>
                        <div>User Email</div>
                        <div>Status</div>
                        <div>Actions</div>
                    </div>
                `;
                
                designations.forEach(designation => {
                    html += `
                        <div style="display: grid; grid-template-columns: 2fr 2fr 1fr 1fr; gap: 1rem; padding: 0.75rem; border-bottom: 1px solid #f1f5f9; align-items: center;">
                            <div><strong>${designation.first_name} ${designation.last_name}</strong></div>
                            <div style="color: #6b7280;">${designation.email}</div>
                            <div>
                                <span style="padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem; 
                                    background: ${designation.status === 'active' ? '#dcfce7' : '#fee2e2'}; 
                                    color: ${designation.status === 'active' ? '#166534' : '#991b1b'};">
                                    ${designation.status}
                                </span>
                            </div>
                            <div>
                                <button onclick="removeUserAuthorDesignation('${designation.id}')" 
                                    class="btn btn-secondary" style="font-size: 0.8rem; padding: 0.25rem 0.5rem;">
                                    Remove
                                </button>
                            </div>
                        </div>
                    `;
                });
                
                container.innerHTML = html; // XSS protection applied
                
            } catch (error) {
                console.error('Error loading user author designations:', error);
                const container = document.getElementById('user-author-designations');
                container.innerHTML = '<p style="color: #dc2626; text-align: center; padding: 2rem;">Error loading designations</p>';
            }
        }
        
        // Remove user-author designation
        async function removeUserAuthorDesignation(authorId) {
            if (!confirm('Are you sure you want to remove this user-author designation? The user will lose access to the Author Portal.')) {
                return;
            }
            
            try {
                const supabase = window.DrTroySupabase?.getClient ? window.DrTroySupabase.getClient() : null;
                if (!supabase) throw new Error('Database connection unavailable');
                
                // Remove the email and user_id from the author record (breaks the connection)
                const { error } = await supabase
                    .from('authors')
                    .update({ 
                        email: null,
                        user_id: null 
                    })
                    .eq('id', authorId);
                
                if (error) throw error;
                
                showAlert('‚úÖ User-author designation removed successfully', 'success');
                
                // Refresh the list
                await loadUserAuthorDesignations();
                
            } catch (error) {
                console.error('Error removing user-author designation:', error);
                showAlert('Error removing designation: ' + error.message, 'error');
            }
        }

        function copyReferralLink() {
            const input = document.getElementById('myReferralLink');
            input.select();
            navigator.clipboard.writeText(input.value).then(() => {
                const confirm = document.getElementById('copyRefConfirm');
                confirm.style.display = 'block';
                setTimeout(() => confirm.style.display = 'none', 3000);
            });
        }

    </script>

    <script>
        // Mobile hamburger menu
        (function() {
            const btn = document.querySelector('.hamburger');
            const nav = document.querySelector('.nav-links');
            if (btn && nav) {
                btn.addEventListener('click', () => nav.classList.toggle('active'));
                nav.querySelectorAll('a').forEach(a => {
                    a.addEventListener('click', () => nav.classList.remove('active'));
                });
                window.addEventListener('scroll', () => nav.classList.remove('active'), {passive: true});
                document.addEventListener('click', (e) => {
                    if (!nav.contains(e.target) && !btn.contains(e.target)) nav.classList.remove('active');
                });
            }
        })();
    </script>
</body>
</html>