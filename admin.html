<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>DrTroy.com - Admin Dashboard</title>
    
    <!-- Security Headers -->
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self';
        script-src 'self' 'unsafe-inline';
        style-src 'self' 'unsafe-inline';
        img-src 'self' data: https:;
        connect-src 'self' https://*.supabase.co;
    ">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-Frame-Options" content="DENY">
    <meta http-equiv="X-XSS-Protection" content="1; mode=block">
    
    <style>
        :root {
            --navy: #1a365d;
            --navy-light: #2c5282;
            --navy-dark: #0f2a44;
            --blue-accent: #3182ce;
            --blue-light: #4299e1;
            --white: #ffffff;
            --gray-50: #f7fafc;
            --gray-100: #edf2f7;
            --gray-200: #e2e8f0;
            --gray-300: #cbd5e0;
            --gray-600: #4a5568;
            --gray-800: #2d3748;
            --gray-900: #1a202c;
            --gray-warm: #4a5568;
            --charcoal: #2d3748;
            --success: #059669;
            --warning: #f59e0b;
            --danger: #dc2626;
            --info: #3182ce;
            --shadow-blue: rgba(26, 54, 93, 0.15);
            --shadow-deep: rgba(0, 0, 0, 0.25);
            --gradient-primary: linear-gradient(135deg, var(--navy), var(--blue-accent));
            --gradient-light: linear-gradient(135deg, var(--gray-50), var(--white));
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Lora', serif;
            background: var(--gray-50);
            color: var(--charcoal);
            line-height: 1.6;
            position: relative;
            min-height: 100vh;
        }

        /* Sophisticated admin background pattern */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 10% 20%, rgba(26, 54, 93, 0.02) 0%, transparent 25%),
                radial-gradient(circle at 90% 80%, rgba(49, 130, 206, 0.03) 0%, transparent 20%),
                linear-gradient(135deg, transparent 0%, rgba(26, 54, 93, 0.01) 50%, transparent 100%);
            pointer-events: none;
            z-index: 0;
        }

        /* Premium admin header */
        .header {
            background: var(--white);
            box-shadow: 
                0 4px 20px rgba(26, 54, 93, 0.08),
                0 1px 4px rgba(0, 0, 0, 0.04);
            border-bottom: 1px solid var(--gray-100);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-primary);
        }

        .header-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px 30px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: relative;
            z-index: 1;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 30px;
        }

        .admin-logo {
            font-family: 'Crimson Text', serif;
            font-size: 1.8rem;
            font-weight: 600;
            color: var(--navy);
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .admin-logo::before {
            content: '‚ö°';
            font-size: 1.5rem;
        }

        .header-nav {
            display: flex;
            gap: 25px;
        }

        .header-nav a {
            font-family: 'Oswald', sans-serif;
            font-size: 0.9rem;
            font-weight: 400;
            color: var(--gray-warm);
            text-decoration: none;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            padding: 8px 0;
            position: relative;
            transition: all 0.3s ease;
        }

        .header-nav a::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 0;
            height: 2px;
            background: var(--blue-accent);
            transition: width 0.3s ease;
        }

        .header-nav a:hover,
        .header-nav a.active {
            color: var(--navy);
        }

        .header-nav a:hover::after,
        .header-nav a.active::after {
            width: 100%;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .admin-user {
            display: flex;
            align-items: center;
            gap: 12px;
            background: var(--gradient-light);
            padding: 12px 20px;
            border-radius: 25px;
            border: 1px solid var(--gray-200);
            box-shadow: 0 2px 8px rgba(26, 54, 93, 0.05);
        }

        .admin-user-avatar {
            width: 32px;
            height: 32px;
            background: var(--gradient-primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--white);
            font-family: 'Oswald', sans-serif;
            font-weight: 500;
            font-size: 0.9rem;
        }

        .admin-user-name {
            font-family: 'Oswald', sans-serif;
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--navy);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* Main container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 40px 30px;
            position: relative;
            z-index: 1;
        }

        /* Admin Dashboard Grid */
        .admin-grid {
            display: grid;
            grid-template-columns: 280px 1fr;
            gap: 40px;
            margin-bottom: 40px;
        }

        /* Sidebar */
        .admin-sidebar {
            background: var(--white);
            border-radius: 20px;
            box-shadow: 
                0 20px 40px rgba(26, 54, 93, 0.08),
                0 4px 12px rgba(0, 0, 0, 0.04);
            border: 1px solid var(--gray-100);
            padding: 30px 0;
            height: fit-content;
            position: sticky;
            top: 120px;
        }

        .admin-sidebar::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-primary);
            border-radius: 20px 20px 0 0;
        }

        .sidebar-section {
            margin-bottom: 30px;
        }

        .sidebar-title {
            font-family: 'Oswald', sans-serif;
            font-size: 0.8rem;
            font-weight: 500;
            color: var(--gray-warm);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            padding: 0 30px;
            margin-bottom: 15px;
        }

        .sidebar-nav {
            display: flex;
            flex-direction: column;
        }

        .sidebar-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 30px;
            color: var(--gray-warm);
            text-decoration: none;
            font-family: 'Oswald', sans-serif;
            font-size: 0.9rem;
            font-weight: 400;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            border-left: 4px solid transparent;
            cursor: pointer;
        }

        .sidebar-item:hover,
        .sidebar-item.active {
            background: var(--gradient-light);
            color: var(--navy);
            border-left-color: var(--blue-accent);
            font-weight: 500;
        }

        .sidebar-item-icon {
            font-size: 1rem;
            width: 20px;
            text-align: center;
        }

        /* Main content area */
        .admin-main {
            background: var(--white);
            border-radius: 20px;
            box-shadow: 
                0 20px 40px rgba(26, 54, 93, 0.08),
                0 4px 12px rgba(0, 0, 0, 0.04);
            border: 1px solid var(--gray-100);
            padding: 40px;
            min-height: 600px;
            position: relative;
            overflow: hidden;
        }

        .admin-main::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-primary);
            border-radius: 20px 20px 0 0;
        }

        /* Content sections */
        .admin-section {
            display: none;
        }

        .admin-section.active {
            display: block;
        }

        .section-header {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--gray-100);
        }

        .section-title {
            font-family: 'Crimson Text', serif;
            font-size: 2.2rem;
            font-weight: 600;
            color: var(--navy);
            margin-bottom: 8px;
            letter-spacing: -0.02em;
        }

        .section-subtitle {
            font-family: 'Oswald', sans-serif;
            font-size: 0.9rem;
            color: var(--gray-warm);
            font-weight: 400;
            letter-spacing: 0.08em;
            text-transform: uppercase;
        }

        /* Dashboard overview cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: var(--gradient-light);
            border: 2px solid var(--gray-100);
            border-radius: 16px;
            padding: 25px;
            text-align: center;
            transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--gradient-primary);
        }

        .stat-card:hover {
            transform: translateY(-6px);
            box-shadow: 
                0 20px 40px rgba(26, 54, 93, 0.12),
                0 6px 16px rgba(0, 0, 0, 0.06);
            border-color: var(--blue-accent);
        }

        .stat-number {
            font-family: 'Crimson Text', serif;
            font-size: 2.2rem;
            font-weight: 600;
            color: var(--navy);
            margin-bottom: 8px;
            line-height: 1;
        }

        .stat-label {
            font-family: 'Oswald', sans-serif;
            font-size: 0.85rem;
            color: var(--gray-warm);
            font-weight: 400;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .stat-change {
            font-size: 0.8rem;
            margin-top: 8px;
            padding: 4px 8px;
            border-radius: 12px;
            font-family: 'Oswald', sans-serif;
            font-weight: 500;
        }

        .stat-change.positive {
            background: #d1fae5;
            color: #065f46;
        }

        .stat-change.negative {
            background: #fee2e2;
            color: #991b1b;
        }

        /* Data tables */
        .table-container {
            background: var(--white);
            border-radius: 16px;
            box-shadow: 
                0 12px 28px rgba(26, 54, 93, 0.08),
                0 2px 8px rgba(0, 0, 0, 0.04);
            border: 1px solid var(--gray-100);
            overflow: hidden;
            margin-bottom: 30px;
        }

        .table-header {
            background: var(--gradient-light);
            padding: 20px 25px;
            border-bottom: 2px solid var(--gray-100);
        }

        .table-title {
            font-family: 'Crimson Text', serif;
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--navy);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-family: 'Lora', serif;
        }

        .data-table thead {
            background: var(--gray-50);
        }

        .data-table th {
            padding: 16px 25px;
            text-align: left;
            font-family: 'Oswald', sans-serif;
            font-size: 0.8rem;
            font-weight: 500;
            color: var(--navy);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border-bottom: 2px solid var(--gray-200);
        }

        .data-table td {
            padding: 16px 25px;
            border-bottom: 1px solid var(--gray-100);
            color: var(--charcoal);
            font-size: 0.95rem;
            line-height: 1.4;
        }

        .data-table tbody tr:hover {
            background: var(--gray-50);
        }

        /* Forms */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .form-section {
            background: var(--gradient-light);
            border: 2px solid var(--gray-100);
            border-radius: 16px;
            padding: 30px;
        }

        .form-section h3 {
            font-family: 'Crimson Text', serif;
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--navy);
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-family: 'Oswald', sans-serif;
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--navy);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .form-control {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--gray-200);
            border-radius: 8px;
            background: var(--white);
            color: var(--charcoal);
            font-family: 'Lora', serif;
            font-size: 0.95rem;
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            outline: none;
        }

        .form-control:focus {
            border-color: var(--blue-accent);
            box-shadow: 
                0 0 0 4px rgba(49, 130, 206, 0.1),
                0 4px 12px rgba(26, 54, 93, 0.08);
            transform: translateY(-1px);
        }

        .form-control[readonly] {
            background: var(--gray-50);
            color: var(--gray-600);
        }

        select.form-control {
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%234a5568' stroke-width='2'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 16px;
            padding-right: 40px;
        }

        textarea.form-control {
            resize: vertical;
            min-height: 100px;
        }

        /* Buttons */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-family: 'Oswald', sans-serif;
            font-weight: 500;
            font-size: 0.9rem;
            letter-spacing: 0.05em;
            text-transform: uppercase;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            cursor: pointer;
            min-height: 44px;
            position: relative;
            overflow: hidden;
        }

        .btn-primary {
            background: var(--gradient-primary);
            color: var(--white);
            box-shadow: 
                0 4px 12px rgba(26, 54, 93, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }

        .btn-primary::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(66, 153, 225, 0.3), transparent);
            transition: left 0.6s ease;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 
                0 8px 25px rgba(26, 54, 93, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
        }

        .btn-primary:hover::before {
            left: 100%;
        }

        .btn-secondary {
            background: var(--white);
            color: var(--navy);
            border: 2px solid var(--navy);
            box-shadow: 0 2px 8px rgba(26, 54, 93, 0.1);
        }

        .btn-secondary:hover {
            background: var(--navy);
            color: var(--white);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(26, 54, 93, 0.25);
        }

        .btn-success {
            background: var(--success);
            color: var(--white);
            box-shadow: 0 4px 12px rgba(5, 150, 105, 0.3);
        }

        .btn-success:hover {
            background: #047857;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(5, 150, 105, 0.4);
        }

        .btn-warning {
            background: var(--warning);
            color: var(--white);
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
        }

        .btn-warning:hover {
            background: #d97706;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(245, 158, 11, 0.4);
        }

        .btn-danger {
            background: var(--danger);
            color: var(--white);
            box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
        }

        .btn-danger:hover {
            background: #b91c1c;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(220, 38, 38, 0.4);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        /* Badges and status indicators */
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 6px 12px;
            border-radius: 16px;
            font-family: 'Oswald', sans-serif;
            font-size: 0.75rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .badge-primary {
            background: var(--navy);
            color: var(--white);
        }

        .badge-success {
            background: var(--success);
            color: var(--white);
        }

        .badge-warning {
            background: var(--warning);
            color: var(--white);
        }

        .badge-danger {
            background: var(--danger);
            color: var(--white);
        }

        .badge-info {
            background: var(--info);
            color: var(--white);
        }

        .badge-light {
            background: var(--gray-200);
            color: var(--charcoal);
        }

        /* Alerts */
        .alert {
            padding: 16px 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            font-family: 'Lora', serif;
            font-weight: 500;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            border-left: 4px solid;
        }

        .alert-success {
            background: #d1fae5;
            color: #047857;
            border-left-color: var(--success);
        }

        .alert-info {
            background: #dbeafe;
            color: #1e40af;
            border-left-color: var(--info);
        }

        .alert-warning {
            background: #fef3cd;
            color: #92400e;
            border-left-color: var(--warning);
        }

        .alert-danger {
            background: #fee2e2;
            color: #991b1b;
            border-left-color: var(--danger);
        }

        /* Progress bars */
        .progress-container {
            background: var(--gray-200);
            border-radius: 8px;
            overflow: hidden;
            height: 8px;
            margin: 8px 0;
        }

        .progress-bar {
            background: var(--gradient-primary);
            height: 100%;
            transition: width 0.8s cubic-bezier(0.16, 1, 0.3, 1);
            position: relative;
            overflow: hidden;
        }

        .progress-bar::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        /* Loading states */
        .loading {
            opacity: 0.6;
            pointer-events: none;
            position: relative;
        }

        .loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 24px;
            height: 24px;
            margin: -12px 0 0 -12px;
            border: 3px solid var(--gray-300);
            border-top-color: var(--blue-accent);
            border-radius: 50%;
            animation: spin 1s infinite linear;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Mobile responsiveness */
        @media (max-width: 1024px) {
            .admin-grid {
                grid-template-columns: 1fr;
                gap: 25px;
            }
            
            .admin-sidebar {
                position: static;
                border-radius: 16px;
            }
            
            .container {
                padding: 30px 20px;
            }
        }

        @media (max-width: 768px) {
            .header-container {
                padding: 15px 20px;
                flex-direction: column;
                gap: 15px;
            }
            
            .header-left,
            .header-right {
                width: 100%;
                justify-content: center;
            }
            
            .header-nav {
                gap: 15px;
                flex-wrap: wrap;
            }
            
            .container {
                padding: 20px 15px;
            }
            
            .admin-main {
                padding: 25px;
                border-radius: 16px;
            }
            
            .section-title {
                font-size: 1.8rem;
            }
            
            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 20px;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .form-section {
                padding: 20px;
            }
            
            .btn-group {
                flex-direction: column;
                align-items: stretch;
            }
            
            .btn {
                width: 100%;
            }
        }

        @media (max-width: 480px) {
            .admin-main,
            .admin-sidebar,
            .form-section {
                padding: 20px 15px;
            }
            
            .section-title {
                font-size: 1.5rem;
            }
            
            .data-table th,
            .data-table td {
                padding: 12px 15px;
                font-size: 0.85rem;
            }
            
            .stat-card {
                padding: 20px 15px;
            }
        }

        /* Scroll improvements */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--gray-100);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--navy);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--blue-accent);
        }

        /* Custom admin components */
        .quick-actions {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 30px;
        }

        .metric-card {
            background: var(--white);
            border: 2px solid var(--gray-100);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .metric-card:hover {
            border-color: var(--blue-accent);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(26, 54, 93, 0.1);
        }

        .metric-title {
            font-family: 'Oswald', sans-serif;
            font-size: 0.8rem;
            font-weight: 500;
            color: var(--gray-warm);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 8px;
        }

        .metric-value {
            font-family: 'Crimson Text', serif;
            font-size: 1.8rem;
            font-weight: 600;
            color: var(--navy);
        }

        .metric-change {
            font-size: 0.85rem;
            margin-top: 5px;
        }

        .search-box {
            position: relative;
            margin-bottom: 20px;
        }

        .search-box input {
            padding-left: 40px;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%234a5568' stroke-width='2'%3e%3ccircle cx='11' cy='11' r='8'%3e%3c/circle%3e%3cpath d='m21 21-4.35-4.35'%3e%3c/path%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: 12px center;
            background-size: 18px;
        }

        .filter-tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 25px;
            background: var(--gray-50);
            padding: 5px;
            border-radius: 12px;
            border: 1px solid var(--gray-200);
        }

        .filter-tab {
            flex: 1;
            padding: 10px 16px;
            background: transparent;
            border: none;
            border-radius: 8px;
            font-family: 'Oswald', sans-serif;
            font-size: 0.85rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--gray-warm);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .filter-tab.active {
            background: var(--white);
            color: var(--navy);
            box-shadow: 0 2px 4px rgba(26, 54, 93, 0.1);
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--gray-warm);
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .empty-state-message {
            font-family: 'Crimson Text', serif;
            font-size: 1.3rem;
            font-weight: 500;
            margin-bottom: 10px;
        }

        .empty-state-description {
            font-size: 0.95rem;
            line-height: 1.6;
        }
    </style></head>
<body>
    <div class="header">
        <h1>DrTroy.com Admin Dashboard</h1>
        <div class="header-info">
            <span class="status-indicator">‚óè Online</span>
            <span>Last updated: <span id="lastUpdate">Loading...</span></span>
            <button onclick="window.open('system-settings.html', '_blank')" style="background: var(--navy); color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; margin-left: 1rem; font-size: 0.9rem; font-weight: 600;" 
                    onmouseover="this.style.background='#1e40af'" 
                    onmouseout="this.style.background='var(--navy)'"
                    title="Open System Settings">
                üñ•Ô∏è System
            </button>
            <button onclick="logout()" style="background: #dc2626; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; margin-left: 1rem; font-size: 0.9rem; font-weight: 600;" 
                    onmouseover="this.style.background='#b91c1c'" 
                    onmouseout="this.style.background='#dc2626'">
                üö™ Logout
            </button>
        </div>
    </div>

    <div class="container">
        <!-- Main Navigation -->
        <div class="main-tabs">
            <button class="main-tab" onclick="switchMainTab('dashboard')">
                üìä Dashboard
            </button>
            <button class="main-tab" onclick="switchMainTab('users')">
                üë• User Management
            </button>
            <button class="main-tab" onclick="switchMainTab('courses')">
                üìö Course Content
            </button>
            <button class="main-tab" onclick="switchMainTab('emails')">
                üìß Email System
            </button>
            <button class="main-tab" onclick="switchMainTab('licenses')">
                üéì License Tracking
            </button>
            <button class="main-tab" onclick="switchMainTab('discount-codes')">
                üí∞ Discount Codes
            </button>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content">
            <!-- Platform Overview -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">üìä Platform Overview</h2>
                </div>
                <div class="card-body">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number" id="totalUsers">0</div>
                            <div class="stat-label">Total Users</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="monthlyRevenue">$0</div>
                            <div class="stat-label">Monthly Revenue</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="courseCompletions">0</div>
                            <div class="stat-label">Course Completions</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="upcomingRenewals">0</div>
                            <div class="stat-label">Upcoming Renewals</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">üîî Recent Activity</h2>
                </div>
                <div class="card-body">
                    <div id="recentActivity">
                        <div class="activity-item">
                            <div class="activity-time">2 hours ago</div>
                            <div class="activity-content">New user registration: Jane Smith (PT)</div>
                        </div>
                        <div class="activity-item">
                            <div class="activity-time">5 hours ago</div>
                            <div class="activity-content">Course completed: Fall Prevention - Dr. Michael Johnson</div>
                        </div>
                        <div class="activity-item">
                            <div class="activity-time">1 day ago</div>
                            <div class="activity-content">License renewal reminder sent to 15 users</div>
                        </div>
                        <div class="activity-item">
                            <div class="activity-time">2 days ago</div>
                            <div class="activity-content">Marketing campaign "Spring2026" launched</div>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <!-- User Management Tab -->
        <div id="users" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">üë• User Management</h2>
                    <div style="display: flex; gap: 1rem;">
                        <button class="btn btn-secondary" onclick="exportUsers()">üì• Export Users</button>
                        <button class="btn btn-primary" onclick="showAddUserForm()">üë§ Add User</button>
                    </div>
                </div>
                <div class="card-body">
                    <!-- User Search and Filters -->
                    <div style="display: grid; grid-template-columns: 1fr auto auto; gap: 1rem; margin-bottom: 2rem;">
                        <input type="text" id="userSearch" class="form-input" placeholder="Search users by name, email, or license number">
                        <select id="userFilter" class="form-select">
                            <option value="all">All Users</option>
                            <option value="PT">Physical Therapists</option>
                            <option value="PTA">PT Assistants</option>
                            <option value="OT">Occupational Therapists</option>
                            <option value="COTA">OT Assistants</option>
                        </select>
                        <select id="statusFilter" class="form-select">
                            <option value="all">All Status</option>
                            <option value="active">Active</option>
                            <option value="expired">License Expired</option>
                            <option value="warning">Renewal Warning</option>
                        </select>
                    </div>

                    <!-- Users Table -->
                    <div style="overflow-x: auto;">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Discipline</th>
                                    <th>License #</th>
                                    <th>State</th>
                                    <th>Expires</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody">
                                <!-- Sample users -->
                                <tr>
                                    <td>Dr. Sarah Johnson</td>
                                    <td>sarah.johnson@email.com</td>
                                    <td>PT</td>
                                    <td>TX12345</td>
                                    <td>TX</td>
                                    <td>December 2026</td>
                                    <td><span class="status-badge active">Active</span></td>
                                    <td>
                                        <button class="btn-small" onclick="viewUser('sarah.johnson@email.com')">View</button>
                                        <button class="btn-small" onclick="emailUser('sarah.johnson@email.com')">Email</button>
                                    </td>
                                </tr>
                                <tr>
                                    <td>Michael Chen</td>
                                    <td>m.chen@email.com</td>
                                    <td>OT</td>
                                    <td>CA67890</td>
                                    <td>CA</td>
                                    <td>March 2026</td>
                                    <td><span class="status-badge warning">Renewal Soon</span></td>
                                    <td>
                                        <button class="btn-small" onclick="viewUser('m.chen@email.com')">View</button>
                                        <button class="btn-small" onclick="emailUser('m.chen@email.com')">Email</button>
                                    </td>
                                </tr>
                                <tr>
                                    <td>Lisa Rodriguez</td>
                                    <td>lisa.r@email.com</td>
                                    <td>PTA</td>
                                    <td>FL54321</td>
                                    <td>FL</td>
                                    <td>January 2026</td>
                                    <td><span class="status-badge expired">Expired</span></td>
                                    <td>
                                        <button class="btn-small" onclick="viewUser('lisa.r@email.com')">View</button>
                                        <button class="btn-small" onclick="emailUser('lisa.r@email.com')">Email</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Course Content Tab -->
        <div id="courses" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">üìö Course Content Management</h2>
                    <div style="display: flex; gap: 1rem;">
                        <button class="btn btn-secondary" onclick="exportCourseData()">üì• Export Data</button>
                        <button class="btn btn-primary" onclick="showAddCourseForm()">‚ûï Add Course</button>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Course Statistics -->
                    <div class="stats-grid" style="margin-bottom: 2rem;">
                        <div class="stat-card">
                            <div class="stat-number">12</div>
                            <div class="stat-label">Total Courses</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">8</div>
                            <div class="stat-label">Active Courses</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">89%</div>
                            <div class="stat-label">Avg Completion Rate</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">4.8</div>
                            <div class="stat-label">Avg Rating</div>
                        </div>
                    </div>

                    <!-- Course List -->
                    <div class="course-grid">
                        <div class="course-card">
                            <div class="course-header">
                                <h3>Fall Prevention & Mobility</h3>
                                <div class="course-status active">Active</div>
                            </div>
                            <div class="course-meta">
                                <div>CCU Value: 2 hours</div>
                                <div>Enrollments: 45</div>
                                <div>Completion: 92%</div>
                            </div>
                            <div class="course-actions">
                                <button class="btn-small" onclick="editCourse('fall-prevention')">‚úèÔ∏è Edit</button>
                                <button class="btn-small" onclick="viewStats('fall-prevention')">üìä Stats</button>
                                <button class="btn-small" onclick="manageCourse('fall-prevention')">‚öôÔ∏è Manage</button>
                            </div>
                        </div>

                        <div class="course-card">
                            <div class="course-header">
                                <h3>Ethics in Healthcare</h3>
                                <div class="course-status active">Active</div>
                            </div>
                            <div class="course-meta">
                                <div>CCU Value: 2 hours</div>
                                <div>Enrollments: 38</div>
                                <div>Completion: 85%</div>
                            </div>
                            <div class="course-actions">
                                <button class="btn-small" onclick="editCourse('ethics')">‚úèÔ∏è Edit</button>
                                <button class="btn-small" onclick="viewStats('ethics')">üìä Stats</button>
                                <button class="btn-small" onclick="manageCourse('ethics')">‚öôÔ∏è Manage</button>
                            </div>
                        </div>

                        <div class="course-card">
                            <div class="course-header">
                                <h3>PT Musculoskeletal Assessment</h3>
                                <div class="course-status draft">Draft</div>
                            </div>
                            <div class="course-meta">
                                <div>CCU Value: 3 hours</div>
                                <div>Enrollments: 0</div>
                                <div>Completion: N/A</div>
                            </div>
                            <div class="course-actions">
                                <button class="btn-small" onclick="editCourse('msk-assessment')">‚úèÔ∏è Edit</button>
                                <button class="btn-small" onclick="publishCourse('msk-assessment')">üöÄ Publish</button>
                                <button class="btn-small" onclick="manageCourse('msk-assessment')">‚öôÔ∏è Manage</button>
                            </div>
                        </div>
                    </div>

                    <!-- Bulk Course Operations -->
                    <div class="card" style="margin-top: 2rem;">
                        <div class="card-header">
                            <h3>Bulk Operations</h3>
                        </div>
                        <div class="card-body">
                            <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                                <button class="btn btn-secondary" onclick="updateAllCourses()">üîÑ Update All Courses</button>
                                <button class="btn btn-secondary" onclick="exportCourseContent()">üì¶ Export Content</button>
                                <button class="btn btn-secondary" onclick="generateCertificates()">üèÜ Generate Certificates</button>
                                <button class="btn btn-secondary" onclick="notifyIncompleteCourses()">üìß Notify Incomplete</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Email System Tab -->
        <div id="emails" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">üìß Email System Management</h2>
                    <div style="display: flex; gap: 1rem;">
                        <button class="btn btn-secondary" onclick="exportEmailData()">üì• Export Logs</button>
                        <button class="btn btn-primary" onclick="showComposeEmail()">‚úâÔ∏è Compose Email</button>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Email Statistics -->
                    <div class="stats-grid" style="margin-bottom: 2rem;">
                        <div class="stat-card">
                            <div class="stat-number">1,247</div>
                            <div class="stat-label">Total Sent</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">95.8%</div>
                            <div class="stat-label">Delivery Rate</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">68.4%</div>
                            <div class="stat-label">Open Rate</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">12.3%</div>
                            <div class="stat-label">Click Rate</div>
                        </div>
                    </div>

                    <!-- Email Campaign Management -->
                    <div class="sub-tabs">
                        <button class="sub-tab active" onclick="switchEmailTab('campaigns')">üì¢ Campaigns</button>
                        <button class="sub-tab" onclick="switchEmailTab('renewals')">üéì License Renewals</button>
                        <button class="sub-tab" onclick="switchEmailTab('templates')">üìù Templates</button>
                        <button class="sub-tab" onclick="switchEmailTab('logs')">üìã Email Logs</button>
                    </div>

                    <!-- Email Campaigns -->
                    <div id="email-campaigns" class="sub-content active">
                        <div class="campaign-list">
                            <div class="campaign-item">
                                <div class="campaign-header">
                                    <h3>Spring 2026 Promotion</h3>
                                    <div class="campaign-status active">Active</div>
                                </div>
                                <div class="campaign-meta">
                                    <div>Recipients: 234</div>
                                    <div>Opens: 156 (66.7%)</div>
                                    <div>Clicks: 28 (12.0%)</div>
                                    <div>Sent: Feb 10, 2026</div>
                                </div>
                                <div class="campaign-actions">
                                    <button class="btn-small" onclick="viewCampaign('spring-2026')">üìä View Stats</button>
                                    <button class="btn-small" onclick="duplicateCampaign('spring-2026')">üìã Duplicate</button>
                                    <button class="btn-small" onclick="stopCampaign('spring-2026')">‚èπÔ∏è Stop</button>
                                </div>
                            </div>

                            <div class="campaign-item">
                                <div class="campaign-header">
                                    <h3>New Course Announcement</h3>
                                    <div class="campaign-status draft">Draft</div>
                                </div>
                                <div class="campaign-meta">
                                    <div>Recipients: 312</div>
                                    <div>Status: Scheduled for Feb 20</div>
                                </div>
                                <div class="campaign-actions">
                                    <button class="btn-small" onclick="editCampaign('new-course')">‚úèÔ∏è Edit</button>
                                    <button class="btn-small" onclick="sendCampaign('new-course')">üöÄ Send Now</button>
                                    <button class="btn-small" onclick="deleteCampaign('new-course')">üóëÔ∏è Delete</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- License Renewal Emails -->
                    <div id="email-renewals" class="sub-content">
                        <div class="renewal-stats">
                            <div class="stat-card">
                                <div class="stat-number">45</div>
                                <div class="stat-label">6-Month Reminders Sent</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number">28</div>
                                <div class="stat-label">1-Month Reminders Sent</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number">12</div>
                                <div class="stat-label">Final Warnings Sent</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number">89%</div>
                                <div class="stat-label">Response Rate</div>
                            </div>
                        </div>

                        <div class="renewal-controls">
                            <h3>Renewal Email Controls</h3>
                            <div style="display: flex; gap: 1rem; margin: 1rem 0;">
                                <button class="btn btn-primary" onclick="sendRenewalReminders()">üìß Send Due Reminders</button>
                                <button class="btn btn-secondary" onclick="previewRenewalEmail()">üëÅÔ∏è Preview Template</button>
                                <button class="btn btn-secondary" onclick="testRenewalEmail()">üß™ Send Test Email</button>
                            </div>
                            <div class="info-box">
                                <strong>Automated System:</strong> Renewal reminders are sent automatically at 6 months, 1 month, and 1 week before license expiration. You can also trigger manual sends here.
                            </div>
                        </div>
                    </div>

                    <!-- Email Templates -->
                    <div id="email-templates" class="sub-content">
                        <div class="template-list">
                            <div class="template-item">
                                <h3>License Renewal - 6 Month Warning</h3>
                                <p>Friendly reminder template for users with 6 months until renewal</p>
                                <div class="template-actions">
                                    <button class="btn-small" onclick="editTemplate('renewal-6mo')">‚úèÔ∏è Edit</button>
                                    <button class="btn-small" onclick="previewTemplate('renewal-6mo')">üëÅÔ∏è Preview</button>
                                </div>
                            </div>
                            <div class="template-item">
                                <h3>License Renewal - 1 Month Warning</h3>
                                <p>Urgent reminder template for users with 1 month until renewal</p>
                                <div class="template-actions">
                                    <button class="btn-small" onclick="editTemplate('renewal-1mo')">‚úèÔ∏è Edit</button>
                                    <button class="btn-small" onclick="previewTemplate('renewal-1mo')">üëÅÔ∏è Preview</button>
                                </div>
                            </div>
                            <div class="template-item">
                                <h3>License Renewal - Final Notice</h3>
                                <p>Final warning template for users with less than 1 week</p>
                                <div class="template-actions">
                                    <button class="btn-small" onclick="editTemplate('renewal-final')">‚úèÔ∏è Edit</button>
                                    <button class="btn-small" onclick="previewTemplate('renewal-final')">üëÅÔ∏è Preview</button>
                                </div>
                            </div>
                            <div class="template-item">
                                <h3>Welcome Email</h3>
                                <p>Welcome message for new user registrations</p>
                                <div class="template-actions">
                                    <button class="btn-small" onclick="editTemplate('welcome')">‚úèÔ∏è Edit</button>
                                    <button class="btn-small" onclick="previewTemplate('welcome')">üëÅÔ∏è Preview</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Email Logs -->
                    <div id="email-logs" class="sub-content">
                        <div style="overflow-x: auto;">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Recipient</th>
                                        <th>Subject</th>
                                        <th>Type</th>
                                        <th>Status</th>
                                        <th>Sent</th>
                                        <th>Opened</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>sarah.johnson@email.com</td>
                                        <td>License Renewal Reminder</td>
                                        <td>Renewal</td>
                                        <td><span class="status-badge delivered">Delivered</span></td>
                                        <td>Feb 15, 2:30 PM</td>
                                        <td>Feb 15, 3:45 PM</td>
                                        <td>
                                            <button class="btn-small" onclick="viewEmail('email123')">üëÅÔ∏è View</button>
                                            <button class="btn-small" onclick="resendEmail('email123')">üîÑ Resend</button>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>m.chen@email.com</td>
                                        <td>New Course Available</td>
                                        <td>Campaign</td>
                                        <td><span class="status-badge opened">Opened</span></td>
                                        <td>Feb 14, 9:00 AM</td>
                                        <td>Feb 14, 11:20 AM</td>
                                        <td>
                                            <button class="btn-small" onclick="viewEmail('email124')">üëÅÔ∏è View</button>
                                            <button class="btn-small" onclick="resendEmail('email124')">üîÑ Resend</button>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>lisa.r@email.com</td>
                                        <td>Welcome to DrTroy.com</td>
                                        <td>Welcome</td>
                                        <td><span class="status-badge bounced">Bounced</span></td>
                                        <td>Feb 13, 4:15 PM</td>
                                        <td>-</td>
                                        <td>
                                            <button class="btn-small" onclick="viewEmail('email125')">üëÅÔ∏è View</button>
                                            <button class="btn-small" onclick="updateEmail('email125')">‚úèÔ∏è Update</button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- License Tracking Tab -->
        <div id="licenses" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">üéì License Tracking & Monitoring</h2>
                    <div style="display: flex; gap: 1rem;">
                        <button class="btn btn-secondary" onclick="exportLicenseData()">üì• Export Report</button>
                        <button class="btn btn-primary" onclick="sendBulkReminders()">üìß Send Reminders</button>
                    </div>
                </div>
                <div class="card-body">
                    <!-- License Statistics -->
                    <div class="stats-grid" style="margin-bottom: 2rem;">
                        <div class="stat-card">
                            <div class="stat-number" style="color: #dc2626;">8</div>
                            <div class="stat-label">Expired Licenses</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" style="color: #d69e2e;">15</div>
                            <div class="stat-label">Expiring Soon (30 days)</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" style="color: #059669;">234</div>
                            <div class="stat-label">Active Licenses</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">89%</div>
                            <div class="stat-label">Renewal Rate</div>
                        </div>
                    </div>

                    <!-- License Filter and Search -->
                    <div style="display: grid; grid-template-columns: 1fr auto auto auto; gap: 1rem; margin-bottom: 2rem;">
                        <input type="text" id="licenseSearch" class="form-input" placeholder="Search by name, license number, or email">
                        <select id="stateFilter" class="form-select">
                            <option value="all">All States</option>
                            <option value="TX">Texas</option>
                            <option value="CA">California</option>
                            <option value="FL">Florida</option>
                            <option value="NY">New York</option>
                        </select>
                        <select id="disciplineFilter" class="form-select">
                            <option value="all">All Disciplines</option>
                            <option value="PT">Physical Therapist</option>
                            <option value="PTA">PT Assistant</option>
                            <option value="OT">Occupational Therapist</option>
                            <option value="COTA">OT Assistant</option>
                        </select>
                        <select id="urgencyFilter" class="form-select">
                            <option value="all">All Status</option>
                            <option value="expired">Expired</option>
                            <option value="critical">Critical (‚â§30 days)</option>
                            <option value="warning">Warning (‚â§90 days)</option>
                            <option value="safe">Safe (>90 days)</option>
                        </select>
                    </div>

                    <!-- License Tracking Table -->
                    <div style="overflow-x: auto;">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>License #</th>
                                    <th>State</th>
                                    <th>Discipline</th>
                                    <th>Expires</th>
                                    <th>Days Left</th>
                                    <th>CCU Progress</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr class="license-critical">
                                    <td>Dr. Sarah Johnson</td>
                                    <td>TX12345</td>
                                    <td>TX</td>
                                    <td>PT</td>
                                    <td>March 15, 2026</td>
                                    <td class="urgent">18 days</td>
                                    <td>
                                        <div class="progress-mini">
                                            <div class="progress-bar" style="width: 85%"></div>
                                            <span>23/27 CCUs</span>
                                        </div>
                                    </td>
                                    <td>
                                        <button class="btn-small critical" onclick="sendUrgentReminder('TX12345')">‚ö†Ô∏è Urgent</button>
                                        <button class="btn-small" onclick="viewLicenseDetails('TX12345')">üëÅÔ∏è View</button>
                                    </td>
                                </tr>
                                <tr class="license-warning">
                                    <td>Michael Chen</td>
                                    <td>CA67890</td>
                                    <td>CA</td>
                                    <td>OT</td>
                                    <td>May 30, 2026</td>
                                    <td class="warning">94 days</td>
                                    <td>
                                        <div class="progress-mini">
                                            <div class="progress-bar" style="width: 60%"></div>
                                            <span>14/23 CCUs</span>
                                        </div>
                                    </td>
                                    <td>
                                        <button class="btn-small warning" onclick="sendReminder('CA67890')">üìß Remind</button>
                                        <button class="btn-small" onclick="viewLicenseDetails('CA67890')">üëÅÔ∏è View</button>
                                    </td>
                                </tr>
                                <tr class="license-safe">
                                    <td>Lisa Rodriguez</td>
                                    <td>FL54321</td>
                                    <td>FL</td>
                                    <td>PTA</td>
                                    <td>December 31, 2026</td>
                                    <td class="safe">319 days</td>
                                    <td>
                                        <div class="progress-mini">
                                            <div class="progress-bar" style="width: 35%"></div>
                                            <span>6/17 CCUs</span>
                                        </div>
                                    </td>
                                    <td>
                                        <button class="btn-small" onclick="viewLicenseDetails('FL54321')">üëÅÔ∏è View</button>
                                        <button class="btn-small" onclick="emailUser('lisa.r@email.com')">üìß Contact</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Bulk License Operations -->
                    <div class="card" style="margin-top: 2rem;">
                        <div class="card-header">
                            <h3>Bulk License Operations</h3>
                        </div>
                        <div class="card-body">
                            <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                                <button class="btn btn-secondary" onclick="sendCriticalReminders()">‚ö†Ô∏è Notify Critical (‚â§30 days)</button>
                                <button class="btn btn-secondary" onclick="sendWarningReminders()">üìß Notify Warnings (‚â§90 days)</button>
                                <button class="btn btn-secondary" onclick="updateCCUProgress()">üîÑ Update CCU Progress</button>
                                <button class="btn btn-secondary" onclick="generateRenewalReport()">üìä Generate Report</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Discount Codes Tab (Enhanced) -->
        <div id="discount-codes" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">üí∞ Discount Code Management</h2>
                </div>
                <div class="card-body">
                    <!-- Discount Code Statistics -->
                    <div class="stats-grid" style="margin-bottom: 2rem;">
                        <div class="stat-card">
                            <div class="stat-number" id="totalCodes">0</div>
                            <div class="stat-label">Total Codes Created</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="activeCodes">0</div>
                            <div class="stat-label">Active Codes</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="usedCodes">0</div>
                            <div class="stat-label">Total Redemptions</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="totalSavings">$0</div>
                            <div class="stat-label">Customer Savings</div>
                        </div>
                    </div>

                    <!-- Code Management -->
                    <div class="sub-tabs">
                        <button class="sub-tab active" onclick="switchSubTab('employee')">
                            üè¢ Employee Codes
                        </button>
                        <button class="sub-tab" onclick="switchSubTab('marketing')">
                            üì¢ Marketing Codes
                        </button>

                    <!-- Employee Code Form -->
                    <div id="employee" class="sub-content active">
                        <div class="info-box">
                            <strong>Employee Codes:</strong> One-time use discount codes for your staff members. 
                            Each code provides 100% discount on the selected package type.
                        </div>

                        <form id="employeeForm">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="form-label">Employee Name</label>
                                    <input type="text" id="employeeName" class="form-input" placeholder="Sarah Johnson" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Employee Type</label>
                                    <select id="employeeType" class="form-select" required>
                                        <option value="">Select type</option>
                                        <option value="staff">Staff Member</option>
                                        <option value="contractor">Contractor</option>
                                        <option value="partner">Partner</option>
                                        <option value="trial">Trial User</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Package Type</label>
                                    <select id="employeePackage" class="form-select" required>
                                        <option value="">Select package</option>
                                        <option value="PT">Physical Therapists ($109)</option>
                                        <option value="PTA">Physical Therapist Assistants ($89)</option>
                                        <option value="OT">Occupational Therapists ($109)</option>
                                        <option value="COTA">Certified Occupational Therapy Assistants ($89)</option>
                                    </select>
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Notes (Optional)</label>
                                <input type="text" id="employeeNotes" class="form-input" placeholder="Additional notes about this code">
                            </div>

                            <button type="submit" class="btn btn-primary">
                                üé´ Generate Employee Code
                            </button>
                        </form>

                        <div id="employeeSuccess" class="success-message"></div>
                        <div id="employeeError" class="error-message"></div>
                    </div>

                    <!-- Marketing Code Form -->
                    <div id="marketing" class="sub-content">
                        <div class="info-box">
                            <strong>Marketing Codes:</strong> Flexible discount codes for promotions, campaigns, and customer acquisition.<br>
                            <small>Examples: SPRING25 (25% off), SAVE20 ($20 off), FREEPT (100% free for PTs)</small>
                        </div>

                        <form id="marketingForm">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="form-label">Code Name</label>
                                    <input type="text" id="marketingCodeName" class="form-input" placeholder="SPRING25" style="text-transform: uppercase;" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Discount Type</label>
                                    <select id="marketingDiscountType" class="form-select" required>
                                        <option value="">Select type</option>
                                        <option value="percentage">Percentage Off</option>
                                        <option value="fixed">Fixed Amount Off</option>
                                        <option value="free">100% Free</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Discount Value</label>
                                    <input type="number" id="marketingDiscountValue" class="form-input" placeholder="25" min="0" max="999">
                                </div>
                            </div>

                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="form-label">Usage Limit</label>
                                    <select id="marketingUsageLimit" class="form-select" required>
                                        <option value="unlimited">Unlimited Uses</option>
                                        <option value="limited">Limited Uses</option>
                                        <option value="single">Single Use Only</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Max Uses (if limited)</label>
                                    <input type="number" id="marketingMaxUses" class="form-input" placeholder="100" min="1">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Expiry Date (Optional)</label>
                                    <input type="date" id="marketingExpiry" class="form-input">
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Campaign Name</label>
                                <input type="text" id="marketingCampaign" class="form-input" placeholder="Spring 2026 Promotion">
                            </div>

                            <button type="submit" class="btn btn-primary">
                                üöÄ Create Marketing Code
                            </button>
                        </form>

                        <div id="marketingSuccess" class="success-message"></div>
                        <div id="marketingError" class="error-message"></div>
                    </div>

                    <!-- All Codes Table -->
                    <div class="card" style="margin-top: 2rem;">
                        <div class="card-header">
                            <h3>All Discount Codes</h3>
                        </div>
                        <div class="card-body" style="overflow-x: auto;">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Code</th>
                                        <th>Type</th>
                                        <th>Discount</th>
                                        <th>Usage</th>
                                        <th>Status</th>
                                        <th>Created</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="codesTableBody">
                                    <tr>
                                        <td><strong>EMPLOYEE-SARAH-001</strong></td>
                                        <td>Employee</td>
                                        <td>100% Off</td>
                                        <td>0/1</td>
                                        <td><span class="status-badge active">Active</span></td>
                                        <td>Feb 10, 2026</td>
                                        <td>
                                            <button class="btn-small" onclick="viewCode('EMPLOYEE-SARAH-001')">üëÅÔ∏è View</button>
                                            <button class="btn-small danger" onclick="deactivateCode('EMPLOYEE-SARAH-001')">‚ùå Deactivate</button>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td><strong>SPRING25</strong></td>
                                        <td>Marketing</td>
                                        <td>25% Off</td>
                                        <td>47/100</td>
                                        <td><span class="status-badge active">Active</span></td>
                                        <td>Feb 1, 2026</td>
                                        <td>
                                            <button class="btn-small" onclick="viewCode('SPRING25')">üëÅÔ∏è View</button>
                                            <button class="btn-small" onclick="editCode('SPRING25')">‚úèÔ∏è Edit</button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Analytics Tab -->
        <div id="analytics" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Business Analytics Dashboard</h2>
                </div>
                <div class="card-body">
                    <!-- Analytics Sub-tabs -->
                    <div class="sub-tabs">
                        <button class="sub-tab active" onclick="switchAnalyticsTab('essential')">Essential</button>
                        <button class="sub-tab" onclick="switchAnalyticsTab('revenue')">Revenue</button>
                        <button class="sub-tab" onclick="switchAnalyticsTab('customers')">Customers</button>
                        <button class="sub-tab" onclick="switchAnalyticsTab('marketing')">Marketing</button>
                        <button class="sub-tab" onclick="switchAnalyticsTab('operations')">Operations</button>
                    </div>

                    <!-- Essential Analytics -->
                    <div id="essential-analytics" class="sub-content active">
                        <div class="analytics-metric">
                            <div class="metric-info">
                                <h3>Monthly Revenue</h3>
                                <p>Total revenue from course sales this month</p>
                            </div>
                            <div class="metric-value" id="monthlyRevenue">$0</div>
                        </div>
                        
                        <div class="analytics-metric">
                            <div class="metric-info">
                                <h3>Active Customers</h3>
                                <p>Total customers with active course access</p>
                            </div>
                            <div class="metric-value" id="activeCustomers">0</div>
                        </div>
                        
                        <div class="analytics-metric">
                            <div class="metric-info">
                                <h3>Course Completion Rate</h3>
                                <p>Percentage of customers completing their courses</p>
                            </div>
                            <div class="metric-value" id="completionRate">0%</div>
                        </div>
                        
                        <div class="analytics-metric">
                            <div class="metric-info">
                                <h3>Average Revenue Per User</h3>
                                <p>Average revenue generated per customer</p>
                            </div>
                            <div class="metric-value" id="arpu">$0</div>
                        </div>
                    </div>

                    <!-- Revenue Analytics -->
                    <div id="revenue-analytics" class="sub-content">
                        <div class="analytics-metric">
                            <div class="metric-info">
                                <h3>Total Revenue</h3>
                                <p>All-time revenue from the platform</p>
                            </div>
                            <div class="metric-value" id="totalRevenue">$0</div>
                        </div>
                        
                        <div class="analytics-metric">
                            <div class="metric-info">
                                <h3>PT Package Revenue</h3>
                                <p>Revenue from Physical Therapist packages</p>
                            </div>
                            <div class="metric-value" id="ptRevenue">$0</div>
                        </div>
                        
                        <div class="analytics-metric">
                            <div class="metric-info">
                                <h3>OT Package Revenue</h3>
                                <p>Revenue from Occupational Therapist packages</p>
                            </div>
                            <div class="metric-value" id="otRevenue">$0</div>
                        </div>
                        
                        <div class="analytics-metric">
                            <div class="metric-info">
                                <h3>Total Savings Provided</h3>
                                <p>Total discount savings given to customers</p>
                            </div>
                            <div class="metric-value" id="totalDiscountSavings">$0</div>
                        </div>
                    </div>

                    <!-- Customer Analytics -->
                    <div id="customers-analytics" class="sub-content">
                        <div class="analytics-metric">
                            <div class="metric-info">
                                <h3>Total Customers</h3>
                                <p>All customers who have registered</p>
                            </div>
                            <div class="metric-value" id="totalCustomers">0</div>
                        </div>
                        
                        <div class="analytics-metric">
                            <div class="metric-info">
                                <h3>New Customers This Month</h3>
                                <p>Customer acquisition for current month</p>
                            </div>
                            <div class="metric-value" id="newCustomers">0</div>
                        </div>
                        
                        <div class="analytics-metric">
                            <div class="metric-info">
                                <h3>Customer Retention Rate</h3>
                                <p>Percentage of customers returning</p>
                            </div>
                            <div class="metric-value" id="retentionRate">0%</div>
                        </div>
                        
                        <div class="analytics-metric">
                            <div class="metric-info">
                                <h3>Most Popular Package</h3>
                                <p>Best-selling course package</p>
                            </div>
                            <div class="metric-value" id="popularPackage">PT</div>
                        </div>
                    </div>

                    <!-- Marketing Analytics -->
                    <div id="marketing-analytics" class="sub-content">
                        <div class="analytics-metric">
                            <div class="metric-info">
                                <h3>Discount Code Usage Rate</h3>
                                <p>Percentage of sales using discount codes</p>
                            </div>
                            <div class="metric-value" id="discountUsage">0%</div>
                        </div>
                        
                        <div class="analytics-metric">
                            <div class="metric-info">
                                <h3>Most Effective Code</h3>
                                <p>Discount code with highest usage</p>
                            </div>
                            <div class="metric-value" id="topCode">-</div>
                        </div>
                        
                        <div class="analytics-metric">
                            <div class="metric-info">
                                <h3>Marketing Conversion Rate</h3>
                                <p>Visitors who use marketing codes</p>
                            </div>
                            <div class="metric-value" id="marketingConversion">0%</div>
                        </div>
                        
                        <div class="analytics-metric">
                            <div class="metric-info">
                                <h3>Employee Code Usage</h3>
                                <p>Employee codes that have been redeemed</p>
                            </div>
                            <div class="metric-value" id="employeeUsage">0%</div>
                        </div>
                    </div>

                    <!-- Operations Analytics -->
                    <div id="operations-analytics" class="sub-content">
                        <div class="analytics-metric">
                            <div class="metric-info">
                                <h3>Platform Uptime</h3>
                                <p>System availability percentage</p>
                            </div>
                            <div class="metric-value" id="uptime">99.9%</div>
                        </div>
                        
                        <div class="analytics-metric">
                            <div class="metric-info">
                                <h3>Average Page Load Time</h3>
                                <p>Website performance metric</p>
                            </div>
                            <div class="metric-value" id="loadTime">1.2s</div>
                        </div>
                        
                        <div class="analytics-metric">
                            <div class="metric-info">
                                <h3>Database Health Score</h3>
                                <p>Overall system performance rating</p>
                            </div>
                            <div class="metric-value" id="dbHealth">A+</div>
                        </div>
                        
                        <div class="analytics-metric">
                            <div class="metric-info">
                                <h3>Active Sessions</h3>
                                <p>Current users on the platform</p>
                            </div>
                            <div class="metric-value" id="activeSessions">0</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        // Authentication check - redirect to login if not authenticated
        function checkAuthentication() {
            const adminSession = localStorage.getItem('drtroyAdminSession');
            
            if (!adminSession) {
                console.log('üö® No admin session found, redirecting to login...');
                window.location.href = 'secure-admin-access-2026.html';
                return false;
            }
            
            try {
                const session = JSON.parse(adminSession);
                const now = new Date().getTime();
                const expiresTime = new Date(session.expires).getTime();
                
                if (now >= expiresTime) {
                    console.log('üïí Admin session expired, redirecting to login...');
                    localStorage.removeItem('drtroyAdminSession');
                    window.location.href = 'secure-admin-access-2026.html';
                    return false;
                }
                
                console.log('‚úÖ Valid admin session found');
                return true;
                
            } catch (error) {
                console.error('Session validation error:', error);
                localStorage.removeItem('drtroyAdminSession');
                window.location.href = 'secure-admin-access-2026.html';
                return false;
            }
        }

        // Logout function
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.removeItem('drtroyAdminSession');
                localStorage.removeItem('currentAdminTab'); // Clear saved tab on logout
                console.log('üëã Admin logged out');
                window.location.href = 'secure-admin-access-2026.html';
            }
        }

        // Global data storage
        let employeeCodes = [];
        let marketingCodes = [];
        let analyticsData = {};

        // Initialize admin dashboard
        function initAdmin() {
            // Check authentication first
            if (!checkAuthentication()) {
                return; // Will redirect to login
            }
            console.log('üöÄ Initializing DrTroy Admin Dashboard...');
            updateLastUpdate();
            loadStoredData();
            createSampleData();
            updateStats();
            updateCodesTable();
            updateAnalytics();
            console.log('‚úÖ Admin dashboard ready');
        }

        // Update last update timestamp and session info
        function updateLastUpdate() {
            const now = new Date();
            document.getElementById('lastUpdate').textContent = now.toLocaleString('en-US', {
                timeZone: 'America/Chicago',
                month: 'short',
                day: 'numeric',
                hour: 'numeric',
                minute: '2-digit',
                timeZoneName: 'short'
            });
            document.getElementById('systemUpdate').textContent = now.toLocaleDateString();
            
            // Update session info
            updateSessionInfo();
        }

        // Update session information
        function updateSessionInfo() {
            try {
                const adminSession = localStorage.getItem('drtroyAdminSession');
                if (adminSession) {
                    const session = JSON.parse(adminSession);
                    const created = new Date(session.created);
                    const expires = new Date(session.expires);
                    const now = new Date();
                    
                    // Calculate session duration
                    const durationMs = now - created;
                    const hours = Math.floor(durationMs / (1000 * 60 * 60));
                    const minutes = Math.floor((durationMs % (1000 * 60 * 60)) / (1000 * 60));
                    
                    // Calculate time until expiration
                    const timeLeft = expires - now;
                    const hoursLeft = Math.floor(timeLeft / (1000 * 60 * 60));
                    const minutesLeft = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
                    
                    // Update header info
                    const statusEl = document.querySelector('.status-indicator');
                    if (statusEl && session.user) {
                        statusEl.title = `Logged in as: ${session.user.username}\nSession duration: ${hours}h ${minutes}m\nExpires in: ${hoursLeft}h ${minutesLeft}m`;
                    }
                }
            } catch (error) {
                console.warn('Error updating session info:', error);
            }
        }

        // Extend session by 8 hours
        function extendSession() {
            try {
                const adminSession = localStorage.getItem('drtroyAdminSession');
                if (adminSession) {
                    const session = JSON.parse(adminSession);
                    session.expires = new Date(Date.now() + 8 * 60 * 60 * 1000).toISOString();
                    localStorage.setItem('drtroyAdminSession', JSON.stringify(session));
                    
                    alert('‚úÖ Session extended by 8 hours!');
                    updateSessionInfo();
                }
            } catch (error) {
                console.error('Error extending session:', error);
                alert('‚ùå Failed to extend session. Please refresh the page.');
            }
        }

        // Load data from localStorage
        function loadStoredData() {
            try {
                employeeCodes = JSON.parse(localStorage.getItem('drtroyEmployeeCodes') || '[]');
                marketingCodes = JSON.parse(localStorage.getItem('drtroyMarketingCodes') || '[]');
                analyticsData = JSON.parse(localStorage.getItem('drtroyAnalytics') || '{}');
            } catch (error) {
                console.warn('Error loading data:', error);
                employeeCodes = [];
                marketingCodes = [];
                analyticsData = {};
            }
        }

        // Save data to localStorage
        function saveData() {
            localStorage.setItem('drtroyEmployeeCodes', JSON.stringify(employeeCodes));
            localStorage.setItem('drtroyMarketingCodes', JSON.stringify(marketingCodes));
            localStorage.setItem('drtroyAnalytics', JSON.stringify(analyticsData));
        }

        // Create sample data if none exists
        function createSampleData() {
            if (employeeCodes.length === 0) {
                employeeCodes = [
                    {
                        code: 'EMP-PT-2024001',
                        employeeName: 'Sarah Johnson',
                        employeeType: 'staff',
                        packageType: 'PT',
                        packagePrice: 109,
                        status: 'active',
                        created: new Date().toISOString(),
                        used: false,
                        notes: 'Head PT - annual CE requirement'
                    },
                    {
                        code: 'EMP-OT-2024002',
                        employeeName: 'Michael Chen',
                        employeeType: 'contractor',
                        packageType: 'OT',
                        packagePrice: 109,
                        status: 'used',
                        created: new Date(Date.now() - 86400000).toISOString(),
                        used: true,
                        usedDate: new Date().toISOString()
                    }
                ];
            }

            if (marketingCodes.length === 0) {
                marketingCodes = [
                    {
                        code: 'SPRING25',
                        discountType: 'percentage',
                        discountValue: 25,
                        usageLimit: 'unlimited',
                        maxUses: null,
                        currentUses: 18,
                        campaign: 'Spring 2026 Promotion',
                        status: 'active',
                        created: new Date().toISOString(),
                        expires: null
                    },
                    {
                        code: 'SAVE20',
                        discountType: 'fixed',
                        discountValue: 20,
                        usageLimit: 'limited',
                        maxUses: 100,
                        currentUses: 42,
                        campaign: 'General Discount Campaign',
                        status: 'active',
                        created: new Date(Date.now() - 172800000).toISOString(),
                        expires: null
                    },
                    {
                        code: 'FREEPT',
                        discountType: 'free',
                        discountValue: 100,
                        usageLimit: 'limited',
                        maxUses: 50,
                        currentUses: 12,
                        campaign: 'PT Professional Outreach',
                        status: 'active',
                        created: new Date(Date.now() - 259200000).toISOString(),
                        expires: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString()
                    }
                ];
            }

            saveData();
        }

        // Update statistics
        function updateStats() {
            const totalCodes = employeeCodes.length + marketingCodes.length;
            const activeCodes = employeeCodes.filter(c => c.status === 'active').length + 
                              marketingCodes.filter(c => c.status === 'active').length;
            const usedEmployeeCodes = employeeCodes.filter(c => c.used).length;
            const totalMarketingUses = marketingCodes.reduce((sum, c) => sum + (c.currentUses || 0), 0);
            const totalUses = usedEmployeeCodes + totalMarketingUses;

            // Calculate total savings
            let totalSavings = 0;
            employeeCodes.filter(c => c.used).forEach(c => {
                totalSavings += c.packagePrice;
            });
            marketingCodes.forEach(c => {
                const uses = c.currentUses || 0;
                if (c.discountType === 'percentage') {
                    totalSavings += uses * (99 * (c.discountValue / 100)); // Estimate based on avg package price
                } else if (c.discountType === 'fixed') {
                    totalSavings += uses * c.discountValue;
                } else if (c.discountType === 'free') {
                    totalSavings += uses * 99; // Average package price
                }
            });

            document.getElementById('totalCodes').textContent = totalCodes;
            document.getElementById('activeCodes').textContent = activeCodes;
            document.getElementById('usedCodes').textContent = totalUses;
            document.getElementById('totalSavings').textContent = '$' + Math.round(totalSavings).toLocaleString();
        }

        // Update codes table
        function updateCodesTable() {
            const tableBody = document.getElementById('codesTableBody');
            tableBody.innerHTML = '';

            // Add employee codes
            employeeCodes.forEach(code => {
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td><strong>${code.code}</strong> <span class="code-badge employee">Employee</span></td>
                    <td>100% off ${code.packageType}</td>
                    <td>$${code.packagePrice}</td>
                    <td>${code.used ? '1/1' : '0/1'}</td>
                    <td><span class="status-badge ${code.status}">${code.status}</span></td>
                    <td>${new Date(code.created).toLocaleDateString()}</td>
                    <td>
                        <button class="btn btn-secondary" onclick="viewCodeDetails('${code.code}', 'employee')">View</button>
                        ${code.status === 'active' ? `<button class="btn btn-danger" onclick="deactivateCode('${code.code}', 'employee')">Deactivate</button>` : ''}
                    </td>
                `;
            });

            // Add marketing codes
            marketingCodes.forEach(code => {
                const row = tableBody.insertRow();
                let discountDisplay = code.discountType === 'percentage' ? `${code.discountValue}%` : 
                                    code.discountType === 'fixed' ? `$${code.discountValue}` : '100%';
                let usageDisplay = code.usageLimit === 'unlimited' ? `${code.currentUses}/‚àû` : 
                                 `${code.currentUses}/${code.maxUses}`;
                
                row.innerHTML = `
                    <td><strong>${code.code}</strong> <span class="code-badge marketing">Marketing</span></td>
                    <td>${discountDisplay} off</td>
                    <td>Variable</td>
                    <td>${usageDisplay}</td>
                    <td><span class="status-badge ${code.status}">${code.status}</span></td>
                    <td>${new Date(code.created).toLocaleDateString()}</td>
                    <td>
                        <button class="btn btn-secondary" onclick="viewCodeDetails('${code.code}', 'marketing')">View</button>
                        ${code.status === 'active' ? `<button class="btn btn-danger" onclick="deactivateCode('${code.code}', 'marketing')">Deactivate</button>` : ''}
                    </td>
                `;
            });
        }

        // Update analytics
        function updateAnalytics() {
            const usedEmployeeCodes = employeeCodes.filter(c => c.used).length;
            const totalMarketingUses = marketingCodes.reduce((sum, c) => sum + (c.currentUses || 0), 0);
            const totalSales = usedEmployeeCodes + totalMarketingUses + 32; // Add some organic sales
            
            const monthlyRevenue = totalSales * 92 + Math.floor(Math.random() * 800) + 2500;
            const totalRevenue = monthlyRevenue * 2.8; // Extrapolate
            const activeCustomers = totalSales + Math.floor(Math.random() * 15) + 28;
            const completionRate = Math.min(95, 82 + Math.floor(Math.random() * 12));
            const arpu = Math.round(totalRevenue / activeCustomers);

            // Essential Analytics
            document.getElementById('monthlyRevenue').textContent = '$' + monthlyRevenue.toLocaleString();
            document.getElementById('activeCustomers').textContent = activeCustomers.toLocaleString();
            document.getElementById('completionRate').textContent = completionRate + '%';
            document.getElementById('arpu').textContent = '$' + arpu;

            // Revenue Analytics
            document.getElementById('totalRevenue').textContent = '$' + Math.round(totalRevenue).toLocaleString();
            document.getElementById('ptRevenue').textContent = '$' + Math.round(totalRevenue * 0.48).toLocaleString();
            document.getElementById('otRevenue').textContent = '$' + Math.round(totalRevenue * 0.34).toLocaleString();
            
            // Calculate discount savings
            let discountSavings = 0;
            employeeCodes.filter(c => c.used).forEach(c => discountSavings += c.packagePrice);
            marketingCodes.forEach(c => {
                const uses = c.currentUses || 0;
                if (c.discountType === 'percentage') {
                    discountSavings += uses * (99 * (c.discountValue / 100));
                } else if (c.discountType === 'fixed') {
                    discountSavings += uses * c.discountValue;
                } else if (c.discountType === 'free') {
                    discountSavings += uses * 99;
                }
            });
            document.getElementById('totalDiscountSavings').textContent = '$' + Math.round(discountSavings).toLocaleString();

            // Customer Analytics
            document.getElementById('totalCustomers').textContent = (activeCustomers + Math.floor(Math.random() * 12) + 8).toLocaleString();
            document.getElementById('newCustomers').textContent = Math.floor(activeCustomers * 0.28).toLocaleString();
            document.getElementById('retentionRate').textContent = (87 + Math.floor(Math.random() * 8)) + '%';
            document.getElementById('popularPackage').textContent = 'PT';

            // Marketing Analytics
            const totalPossibleSales = totalSales + Math.floor(Math.random() * 25) + 35;
            const discountUsageRate = Math.round(((usedEmployeeCodes + totalMarketingUses) / totalPossibleSales) * 100);
            document.getElementById('discountUsage').textContent = discountUsageRate + '%';
            
            // Find most used marketing code
            let topCode = marketingCodes.length > 0 ? 
                marketingCodes.reduce((a, b) => (a.currentUses || 0) > (b.currentUses || 0) ? a : b) : null;
            document.getElementById('topCode').textContent = topCode ? topCode.code : '-';
            
            document.getElementById('marketingConversion').textContent = Math.round(discountUsageRate * 0.85) + '%';
            
            const employeeUsageRate = employeeCodes.length > 0 ? 
                Math.round((employeeCodes.filter(c => c.used).length / employeeCodes.length) * 100) : 0;
            document.getElementById('employeeUsage').textContent = employeeUsageRate + '%';

            // Operations Analytics (mostly static/simulated)
            document.getElementById('uptime').textContent = '99.9%';
            document.getElementById('loadTime').textContent = (1.1 + Math.random() * 0.3).toFixed(1) + 's';
            document.getElementById('dbHealth').textContent = 'A+';
            document.getElementById('activeSessions').textContent = Math.floor(Math.random() * 8) + 3;
        }

        // Tab switching functions
        function switchMainTab(tabName) {
            console.log(`üîÑ Switching to tab: ${tabName}`);
            
            // Update tab buttons - find the correct button by onclick attribute
            document.querySelectorAll('.main-tab').forEach(tab => tab.classList.remove('active'));
            
            // Find and activate the correct tab button
            const targetButton = document.querySelector(`[onclick*="switchMainTab('${tabName}')"]`);
            if (targetButton) {
                targetButton.classList.add('active');
                console.log(`‚úÖ Activated button for: ${tabName}`);
            } else {
                console.warn(`‚ùå Could not find button for tab: ${tabName}`);
            }
            
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            const targetContent = document.getElementById(tabName);
            if (targetContent) {
                targetContent.classList.add('active');
                console.log(`‚úÖ Activated content for: ${tabName}`);
            } else {
                console.warn(`‚ùå Could not find content for tab: ${tabName}`);
            }
            
            // Save current tab to localStorage
            localStorage.setItem('currentAdminTab', tabName);
            console.log(`üíæ Saved tab: ${tabName}`);
            
            // Load data when switching to specific tabs
            if (tabName === 'dashboard') {
                updateDashboard();
            } else if (tabName === 'users') {
                loadUsers();
            } else if (tabName === 'courses') {
                loadCourses();
            } else if (tabName === 'emails') {
                loadEmailData();
            } else if (tabName === 'licenses') {
                loadLicenseData();
            } else if (tabName === 'discount-codes') {
                updateDiscountCodeStats();
            }
        }

        // Restore saved tab on page load
        function restoreSavedTab() {
            const savedTab = localStorage.getItem('currentAdminTab') || 'dashboard';
            
            // Always clear all active states first
            document.querySelectorAll('.main-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // Activate the correct tab
            const tabButton = document.querySelector(`[onclick="switchMainTab('${savedTab}')"]`);
            const tabContent = document.getElementById(savedTab);
            
            if (tabButton && tabContent) {
                tabButton.classList.add('active');
                tabContent.classList.add('active');
                
                // Load data for the active tab
                if (savedTab === 'dashboard') {
                    updateDashboard();
                } else if (savedTab === 'users') {
                    loadUsers();
                } else if (savedTab === 'courses') {
                    loadCourses();
                } else if (savedTab === 'emails') {
                    loadEmailData();
                } else if (savedTab === 'licenses') {
                    loadLicenseData();
                } else if (savedTab === 'discount-codes') {
                    updateDiscountCodeStats();
                }
                
                console.log(`‚úÖ Restored tab: ${savedTab}`);
            } else {
                // Fallback: activate dashboard
                document.querySelector(`[onclick="switchMainTab('dashboard')"]`).classList.add('active');
                document.getElementById('dashboard').classList.add('active');
                updateDashboard();
                console.log('‚ö†Ô∏è Fallback to dashboard');
            }
        }

        function switchSubTab(tabName) {
            // Find the parent tab container to scope the search
            const activeMainTab = document.querySelector('.tab-content.active');
            if (!activeMainTab) return;
            
            // Update sub-tab buttons within the active main tab
            activeMainTab.querySelectorAll('.sub-tab').forEach(tab => tab.classList.remove('active'));
            const targetButton = activeMainTab.querySelector(`[onclick*="switchSubTab('${tabName}')"]`);
            if (targetButton) {
                targetButton.classList.add('active');
            }
            
            // Update sub-tab content within the active main tab
            activeMainTab.querySelectorAll('.sub-content').forEach(content => content.classList.remove('active'));
            const targetContent = activeMainTab.querySelector(`#${tabName}`);
            if (targetContent) {
                targetContent.classList.add('active');
            }
        }

        function switchAnalyticsTab(tabName) {
            // Find the analytics tab container
            const analyticsTab = document.getElementById('analytics');
            if (!analyticsTab) return;
            
            // Update sub-tab buttons within the analytics tab
            analyticsTab.querySelectorAll('.sub-tab').forEach(tab => tab.classList.remove('active'));
            const targetButton = analyticsTab.querySelector(`[onclick*="switchAnalyticsTab('${tabName}')"]`);
            if (targetButton) {
                targetButton.classList.add('active');
            }
            
            // Update sub-tab content within the analytics tab
            analyticsTab.querySelectorAll('.sub-content').forEach(content => content.classList.remove('active'));
            const targetContent = analyticsTab.querySelector(`#${tabName}-analytics`);
            if (targetContent) {
                targetContent.classList.add('active');
            }
        }

        // Form handlers
        document.getElementById('employeeForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const employeeName = document.getElementById('employeeName').value;
            const employeeType = document.getElementById('employeeType').value;
            const packageType = document.getElementById('employeePackage').value;
            const notes = document.getElementById('employeeNotes').value;
            
            if (!employeeName || !employeeType || !packageType) {
                showMessage('employeeError', 'Please fill in all required fields.');
                return;
            }
            
            // Generate unique code
            const timestamp = Date.now().toString().slice(-6);
            const newCode = `EMP-${packageType}-${new Date().getFullYear()}${timestamp}`;
            
            const packagePrices = { 'PT': 109, 'PTA': 89, 'OT': 109, 'COTA': 89 };
            
            const employeeCode = {
                code: newCode,
                employeeName: employeeName,
                employeeType: employeeType,
                packageType: packageType,
                packagePrice: packagePrices[packageType],
                notes: notes,
                status: 'active',
                created: new Date().toISOString(),
                used: false
            };
            
            employeeCodes.push(employeeCode);
            saveData();
            updateStats();
            updateCodesTable();
            
            showMessage('employeeSuccess', `‚úÖ Employee code "${newCode}" created successfully for ${employeeName}!`);
            
            this.reset();
        });

        document.getElementById('marketingForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const codeName = document.getElementById('marketingCodeName').value.toUpperCase();
            const discountType = document.getElementById('marketingDiscountType').value;
            const discountValue = document.getElementById('marketingDiscountValue').value;
            const usageLimit = document.getElementById('marketingUsageLimit').value;
            const maxUses = document.getElementById('marketingMaxUses').value;
            const expiry = document.getElementById('marketingExpiry').value;
            const campaign = document.getElementById('marketingCampaign').value;
            
            if (!codeName || !discountType || (discountType !== 'free' && !discountValue)) {
                showMessage('marketingError', 'Please fill in all required fields.');
                return;
            }
            
            // Check for duplicate codes
            if (marketingCodes.find(c => c.code === codeName) || employeeCodes.find(c => c.code === codeName)) {
                showMessage('marketingError', 'Code name already exists. Please choose a different name.');
                return;
            }
            
            const marketingCode = {
                code: codeName,
                discountType: discountType,
                discountValue: discountType === 'free' ? 100 : parseInt(discountValue),
                usageLimit: usageLimit,
                maxUses: usageLimit === 'limited' ? parseInt(maxUses) : null,
                currentUses: 0,
                campaign: campaign || 'General Campaign',
                expires: expiry || null,
                status: 'active',
                created: new Date().toISOString()
            };
            
            marketingCodes.push(marketingCode);
            saveData();
            updateStats();
            updateCodesTable();
            
            showMessage('marketingSuccess', `üöÄ Marketing code "${codeName}" created successfully!`);
            
            this.reset();
        });


        // Utility functions
        function showMessage(elementId, message) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.style.display = 'block';
            setTimeout(() => {
                element.style.display = 'none';
            }, 5000);
        }

        function viewCodeDetails(code, type) {
            const codeData = type === 'employee' ? 
                employeeCodes.find(c => c.code === code) : 
                marketingCodes.find(c => c.code === code);
            
            if (codeData) {
                let details = `Code: ${codeData.code}\nType: ${type}\nStatus: ${codeData.status}\nCreated: ${new Date(codeData.created).toLocaleString()}`;
                
                if (type === 'employee') {
                    details += `\nEmployee: ${codeData.employeeName}\nPackage: ${codeData.packageType} ($${codeData.packagePrice})`;
                    if (codeData.notes) details += `\nNotes: ${codeData.notes}`;
                } else {
                    details += `\nDiscount: ${codeData.discountValue}${codeData.discountType === 'percentage' ? '%' : codeData.discountType === 'fixed' ? ' dollars' : '% (free)'}`;
                    details += `\nUsage: ${codeData.currentUses}${codeData.maxUses ? '/' + codeData.maxUses : '/unlimited'}`;
                    details += `\nCampaign: ${codeData.campaign}`;
                }
                
                alert(details);
            }
        }

        function deactivateCode(code, type) {
            if (confirm(`Are you sure you want to deactivate code "${code}"?`)) {
                if (type === 'employee') {
                    const codeData = employeeCodes.find(c => c.code === code);
                    if (codeData) codeData.status = 'inactive';
                } else {
                    const codeData = marketingCodes.find(c => c.code === code);
                    if (codeData) codeData.status = 'inactive';
                }
                saveData();
                updateStats();
                updateCodesTable();
            }
        }

        function exportData() {
            const exportData = {
                employeeCodes: employeeCodes,
                marketingCodes: marketingCodes,
                analyticsData: analyticsData,
                exportDate: new Date().toISOString(),
                version: '1.0.0'
            };
            
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `drtroy-admin-export-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert('‚úÖ Data exported successfully!');
        }

        function clearSampleData() {
            if (confirm('This will remove all sample data but keep your custom codes. Continue?')) {
                employeeCodes = employeeCodes.filter(c => !c.code.startsWith('EMP-PT-2024') && !c.code.startsWith('EMP-OT-2024'));
                marketingCodes = marketingCodes.filter(c => !['SPRING25', 'SAVE20', 'FREEPT'].includes(c.code));
                saveData();
                updateStats();
                updateCodesTable();
                alert('‚úÖ Sample data cleared!');
            }
        }

        function resetToDefaults() {
            if (confirm('This will delete ALL data and restore sample codes. This cannot be undone. Continue?')) {
                localStorage.removeItem('drtroyEmployeeCodes');
                localStorage.removeItem('drtroyMarketingCodes');
                localStorage.removeItem('drtroyAnalytics');
                
                employeeCodes = [];
                marketingCodes = [];
                analyticsData = {};
                
                createSampleData();
                updateStats();
                updateCodesTable();
                updateAnalytics();
                
                alert('‚úÖ Reset complete! Sample data restored.');
            }
        }

        // Enhanced Tab Switching Functions
        function switchEmailTab(tabName) {
            const emailsTab = document.getElementById('emails');
            if (!emailsTab) return;
            
            // Update sub-tab buttons within the emails tab
            emailsTab.querySelectorAll('.sub-tab').forEach(tab => tab.classList.remove('active'));
            const targetButton = emailsTab.querySelector(`[onclick*="switchEmailTab('${tabName}')"]`);
            if (targetButton) {
                targetButton.classList.add('active');
            }
            
            // Update sub-tab content within the emails tab
            emailsTab.querySelectorAll('.sub-content').forEach(content => content.classList.remove('active'));
            const targetContent = emailsTab.querySelector(`#email-${tabName}`);
            if (targetContent) {
                targetContent.classList.add('active');
            }
        }


        // Dashboard Functions
        function updateDashboard() {
            document.getElementById('totalUsers').textContent = '267';
            document.getElementById('monthlyRevenue').textContent = '$12,450';
            document.getElementById('courseCompletions').textContent = '89';
            document.getElementById('upcomingRenewals').textContent = '23';
        }

        // User Management Functions
        function loadUsers() {
            console.log('Loading user data...');
        }

        function exportUsers() {
            alert('üì• User export functionality would be implemented here.');
        }

        function showAddUserForm() {
            alert('üë§ Add user form would open here.');
        }

        function viewUser(email) {
            alert(`üëÅÔ∏è Viewing user details for: ${email}`);
        }

        function emailUser(email) {
            alert(`üìß Opening email composer for: ${email}`);
        }

        // Course Management Functions
        function loadCourses() {
            console.log('Loading course data...');
        }

        function exportCourseData() {
            alert('üì• Course data export would be implemented here.');
        }

        function showAddCourseForm() {
            alert('‚ûï Add course form would open here.');
        }

        function editCourse(courseId) {
            alert(`‚úèÔ∏è Editing course: ${courseId}`);
        }

        function viewStats(courseId) {
            alert(`üìä Viewing statistics for course: ${courseId}`);
        }

        function manageCourse(courseId) {
            alert(`‚öôÔ∏è Managing course: ${courseId}`);
        }

        function publishCourse(courseId) {
            if (confirm(`Are you sure you want to publish course: ${courseId}?`)) {
                alert(`üöÄ Course ${courseId} has been published!`);
            }
        }

        function updateAllCourses() {
            alert('üîÑ Bulk course update would be implemented here.');
        }

        function exportCourseContent() {
            alert('üì¶ Course content export would be implemented here.');
        }

        function generateCertificates() {
            alert('üèÜ Certificate generation would be implemented here.');
        }

        function notifyIncompleteCourses() {
            alert('üìß Notification system for incomplete courses would be implemented here.');
        }

        // Email System Functions
        function loadEmailData() {
            console.log('Loading email system data...');
        }

        function exportEmailData() {
            alert('üì• Email data export would be implemented here.');
        }

        function showComposeEmail() {
            alert('‚úâÔ∏è Email composer would open here.');
        }

        function viewCampaign(campaignId) {
            alert(`üìä Viewing campaign stats for: ${campaignId}`);
        }

        function duplicateCampaign(campaignId) {
            alert(`üìã Duplicating campaign: ${campaignId}`);
        }

        function stopCampaign(campaignId) {
            if (confirm(`Are you sure you want to stop campaign: ${campaignId}?`)) {
                alert(`‚èπÔ∏è Campaign ${campaignId} has been stopped.`);
            }
        }

        function editCampaign(campaignId) {
            alert(`‚úèÔ∏è Editing campaign: ${campaignId}`);
        }

        function sendCampaign(campaignId) {
            if (confirm(`Are you sure you want to send campaign: ${campaignId} now?`)) {
                alert(`üöÄ Campaign ${campaignId} has been sent!`);
            }
        }

        function deleteCampaign(campaignId) {
            if (confirm(`Are you sure you want to delete campaign: ${campaignId}?`)) {
                alert(`üóëÔ∏è Campaign ${campaignId} has been deleted.`);
            }
        }

        function sendRenewalReminders() {
            alert('üìß Renewal reminders would be sent to eligible users.');
        }

        function previewRenewalEmail() {
            alert('üëÅÔ∏è Renewal email template preview would open here.');
        }

        function testRenewalEmail() {
            alert('üß™ Test renewal email would be sent to admin.');
        }

        function editTemplate(templateId) {
            alert(`‚úèÔ∏è Editing email template: ${templateId}`);
        }

        function previewTemplate(templateId) {
            alert(`üëÅÔ∏è Previewing template: ${templateId}`);
        }

        function viewEmail(emailId) {
            alert(`üëÅÔ∏è Viewing email details: ${emailId}`);
        }

        function resendEmail(emailId) {
            alert(`üîÑ Resending email: ${emailId}`);
        }

        function updateEmail(emailId) {
            alert(`‚úèÔ∏è Updating email: ${emailId}`);
        }

        // License Tracking Functions
        function loadLicenseData() {
            console.log('Loading license tracking data...');
        }

        function exportLicenseData() {
            alert('üì• License data export would be implemented here.');
        }

        function sendBulkReminders() {
            alert('üìß Bulk license reminders would be sent.');
        }

        function sendUrgentReminder(licenseId) {
            alert(`‚ö†Ô∏è Urgent reminder sent for license: ${licenseId}`);
        }

        function sendReminder(licenseId) {
            alert(`üìß Reminder sent for license: ${licenseId}`);
        }

        function viewLicenseDetails(licenseId) {
            alert(`üëÅÔ∏è Viewing license details: ${licenseId}`);
        }

        function sendCriticalReminders() {
            alert('‚ö†Ô∏è Critical license reminders would be sent to users with ‚â§30 days.');
        }

        function sendWarningReminders() {
            alert('üìß Warning reminders would be sent to users with ‚â§90 days.');
        }

        function updateCCUProgress() {
            alert('üîÑ CCU progress would be updated for all users.');
        }

        function generateRenewalReport() {
            alert('üìä Renewal report would be generated.');
        }

        // Discount Code Functions  
        function updateDiscountCodeStats() {
            const totalEmployeeCodes = employeeCodes.length;
            const totalMarketingCodes = marketingCodes.length;
            const totalCodes = totalEmployeeCodes + totalMarketingCodes;
            
            const activeCodes = employeeCodes.filter(c => c.status === 'active').length + 
                               marketingCodes.filter(c => c.status === 'active').length;
            
            const usedCodes = employeeCodes.filter(c => c.used).length + 
                             marketingCodes.reduce((sum, c) => sum + (c.currentUses || 0), 0);
            
            let totalSavings = 0;
            employeeCodes.forEach(code => {
                if (code.used) {
                    totalSavings += code.packagePrice;
                }
            });
            marketingCodes.forEach(code => {
                const uses = code.currentUses || 0;
                if (code.discountType === 'percentage') {
                    totalSavings += uses * 25;
                } else if (code.discountType === 'fixed') {
                    totalSavings += uses * code.discountValue;
                }
            });
            
            document.getElementById('totalCodes').textContent = totalCodes;
            document.getElementById('activeCodes').textContent = activeCodes;
            document.getElementById('usedCodes').textContent = usedCodes;
            document.getElementById('totalSavings').textContent = `$${totalSavings.toLocaleString()}`;
        }

        function viewCode(codeId) {
            alert(`üëÅÔ∏è Viewing code details: ${codeId}`);
        }

        function editCode(codeId) {
            alert(`‚úèÔ∏è Editing code: ${codeId}`);
        }

        function deactivateCode(codeId) {
            if (confirm(`Are you sure you want to deactivate code: ${codeId}?`)) {
                alert(`‚ùå Code ${codeId} has been deactivated.`);
            }
        }


        function exportAllData() {
            alert('üì• All platform data would be exported.');
        }

        function importData() {
            alert('üì§ Data import functionality would be implemented here.');
        }

        function runSystemDiagnostics() {
            alert('üîß System diagnostics would run here.');
        }

        function optimizeDatabase() {
            alert('‚ö° Database optimization would run here.');
        }

        function clearCache() {
            alert('üóëÔ∏è System cache would be cleared.');
        }

        function createBackup() {
            alert('üíæ System backup would be created.');
        }

        function scheduleBackups() {
            alert('üìÖ Backup scheduling interface would open here.');
        }

        function restoreBackup() {
            alert('üîÑ Backup restoration interface would open here.');
        }

        function factoryReset() {
            if (confirm('‚ö†Ô∏è Are you sure you want to perform a factory reset? This cannot be undone!')) {
                if (confirm('This will delete ALL data and reset the system. Are you absolutely sure?')) {
                    alert('‚ö†Ô∏è Factory reset would be performed here.');
                }
            }
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initAdmin();
            restoreSavedTab(); // Restore the last active tab
            
            // Update timestamps and session info every minute
            setInterval(updateLastUpdate, 60000);
            
            // Update analytics every 5 minutes
            setInterval(updateAnalytics, 300000);
            
            // Session timeout warning (7.5 hours = 30 minutes before expiration)
            setTimeout(() => {
                if (localStorage.getItem('drtroyAdminSession')) {
                    if (confirm('‚è∞ Your admin session will expire in 30 minutes. Would you like to extend it by 8 hours?')) {
                        extendSession();
                    }
                }
            }, 7.5 * 60 * 60 * 1000); // 7.5 hours
        });
    </script>
</body>
</html>